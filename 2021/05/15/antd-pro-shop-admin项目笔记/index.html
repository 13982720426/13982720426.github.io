

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="jackhoo">
  <meta name="keywords" content="">
  
  <title>antd_pro_shop_admin项目笔记 - jackhoo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/%E6%AC%A2%E8%BF%8E%E5%A4%A7%E5%AE%B6%E6%9D%A5%E5%88%B0%E6%88%91%E7%9A%84%E5%8D%9A%E5%AE%A2%EF%BC%8C%E8%AF%B7%E5%B0%BD%E6%83%85%E7%95%99%E8%A8%80%E5%90%A7%EF%BC%81/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.6.0/styles/hybrid.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"13982720426.github.io","root":"/","version":"1.8.10","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"wvn0ubBMNgOQNv8Swlonq3X9-gzGzoHsz","app_key":"BlsdS19vhoVr77n1TiE2diHr","server_url":"https://wvn0ubbm.lc-cn-n1-shared.com"}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>jackhoo的博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" target="_blank" rel="noopener" href="https://github.com/13982720426/">
                <i class="iconfont icon-github-fill"></i>
                GitHub
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/bg2.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="antd_pro_shop_admin项目笔记">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      jackhoo
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-05-15 11:38" pubdate>
        星期六, 五月 15日 2021, 11:38 中午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      28.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      437
       分钟
    </span>
  

  
  
    
      <!-- LeanCloud 统计文章PV -->
      <span id="leancloud-page-views-container" class="post-meta" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="leancloud-page-views"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">antd_pro_shop_admin项目笔记</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：10 个月前
                
              </p>
            
            <div class="markdown-body">
              <h1 id="一、项目搭建"><a href="#一、项目搭建" class="headerlink" title="一、项目搭建"></a>一、项目搭建</h1><h2 id="1-1-安装脚手架"><a href="#1-1-安装脚手架" class="headerlink" title="1.1 安装脚手架"></a>1.1 安装脚手架</h2><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">yarn create umi<br></code></pre></div></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1620995323162-68a0b083-ece6-4b2b-8b0d-36daa8098291.png#clientId=u4de613e7-ed76-4&from=paste&height=263&id=u3ea1dff9&margin=%5Bobject%20Object%5D&name=image.png&originHeight=263&originWidth=565&originalType=binary&size=24386&status=done&style=none&taskId=u97744768-50fe-4132-8afa-89f689a6231&width=565" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="1-2-选择版本"><a href="#1-2-选择版本" class="headerlink" title="1.2 选择版本"></a>1.2 选择版本</h2><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1620995413718-5bc82348-871a-4de9-b66f-f3ab981a1498.png#clientId=u4de613e7-ed76-4&from=paste&height=309&id=u4b5f0a9a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=309&originWidth=558&originalType=binary&size=31989&status=done&style=none&taskId=uc07da9f4-9a9d-4fcb-8c84-6142c7b5aad&width=558" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="1-3-安装依赖"><a href="#1-3-安装依赖" class="headerlink" title="1.3 安装依赖"></a>1.3 安装依赖</h2><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">yarn<br></code></pre></div></td></tr></table></figure>

<h2 id="1-4-启动项目"><a href="#1-4-启动项目" class="headerlink" title="1.4 启动项目"></a>1.4 启动项目</h2><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">npm start<br></code></pre></div></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1620998686519-b310d168-8f77-4f4f-a430-5930dc03d3a7.png#clientId=u4de613e7-ed76-4&from=paste&height=272&id=u81cb4066&margin=%5Bobject%20Object%5D&name=image.png&originHeight=272&originWidth=630&originalType=binary&size=21916&status=done&style=none&taskId=u1d860442-c951-4c0e-a38f-f299987a587&width=630" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="1-5-点击链接进入浏览器"><a href="#1-5-点击链接进入浏览器" class="headerlink" title="1.5 点击链接进入浏览器"></a>1.5 点击链接进入浏览器</h2><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1620998751638-14b8d4f9-4999-4960-b0d0-c44de6b60ede.png#clientId=u4de613e7-ed76-4&from=paste&height=978&id=udceab73e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=978&originWidth=1916&originalType=binary&size=110241&status=done&style=none&taskId=u4e2ee6a5-a808-41f2-b751-f333c11a6cd&width=1916" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="二、初始化项目"><a href="#二、初始化项目" class="headerlink" title="二、初始化项目"></a>二、初始化项目</h1><h2 id="项目接口文档"><a href="#项目接口文档" class="headerlink" title="项目接口文档"></a>项目接口文档</h2><p><a target="_blank" rel="noopener" href="https://www.showdoc.com.cn/1207745568269674?page_id=6094279351627422">https://www.showdoc.com.cn/1207745568269674?page_id=6094279351627422</a></p>
<h2 id="2-1-删掉多余的文件"><a href="#2-1-删掉多余的文件" class="headerlink" title="2.1 删掉多余的文件"></a>2.1 删掉多余的文件</h2><p><strong>在编译器中打开项目</strong><br>删掉\src\pages 中<code>TableList</code>文件夹，<code>Admin.jsx</code>、<code>Welcome.jsx</code>、<code>Welcome.less</code>文件<br>删掉\mock 中<code>listTableList.js</code>文件<br>删掉\config\routes.js 文件夹中，删掉对应不用的路由</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [<br>  &#123;<br>    path: <span class="hljs-string">&#x27;/&#x27;</span>,<br>    component: <span class="hljs-string">&#x27;../layouts/BlankLayout&#x27;</span>,<br>    routes: [<br>      &#123;<br>        path: <span class="hljs-string">&#x27;/user&#x27;</span>,<br>        component: <span class="hljs-string">&#x27;../layouts/UserLayout&#x27;</span>,<br>        routes: [<br>          &#123;<br>            name: <span class="hljs-string">&#x27;login&#x27;</span>,<br>            path: <span class="hljs-string">&#x27;/user/login&#x27;</span>,<br>            component: <span class="hljs-string">&#x27;./User/login&#x27;</span>,<br>          &#125;,<br>        ],<br>      &#125;,<br>      &#123;<br>        path: <span class="hljs-string">&#x27;/&#x27;</span>,<br>        component: <span class="hljs-string">&#x27;../layouts/SecurityLayout&#x27;</span>,<br>        routes: [<br>          &#123;<br>            path: <span class="hljs-string">&#x27;/&#x27;</span>,<br>            component: <span class="hljs-string">&#x27;../layouts/BasicLayout&#x27;</span>,<br>            routes: [<br>              &#123;<br>                path: <span class="hljs-string">&#x27;/&#x27;</span>,<br>              &#125;,<br>              &#123;<br>                component: <span class="hljs-string">&#x27;./404&#x27;</span>,<br>              &#125;,<br>            ],<br>          &#125;,<br>          &#123;<br>            component: <span class="hljs-string">&#x27;./404&#x27;</span>,<br>          &#125;,<br>        ],<br>      &#125;,<br>    ],<br>  &#125;,<br>  &#123;<br>    component: <span class="hljs-string">&#x27;./404&#x27;</span>,<br>  &#125;,<br>]<br></code></pre></div></td></tr></table></figure>

<h2 id="2-2-更改-Logo-和底部文字替换"><a href="#2-2-更改-Logo-和底部文字替换" class="headerlink" title="2.2 更改 Logo 和底部文字替换"></a>2.2 更改 Logo 和底部文字替换</h2><p>在\src\layouts\BasicLayout.jsx 文件中找到<code>defaultFooterDom</code>更改默认文字，将<code>links=&#123;null&#125;</code>设置为空，不能删掉<code>links=&#123;&#125;</code>否则会编程默认的样子</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> defaultFooterDom = (<br>  &lt;DefaultFooter copyright=&#123;<span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getFullYear()&#125;</span> 融职商城`</span>&#125; links=&#123;<span class="hljs-literal">null</span>&#125; /&gt;<br>)<br></code></pre></div></td></tr></table></figure>

<p>底部文字就更改好了<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1621001473729-5a1cd8ff-7b29-4801-9053-bc651b9499a0.png#clientId=u4de613e7-ed76-4&from=paste&height=207&id=ude7af6a7&margin=%5Bobject%20Object%5D&name=image.png&originHeight=207&originWidth=1915&originalType=binary&size=11957&status=done&style=none&taskId=u84b1c93c-25f7-437f-b3f1-823df51c5d8&width=1915" srcset="/img/loading.gif" lazyload alt="image.png"><br>在\Econfig\defaultSettings.js 中更改<code>title</code>，这里的<code>title</code>是更改的网页标题和左上角文字<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1621001434658-83fbb50f-5b07-405c-942d-413ee87ef3bc.png#clientId=u4de613e7-ed76-4&from=paste&height=248&id=uc379e464&margin=%5Bobject%20Object%5D&name=image.png&originHeight=248&originWidth=316&originalType=binary&size=16228&status=done&style=none&taskId=uc8c8a1c8-d9e2-45a0-ade1-e3e12e0b7de&width=316" srcset="/img/loading.gif" lazyload alt="image.png"><br>在\src\assets 文件夹中提换掉 logo，并在用到的地方重新导入 logo 文件，否则会报错</p>
<h2 id="2-3-更改刷新时的-logo"><a href="#2-3-更改刷新时的-logo" class="headerlink" title="2.3 更改刷新时的 logo"></a>2.3 更改刷新时的 logo</h2><p>打开控制台，到网络请求，选择所有请求，快速刷新页面会发现这个图标<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1621002688764-274ce7d8-ece1-47b3-bed8-a87f1e750e06.png#clientId=u4de613e7-ed76-4&from=paste&height=752&id=u8de5d96b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=752&originWidth=1878&originalType=binary&size=113643&status=done&style=none&taskId=u4e53df56-d01a-464d-94cd-044acc21097&width=1878" srcset="/img/loading.gif" lazyload alt="image.png"><br>将自己的 logo.png 文件复制到\public 文件下<br>然后在\src\pages\document.ejs 中更改自己的 logo</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;div<br>  style=<span class="hljs-string">&quot;</span><br><span class="hljs-string">          display: flex;</span><br><span class="hljs-string">          flex-direction: column;</span><br><span class="hljs-string">          align-items: center;</span><br><span class="hljs-string">          justify-content: center;</span><br><span class="hljs-string">          height: 100%;</span><br><span class="hljs-string">          min-height: 420px;</span><br><span class="hljs-string">        &quot;</span>&gt;<br>  &lt;img src=<span class="hljs-string">&quot;&lt;%= context.config.publicPath +&#x27;logo.png&#x27;%&gt;&quot;</span> alt=<span class="hljs-string">&quot;logo&quot;</span> width=<span class="hljs-string">&quot;256&quot;</span> /&gt;<br>  &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;page-loading-warp&quot;</span>&gt;<br>    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;ant-spin ant-spin-lg ant-spin-spinning&quot;</span>&gt;<br>      &lt;span <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;ant-spin-dot ant-spin-dot-spin&quot;</span>&gt;<br>        &lt;i <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;ant-spin-dot-item&quot;</span>&gt;&lt;/i&gt;<br>        &lt;i <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;ant-spin-dot-item&quot;</span>&gt;&lt;/i&gt;<br>        &lt;i <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;ant-spin-dot-item&quot;</span>&gt;&lt;/i&gt;<br>        &lt;i <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;ant-spin-dot-item&quot;</span>&gt;&lt;/i&gt;<br>      &lt;/span&gt;<br>    &lt;/div&gt;<br>  &lt;/div&gt;<br>  &lt;div style=<span class="hljs-string">&quot;display: flex; align-items: center; justify-content: center&quot;</span>&gt;<br>    &lt;img src=<span class="hljs-string">&quot;&lt;%= context.config.publicPath +&#x27;logo.png&#x27;%&gt;&quot;</span> width=<span class="hljs-string">&quot;32&quot;</span> style=<span class="hljs-string">&quot;margin-right: 8px&quot;</span> /&gt;<br>    融职商城<br>  &lt;/div&gt;<br>&lt;/div&gt;<br></code></pre></div></td></tr></table></figure>

<h2 id="2-4-更改网页标题的-ico"><a href="#2-4-更改网页标题的-ico" class="headerlink" title="2.4 更改网页标题的 ico"></a>2.4 更改网页标题的 ico</h2><h3 id="2-4-1-将图片格式改成-ioc"><a href="#2-4-1-将图片格式改成-ioc" class="headerlink" title="2.4.1 将图片格式改成 ioc"></a>2.4.1 将图片格式改成 ioc</h3><ol>
<li>第一步我们用<strong>画图</strong>的方式打开原始图片，可以看到这里是一张 png 格式的原始图片，如下图所示：</li>
<li><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1621004331012-681faf70-73fe-4eae-919d-b805ed024698.png#clientId=u4de613e7-ed76-4&from=paste&height=856&id=u6fcca602&margin=%5Bobject%20Object%5D&name=image.png&originHeight=856&originWidth=1520&originalType=binary&size=97261&status=done&style=none&taskId=udb509057-727f-40e9-a3f1-86c55d349a0&width=1520" srcset="/img/loading.gif" lazyload alt="image.png"></li>
<li>第二步点击画图中文件图标，选择“另存为-&gt;BMP 图片”</li>
<li>第四步我们将 BMP 格式的后缀名改为 ico 格式的，弹出框之后，点击确定，可以看到已经成功更改为 ico 格式的图片，需要注意的是有时候直接改后缀名会出现图片默认是白色，点击进去时正常的，不影响程序使用</li>
</ol>
<h3 id="2-4-2-更改网页默认的-ico"><a href="#2-4-2-更改网页默认的-ico" class="headerlink" title="2.4.2 更改网页默认的 ico"></a>2.4.2 更改网页默认的 ico</h3><p>在\public 中将自己的 ico 提换掉 favicon.ico</p>
<h2 id="2-5-删除登录页多余的东西"><a href="#2-5-删除登录页多余的东西" class="headerlink" title="2.5 删除登录页多余的东西"></a>2.5 删除登录页多余的东西</h2><p>在\src\pages\User\login\index.jsx 文件中精简代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; LockOutlined, UserOutlined &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/icons&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Alert, Tabs &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> React, &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> ProForm, &#123; ProFormText &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-form&#x27;</span><br><span class="hljs-keyword">import</span> &#123; useIntl, connect, FormattedMessage &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;umi&#x27;</span><br><span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./index.less&#x27;</span><br><br><span class="hljs-keyword">const</span> LoginMessage = <span class="hljs-function">(<span class="hljs-params">&#123; content &#125;</span>) =&gt;</span> (<br>  &lt;Alert<br>    style=&#123;&#123;<br>      marginBottom: <span class="hljs-number">24</span>,<br>    &#125;&#125;<br>    message=&#123;content&#125;<br>    type=<span class="hljs-string">&quot;error&quot;</span><br>    showIcon<br>  /&gt;<br>)<br><br><span class="hljs-keyword">const</span> Login = <span class="hljs-function"><span class="hljs-params">props</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; userLogin = &#123;&#125;, submitting &#125; = props<br>  <span class="hljs-keyword">const</span> &#123; status, <span class="hljs-attr">type</span>: loginType &#125; = userLogin<br>  <span class="hljs-keyword">const</span> [type, setType] = useState(<span class="hljs-string">&#x27;account&#x27;</span>)<br>  <span class="hljs-keyword">const</span> intl = useIntl()<br><br>  <span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; dispatch &#125; = props<br>    dispatch(&#123;<br>      type: <span class="hljs-string">&#x27;login/login&#x27;</span>,<br>      payload: &#123; ...values, type &#125;,<br>    &#125;)<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;div className=&#123;styles.main&#125;&gt;<br>      &lt;ProForm<br>        initialValues=&#123;&#123;<br>          autoLogin: <span class="hljs-literal">true</span>,<br>        &#125;&#125;<br>        submitter=&#123;&#123;<br>          render: <span class="hljs-function">(<span class="hljs-params">_, dom</span>) =&gt;</span> dom.pop(),<br>          submitButtonProps: &#123;<br>            loading: submitting,<br>            size: <span class="hljs-string">&#x27;large&#x27;</span>,<br>            style: &#123;<br>              width: <span class="hljs-string">&#x27;100%&#x27;</span>,<br>            &#125;,<br>          &#125;,<br>        &#125;&#125;<br>        onFinish=&#123;<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> &#123;<br>          handleSubmit(values)<br>          <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve()<br>        &#125;&#125;&gt;<br>        &lt;Tabs activeKey=&#123;type&#125; onChange=&#123;setType&#125;&gt;<br>          &lt;Tabs.TabPane<br>            key=<span class="hljs-string">&quot;account&quot;</span><br>            tab=&#123;intl.formatMessage(&#123;<br>              id: <span class="hljs-string">&#x27;pages.login.accountLogin.tab&#x27;</span>,<br>              defaultMessage: <span class="hljs-string">&#x27;Account password login&#x27;</span>,<br>            &#125;)&#125;<br>          /&gt;<br>        &lt;/Tabs&gt;<br><br>        &#123;status === <span class="hljs-string">&#x27;error&#x27;</span> &amp;&amp; !submitting &amp;&amp; (<br>          &lt;LoginMessage<br>            content=&#123;intl.formatMessage(&#123;<br>              id: <span class="hljs-string">&#x27;pages.login.accountLogin.errorMessage&#x27;</span>,<br>              defaultMessage: <span class="hljs-string">&#x27;Incorrect account or password（admin/ant.design)&#x27;</span>,<br>            &#125;)&#125;<br>          /&gt;<br>        )&#125;<br>        &lt;ProFormText<br>          name=<span class="hljs-string">&quot;userName&quot;</span><br>          fieldProps=&#123;&#123;<br>            size: <span class="hljs-string">&#x27;large&#x27;</span>,<br>            prefix: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserOutlined</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;styles.prefixIcon&#125;</span> /&gt;</span></span>,<br>          &#125;&#125;<br>          placeholder=&#123;intl.formatMessage(&#123;<br>            id: <span class="hljs-string">&#x27;pages.login.username.placeholder&#x27;</span>,<br>            defaultMessage: <span class="hljs-string">&#x27;Username: admin or user&#x27;</span>,<br>          &#125;)&#125;<br>          rules=&#123;[<br>            &#123;<br>              required: <span class="hljs-literal">true</span>,<br>              message: (<br>                &lt;FormattedMessage<br>                  id=<span class="hljs-string">&quot;pages.login.username.required&quot;</span><br>                  defaultMessage=<span class="hljs-string">&quot;Please enter user name!&quot;</span><br>                /&gt;<br>              ),<br>            &#125;,<br>          ]&#125;<br>        /&gt;<br>        &lt;ProFormText.Password<br>          name=<span class="hljs-string">&quot;password&quot;</span><br>          fieldProps=&#123;&#123;<br>            size: <span class="hljs-string">&#x27;large&#x27;</span>,<br>            prefix: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LockOutlined</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;styles.prefixIcon&#125;</span> /&gt;</span></span>,<br>          &#125;&#125;<br>          placeholder=&#123;intl.formatMessage(&#123;<br>            id: <span class="hljs-string">&#x27;pages.login.password.placeholder&#x27;</span>,<br>            defaultMessage: <span class="hljs-string">&#x27;Password: ant.design&#x27;</span>,<br>          &#125;)&#125;<br>          rules=&#123;[<br>            &#123;<br>              required: <span class="hljs-literal">true</span>,<br>              message: (<br>                &lt;FormattedMessage<br>                  id=<span class="hljs-string">&quot;pages.login.password.required&quot;</span><br>                  defaultMessage=<span class="hljs-string">&quot;Please enter password！&quot;</span><br>                /&gt;<br>              ),<br>            &#125;,<br>          ]&#125;<br>        /&gt;<br>        &lt;div<br>          style=&#123;&#123;<br>            marginBottom: <span class="hljs-number">24</span>,<br>          &#125;&#125;&gt;&lt;/div&gt;<br>      &lt;/ProForm&gt;<br>    &lt;/div&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> connect(<span class="hljs-function">(<span class="hljs-params">&#123; login, loading &#125;</span>) =&gt;</span> (&#123;<br>  userLogin: login,<br>  submitting: loading.effects[<span class="hljs-string">&#x27;login/login&#x27;</span>],<br>&#125;))(Login)<br></code></pre></div></td></tr></table></figure>

<p>在\src\layouts\UserLayout.jsx 中将默认的 logo 替换成自己的 logo</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> logo <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../assets/logo.png&#x27;</span><br></code></pre></div></td></tr></table></figure>

<p>在 UserLayout.jsx 文件删除标签<code>FormattedMessage</code>内<code>defaultMessage=“”</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;div className=&#123;styles.desc&#125;&gt;<br>  &lt;FormattedMessage id=<span class="hljs-string">&quot;pages.layouts.userLayout.title&quot;</span> /&gt;<br>&lt;/div&gt;<br></code></pre></div></td></tr></table></figure>

<p>在国际化\src\locales\zh-CN\pages.js 文件中修改 pages.layouts.userLayout.title 的默认文字</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-string">&#x27;pages.layouts.userLayout.title&#x27;</span>: <span class="hljs-string">&#x27;融职商城后台管理系统&#x27;</span>,<br></code></pre></div></td></tr></table></figure>

<h2 id="2-6-删除首页头部多余东西"><a href="#2-6-删除首页头部多余东西" class="headerlink" title="2.6 删除首页头部多余东西"></a>2.6 删除首页头部多余东西</h2><p>在\src\components\GlobalHeader\RightContent.jsx 文件中删除搜索组件<code>HeaderSearch</code>和文档组件<code>Tooltip</code></p>
<h2 id="2-7-优化登录页"><a href="#2-7-优化登录页" class="headerlink" title="2.7 优化登录页"></a>2.7 优化登录页</h2><h3 id="2-7-1-优化登录页文件"><a href="#2-7-1-优化登录页文件" class="headerlink" title="2.7.1 优化登录页文件"></a>2.7.1 优化登录页文件</h3><p>将登录页移到 pages 下删除 User 文件夹，注意非必要不要随意更改 pages 下的文件夹，因为改动文件夹要配置对应路由<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1621012663592-2b6e11f9-08fe-4a02-a092-8a3ef86dc96f.png#clientId=u4de613e7-ed76-4&from=paste&height=195&id=ub076cd51&margin=%5Bobject%20Object%5D&name=image.png&originHeight=195&originWidth=360&originalType=binary&size=8854&status=done&style=none&taskId=u5cbc6b9b-753b-4f7a-91b3-e8e3478b3ba&width=360" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="2-7-2-配置登录页路由"><a href="#2-7-2-配置登录页路由" class="headerlink" title="2.7.2 配置登录页路由"></a>2.7.2 配置登录页路由</h3><p>在\config\routes.js 将原来 user 的路由修改成 login 的路由</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>  path: <span class="hljs-string">&#x27;/login&#x27;</span>,<br>  component: <span class="hljs-string">&#x27;../layouts/LoginLayout&#x27;</span>,<br>  routes: [<br>    &#123;<br>      name: <span class="hljs-string">&#x27;login&#x27;</span>,<br>      path: <span class="hljs-string">&#x27;/login&#x27;</span>,<br>      component: <span class="hljs-string">&#x27;./Login&#x27;</span>,<br>    &#125;,<br>  ],<br>&#125;,<br></code></pre></div></td></tr></table></figure>

<p>同时修改\src\layouts 文件下 UserLayout.jsx less 文件重命名为 LginLayout 的<br>以及修改 UserLayout.jsx 中的样式导入<code>import styles from &#39;./LoginLayout.less&#39;;</code><br>在\src\layouts\SecurityLayout.jsx 中更改重定向的登录路由</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">if</span> (!isLogin &amp;&amp; <span class="hljs-built_in">window</span>.location.pathname !== <span class="hljs-string">&#x27;/login&#x27;</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Redirect</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&#123;</span>`/<span class="hljs-attr">login</span>?$&#123;<span class="hljs-attr">queryString</span>&#125;`&#125; /&gt;</span></span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="2-8-封装网络请求"><a href="#2-8-封装网络请求" class="headerlink" title="2.8 封装网络请求"></a>2.8 封装网络请求</h2><h3 id="2-8-1-添加请求拦截器"><a href="#2-8-1-添加请求拦截器" class="headerlink" title="2.8.1 添加请求拦截器"></a>2.8.1 添加请求拦截器</h3><p><strong>具体如何找请求拦截器</strong> 1.先进入<a target="_blank" rel="noopener" href="https://umijs.org/zh-CN">umijs</a>找到<strong>插件</strong>选择<strong>plugin-request</strong>进去找到<a target="_blank" rel="noopener" href="https://umijs.org/zh-CN/plugins/plugin-request#request">request</a>​<img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1621051841217-6924f9a7-bbca-448c-a09e-34dcd7cb46c6.png#clientId=u79fc6bc8-ff2c-4&from=paste&height=148&id=u33d47bbd&margin=%5Bobject%20Object%5D&name=image.png&originHeight=148&originWidth=1249&originalType=binary&size=18888&status=done&style=none&taskId=ue22fa43b-c8c8-4cf8-8845-0ee898b74f4&width=1249" srcset="/img/loading.gif" lazyload alt="image.png"> 2.点击参考文档地址找到<a target="_blank" rel="noopener" href="https://github.com/umijs/umi-request#interceptor"><strong>Interceptor</strong></a><br><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1621051557253-22301f45-88cd-4334-8321-9b60c4656053.png#clientId=u79fc6bc8-ff2c-4&from=paste&height=412&id=u87e50faa&margin=%5Bobject%20Object%5D&name=image.png&originHeight=412&originWidth=1164&originalType=binary&size=34493&status=done&style=none&taskId=u90f3f4cf-a242-46e6-9e8c-f3b4cc656ed&width=1164" srcset="/img/loading.gif" lazyload alt="image.png"> 3.添加请求头<br>在\src\utils\request.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> request = extend(&#123;<br>  errorHandler,<br>  <span class="hljs-comment">// default error handling</span><br>  credentials: <span class="hljs-string">&#x27;include&#x27;</span>, <span class="hljs-comment">// Does the default request bring cookies</span><br>&#125;)<br><br><span class="hljs-comment">// 请求拦截器，在请求之前添加Header头</span><br>request.interceptors.request.use(<span class="hljs-function">(<span class="hljs-params">url, options</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// 获取token</span><br>  <span class="hljs-keyword">const</span> token = <span class="hljs-string">&#x27;hello&#x27;</span><br>  <span class="hljs-comment">// 设置Header头</span><br>  <span class="hljs-keyword">const</span> headers = &#123;<br>    Authorization: <span class="hljs-string">`Bearer <span class="hljs-subst">$&#123;token&#125;</span>`</span>,<br>  &#125;<br>  <span class="hljs-keyword">return</span> &#123;<br>    url,<br>    options: &#123; ...options, headers &#125;,<br>  &#125;<br>&#125;)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> request<br></code></pre></div></td></tr></table></figure>

<h3 id="2-8-2-封装错误信息提示"><a href="#2-8-2-封装错误信息提示" class="headerlink" title="2.8.2 封装错误信息提示"></a>2.8.2 封装错误信息提示</h3><h4 id="1-重新启动项目"><a href="#1-重新启动项目" class="headerlink" title="1.重新启动项目"></a>1.重新启动项目</h4><p><strong>通过</strong><code>**yarn dev**</code><strong>启动项目会关闭 mock，之后就能添加自己的 api</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">yarn dev<br></code></pre></div></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1621055060891-822ef533-9e43-4870-984d-ffcb882ca15e.png#clientId=u79fc6bc8-ff2c-4&from=paste&height=179&id=u0891d995&margin=%5Bobject%20Object%5D&name=image.png&originHeight=179&originWidth=475&originalType=binary&size=10389&status=done&style=none&taskId=u69ae0f45-eb73-4eec-87d7-8baafb08129&width=475" srcset="/img/loading.gif" lazyload alt="image.png"><br>在\package.json 可以查到相关配置</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-string">&quot;start:dev&quot;</span>: <span class="hljs-string">&quot;cross-env REACT_APP_ENV=dev MOCK=none UMI_ENV=dev umi dev&quot;</span>,<br></code></pre></div></td></tr></table></figure>

<h4 id="2-更改代理"><a href="#2-更改代理" class="headerlink" title="2.更改代理"></a>2.更改代理</h4><p>在\config\proxy.js 中将 dev 的域名改成自己的</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">dev: &#123;<br>  <span class="hljs-string">&#x27;/api/&#x27;</span>: &#123;<br>    target: <span class="hljs-string">&#x27;https://api.shop.eduwork.cn/&#x27;</span>,<br>    changeOrigin: <span class="hljs-literal">true</span>,<br>    pathRewrite: &#123;<br>      <span class="hljs-string">&#x27;^&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>    &#125;,<br>  &#125;,<br>&#125;,<br></code></pre></div></td></tr></table></figure>

<p>在\src\services\user.js 中将接口请求改成<code>request.post(&#39;/api/admin/user&#39;)</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queryCurrent</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-comment">// return request(&#x27;/api/currentUser&#x27;);</span><br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/api/admin/user&#x27;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="3-修改错误提示"><a href="#3-修改错误提示" class="headerlink" title="3.修改错误提示"></a>3.修改错误提示</h4><p>在\src\utils\request.js 中，通过<code>async</code> <code>await</code>替换<code>promise</code>完成异步请求<br>async/await 场景：这是一个用同步的思维来解决异步问题的方案，当前端接口调用需要等到接口返回值以后渲染页面时</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> errorHandler = <span class="hljs-keyword">async</span> error =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; response &#125; = error<br><br>  <span class="hljs-keyword">if</span> (response &amp;&amp; response.status) &#123;<br>    <span class="hljs-keyword">let</span> errorText = codeMessage[response.status] || response.statusText<br>    <span class="hljs-keyword">const</span> &#123; status &#125; = response<br>    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> response.json()<br><br>    <span class="hljs-comment">// 处理422未验证通过的情况</span><br>    <span class="hljs-keyword">if</span> (status === <span class="hljs-number">422</span>) &#123;<br>      <span class="hljs-keyword">let</span> errs = <span class="hljs-string">&#x27;&#x27;</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> result.errors) &#123;<br>        errs += result.errors[key][<span class="hljs-number">0</span>]<br>      &#125;<br>      errorText += <span class="hljs-string">`[ <span class="hljs-subst">$&#123;errs&#125;</span> ]`</span><br>    &#125;<br>    <span class="hljs-comment">// 处理400的情况</span><br>    <span class="hljs-keyword">if</span> (status === <span class="hljs-number">400</span>) &#123;<br>      errorText += <span class="hljs-string">`[ <span class="hljs-subst">$&#123;result.message&#125;</span> ]`</span><br>    &#125;<br>    message.error(errorText)<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!response) &#123;<br>    message.error(<span class="hljs-string">&#x27;网络发生异常，无法连接服务器&#x27;</span>)<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> response<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="4-简化接口前缀（初始化项目可不设置）"><a href="#4-简化接口前缀（初始化项目可不设置）" class="headerlink" title="4.简化接口前缀（初始化项目可不设置）"></a>4.简化接口前缀（初始化项目可不设置）</h4><p>在\src\utils\request.js 中的 request 函数添加<code>prefix: &#39;/api&#39;</code>，则可以自动添加前缀简化接口写法<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1621057857088-cae9855c-c15f-4411-b7bb-c7963663e66c.png#clientId=u79fc6bc8-ff2c-4&from=paste&height=166&id=u5a31ab0d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=166&originWidth=559&originalType=binary&size=12815&status=done&style=none&taskId=u62aabca7-6d8e-4ade-a2ec-0bf71b6863c&width=559" srcset="/img/loading.gif" lazyload alt="image.png"><br>在\src\services\user.js 中，前缀则可以少写<code>/api</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queryCurrent</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-comment">// return request(&#x27;/api/currentUser&#x27;);</span><br>  <span class="hljs-keyword">return</span> request.post(<span class="hljs-string">&#x27;/auth/login&#x27;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h1 id="三、登录-退出功能"><a href="#三、登录-退出功能" class="headerlink" title="三、登录/退出功能"></a>三、登录/退出功能</h1><h2 id="3-1-登录基本设置"><a href="#3-1-登录基本设置" class="headerlink" title="3.1 登录基本设置"></a>3.1 登录基本设置</h2><p>在 src\pages\Login\index.jsx 登录页简化，</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; LockOutlined, UserOutlined &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/icons&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Tabs &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> ProForm, &#123; ProFormText &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-form&#x27;</span><br><span class="hljs-keyword">import</span> &#123; connect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;umi&#x27;</span><br><span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./index.less&#x27;</span><br><br><span class="hljs-keyword">const</span> Login = <span class="hljs-function"><span class="hljs-params">props</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; submitting &#125; = props<br><br>  <span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; dispatch &#125; = props<br>    dispatch(&#123;<br>      type: <span class="hljs-string">&#x27;login/login&#x27;</span>,<br>      payload: &#123; ...values &#125;,<br>    &#125;)<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;div className=&#123;styles.main&#125;&gt;<br>      &lt;ProForm<br>        initialValues=&#123;&#123;<br>          autoLogin: <span class="hljs-literal">true</span>,<br>        &#125;&#125;<br>        submitter=&#123;&#123;<br>          render: <span class="hljs-function">(<span class="hljs-params">_, dom</span>) =&gt;</span> dom.pop(),<br>          submitButtonProps: &#123;<br>            loading: submitting,<br>            size: <span class="hljs-string">&#x27;large&#x27;</span>,<br>            style: &#123;<br>              width: <span class="hljs-string">&#x27;100%&#x27;</span>,<br>            &#125;,<br>          &#125;,<br>        &#125;&#125;<br>        onFinish=&#123;<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> &#123;<br>          handleSubmit(values)<br>          <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve()<br>        &#125;&#125;&gt;<br>        &lt;Tabs activeKey=<span class="hljs-string">&quot;account&quot;</span>&gt;<br>          &lt;Tabs.TabPane key=<span class="hljs-string">&quot;account&quot;</span> tab=<span class="hljs-string">&quot;账号密码登录&quot;</span> /&gt;<br>        &lt;/Tabs&gt;<br><br>        &lt;ProFormText<br>          name=<span class="hljs-string">&quot;email&quot;</span><br>          fieldProps=&#123;&#123;<br>            size: <span class="hljs-string">&#x27;large&#x27;</span>,<br>            prefix: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserOutlined</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;styles.prefixIcon&#125;</span> /&gt;</span></span>,<br>          &#125;&#125;<br>          placeholder=<span class="hljs-string">&quot;邮箱：super@a.com&quot;</span><br>          rules=&#123;[<br>            &#123;<br>              required: <span class="hljs-literal">true</span>,<br>              message: <span class="hljs-string">&#x27;请输入邮箱&#x27;</span>,<br>            &#125;,<br>            &#123;<br>              type: <span class="hljs-string">&#x27;email&#x27;</span>,<br>              message: <span class="hljs-string">&#x27;请输入正确的邮箱格式&#x27;</span>,<br>            &#125;,<br>          ]&#125;<br>        /&gt;<br>        &lt;ProFormText.Password<br>          name=<span class="hljs-string">&quot;password&quot;</span><br>          fieldProps=&#123;&#123;<br>            size: <span class="hljs-string">&#x27;large&#x27;</span>,<br>            prefix: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LockOutlined</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;styles.prefixIcon&#125;</span> /&gt;</span></span>,<br>          &#125;&#125;<br>          placeholder=<span class="hljs-string">&quot;密码：123123&quot;</span><br>          rules=&#123;[<br>            &#123;<br>              required: <span class="hljs-literal">true</span>,<br>              message: <span class="hljs-string">&#x27;请输入密码&#x27;</span>,<br>            &#125;,<br>          ]&#125;<br>        /&gt;<br>        &lt;div<br>          style=&#123;&#123;<br>            marginBottom: <span class="hljs-number">24</span>,<br>          &#125;&#125;&gt;&lt;/div&gt;<br>      &lt;/ProForm&gt;<br>    &lt;/div&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> connect(<span class="hljs-function">(<span class="hljs-params">&#123; login, loading &#125;</span>) =&gt;</span> (&#123;<br>  userLogin: login,<br>  submitting: loading.effects[<span class="hljs-string">&#x27;login/login&#x27;</span>],<br>&#125;))(Login)<br></code></pre></div></td></tr></table></figure>

<h3 id="3-1-1-用户登录接口文档"><a href="#3-1-1-用户登录接口文档" class="headerlink" title="3.1.1 用户登录接口文档"></a>3.1.1 用户登录接口文档</h3><h5 id="接口描述"><a href="#接口描述" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>用户登录接口</li>
</ul>
<h5 id="请求-URL"><a href="#请求-URL" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/auth/login</li>
</ul>
<h5 id="请求方式"><a href="#请求方式" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>POST</li>
</ul>
<h5 id="Body-请求参数"><a href="#Body-请求参数" class="headerlink" title="Body 请求参数"></a>Body 请求参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>email</td>
<td>是</td>
<td>string</td>
<td>邮箱</td>
</tr>
<tr>
<td>password</td>
<td>是</td>
<td>string</td>
<td>密码</td>
</tr>
</tbody></table>
<h5 id="返回参数"><a href="#返回参数" class="headerlink" title="返回参数"></a>返回参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必含</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>access_token</td>
<td>是</td>
<td>string</td>
<td>token</td>
</tr>
<tr>
<td>token_type</td>
<td>是</td>
<td>string</td>
<td>token 类型</td>
</tr>
<tr>
<td>expires_in</td>
<td>是</td>
<td>int</td>
<td>过期时间</td>
</tr>
</tbody></table>
<h5 id="返回示例"><a href="#返回示例" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 200 请求成功</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;access_token&quot;</span>: <span class="hljs-string">&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOlwvXC9hcGkudGVzdFwvYXBpXC9hdXRoXC9sb2dpbiIsImlhdCI6MTYwNzUyMDE0MSwiZXhwIjoxNjA3NTIzNzQxLCJuYmYiOjE2MDc1MjAxNDEsImp0aSI6IktVdWFsTmxnOXYzZmlTZHEiLCJzdWIiOjMsInBydiI6IjIzYmQ1Yzg5NDlmNjAwYWRiMzllNzAxYzQwMDg3MmRiN2E1OTc2ZjcifQ.BpVdvBjKEhQ2aIZBfkE-SoU2a3UeFkYCKQKh42Ncbio&quot;</span>,<br>    <span class="hljs-string">&quot;token_type&quot;</span>: <span class="hljs-string">&quot;Bearer&quot;</span>,<br>    <span class="hljs-string">&quot;expires_in&quot;</span>: <span class="hljs-number">3600</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>状态码 422 参数错误</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;The given data was invalid.&quot;</span>,<br>    <span class="hljs-string">&quot;errors&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;email&quot;</span>: [<br>            <span class="hljs-string">&quot;邮箱 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;password&quot;</span>: [<br>            <span class="hljs-string">&quot;密码 不能为空。&quot;</span><br>        ]<br>    &#125;,<br>    <span class="hljs-string">&quot;status_code&quot;</span>: <span class="hljs-number">422</span>,<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="3-1-2-添加登录接口"><a href="#3-1-2-添加登录接口" class="headerlink" title="3.1.2 添加登录接口"></a>3.1.2 添加登录接口</h3><p>在 src\services\login.js 中</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/request&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fakeAccountLogin</span>(<span class="hljs-params">params</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/auth/login&#x27;</span>, &#123;<br>    method: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>    data: params,<br>  &#125;)<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getFakeCaptcha</span>(<span class="hljs-params">mobile</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">`/api/login/captcha?mobile=<span class="hljs-subst">$&#123;mobile&#125;</span>`</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="1-将token存入localStorage"><a href="#1-将token存入localStorage" class="headerlink" title="1.将token存入localStorage"></a>1.将<code>token</code>存入<code>localStorage</code></h4><p>在\src\models\login.js 判断是否登录，并跳转到首页，将<code>token</code>存入<code>localStorage</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; stringify &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;querystring&#x27;</span><br><span class="hljs-keyword">import</span> &#123; history &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;umi&#x27;</span><br><span class="hljs-keyword">import</span> &#123; fakeAccountLogin &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/login&#x27;</span><br><span class="hljs-keyword">import</span> &#123; setAuthority &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/authority&#x27;</span><br><span class="hljs-keyword">import</span> &#123; getPageQuery &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/utils&#x27;</span><br><span class="hljs-keyword">import</span> &#123; message &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><br><span class="hljs-keyword">const</span> Model = &#123;<br>  namespace: <span class="hljs-string">&#x27;login&#x27;</span>,<br>  state: &#123;&#125;,<br>  effects: &#123;<br>    *<span class="hljs-function"><span class="hljs-title">login</span>(<span class="hljs-params">&#123; payload &#125;, &#123; call, put &#125;</span>)</span> &#123;<br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">yield</span> call(fakeAccountLogin, payload)<br>      <span class="hljs-comment">// 判断是否登陆成功</span><br>      <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>        <span class="hljs-keyword">yield</span> put(&#123;<br>          type: <span class="hljs-string">&#x27;changeLoginStatus&#x27;</span>,<br>          payload: response,<br>        &#125;) <span class="hljs-comment">// Login successfully</span><br><br>        <span class="hljs-comment">// 跳转到首页</span><br>        history.replace(<span class="hljs-string">&#x27;/&#x27;</span>)<br>        message.success(<span class="hljs-string">&#x27;🎉 🎉 🎉  登录成功！&#x27;</span>)<br>      &#125;<br>    &#125;,<br><br>    <span class="hljs-function"><span class="hljs-title">logout</span>(<span class="hljs-params"></span>)</span> &#123;<br>      <span class="hljs-keyword">const</span> &#123; redirect &#125; = getPageQuery() <span class="hljs-comment">// Note: There may be security issues, please note</span><br><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.location.pathname !== <span class="hljs-string">&#x27;/user/login&#x27;</span> &amp;&amp; !redirect) &#123;<br>        history.replace(&#123;<br>          pathname: <span class="hljs-string">&#x27;/user/login&#x27;</span>,<br>          search: stringify(&#123;<br>            redirect: <span class="hljs-built_in">window</span>.location.href,<br>          &#125;),<br>        &#125;)<br>      &#125;<br>    &#125;,<br>  &#125;,<br>  reducers: &#123;<br>    <span class="hljs-function"><span class="hljs-title">changeLoginStatus</span>(<span class="hljs-params">state, &#123; payload &#125;</span>)</span> &#123;<br>      <span class="hljs-comment">// 将token存入localStorage</span><br>      <span class="hljs-built_in">localStorage</span>.setItem(<span class="hljs-string">&#x27;access_token&#x27;</span>, payload.access_token)<br>      <span class="hljs-keyword">return</span> &#123; ...state &#125;<br>    &#125;,<br>  &#125;,<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Model<br></code></pre></div></td></tr></table></figure>

<h4 id="2-取出token，加在Header头中"><a href="#2-取出token，加在Header头中" class="headerlink" title="2.取出token，加在Header头中"></a>2.取出<code>token</code>，加在<code>Header</code>头中</h4><p>在\src\utils\request.js 取出<code>token</code>，加在<code>Header</code>头中</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">/** Request 网络请求工具 更详细的 api 文档: https://github.com/umijs/umi-request */</span><br><span class="hljs-keyword">import</span> &#123; extend &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;umi-request&#x27;</span><br><span class="hljs-keyword">import</span> &#123; message &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><br><span class="hljs-keyword">const</span> codeMessage = &#123;<br>  <span class="hljs-number">200</span>: <span class="hljs-string">&#x27;服务器成功返回请求的数据。&#x27;</span>,<br>  <span class="hljs-number">201</span>: <span class="hljs-string">&#x27;新建数据成功。&#x27;</span>,<br>  <span class="hljs-number">202</span>: <span class="hljs-string">&#x27;一个请求已经进入后台排队（异步任务）。&#x27;</span>,<br>  <span class="hljs-number">204</span>: <span class="hljs-string">&#x27;处理成功。&#x27;</span>,<br>  <span class="hljs-number">400</span>: <span class="hljs-string">&#x27;发出的请求有错误，服务器没有进行新建或修改数据的操作。&#x27;</span>,<br>  <span class="hljs-number">401</span>: <span class="hljs-string">&#x27;用户没有权限（令牌、用户名、密码错误）。&#x27;</span>,<br>  <span class="hljs-number">403</span>: <span class="hljs-string">&#x27;用户得到授权，但是访问是被禁止的。&#x27;</span>,<br>  <span class="hljs-number">404</span>: <span class="hljs-string">&#x27;发出的请求针对的是不存在的记录，服务器没有进行操作。&#x27;</span>,<br>  <span class="hljs-number">406</span>: <span class="hljs-string">&#x27;请求的格式不可得。&#x27;</span>,<br>  <span class="hljs-number">410</span>: <span class="hljs-string">&#x27;请求的资源被永久删除，且不会再得到的。&#x27;</span>,<br>  <span class="hljs-number">422</span>: <span class="hljs-string">&#x27;当创建一个对象时，发生一个验证错误。&#x27;</span>,<br>  <span class="hljs-number">500</span>: <span class="hljs-string">&#x27;服务器发生错误，请检查服务器。&#x27;</span>,<br>  <span class="hljs-number">502</span>: <span class="hljs-string">&#x27;网关错误。&#x27;</span>,<br>  <span class="hljs-number">503</span>: <span class="hljs-string">&#x27;服务不可用，服务器暂时过载或维护。&#x27;</span>,<br>  <span class="hljs-number">504</span>: <span class="hljs-string">&#x27;网关超时。&#x27;</span>,<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@zh</span>-CN 异常处理程序</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@en</span>-US Exception handler</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">const</span> errorHandler = <span class="hljs-keyword">async</span> error =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; response &#125; = error<br><br>  <span class="hljs-keyword">if</span> (response &amp;&amp; response.status) &#123;<br>    <span class="hljs-keyword">let</span> errorText = codeMessage[response.status] || response.statusText<br>    <span class="hljs-keyword">const</span> &#123; status &#125; = response<br>    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> response.json()<br>    <span class="hljs-comment">// 处理422未验证通过的情况</span><br>    <span class="hljs-keyword">if</span> (status === <span class="hljs-number">422</span>) &#123;<br>      <span class="hljs-keyword">let</span> errs = <span class="hljs-string">&#x27;&#x27;</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> result.errors) &#123;<br>        errs += result.errors[key][<span class="hljs-number">0</span>]<br>      &#125;<br>      errorText += <span class="hljs-string">`[ <span class="hljs-subst">$&#123;errs&#125;</span> ]`</span><br>    &#125;<br>    <span class="hljs-comment">// 处理400的情况</span><br>    <span class="hljs-keyword">if</span> (status === <span class="hljs-number">400</span>) &#123;<br>      errorText += <span class="hljs-string">`[ <span class="hljs-subst">$&#123;result.message&#125;</span> ]`</span><br>    &#125;<br>    message.error(errorText)<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!response) &#123;<br>    message.error(<span class="hljs-string">&#x27;网络发生异常，无法连接服务器&#x27;</span>)<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> response<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@en</span>-US Configure the default parameters for request</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@zh</span>-CN 配置request请求时的默认参数</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">const</span> request = extend(&#123;<br>  errorHandler,<br>  <span class="hljs-comment">// default error handling</span><br>  credentials: <span class="hljs-string">&#x27;include&#x27;</span>, <span class="hljs-comment">// Does the default request bring cookies</span><br>  prefix: <span class="hljs-string">&#x27;/api&#x27;</span>,<br>&#125;)<br><br><span class="hljs-comment">// 请求拦截器，在请求之前添加Header头</span><br>request.interceptors.request.use(<span class="hljs-function">(<span class="hljs-params">url, options</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// 获取token</span><br>  <span class="hljs-keyword">const</span> token = <span class="hljs-built_in">localStorage</span>.getItem(<span class="hljs-string">&#x27;access_token&#x27;</span>) || <span class="hljs-string">&#x27; &#x27;</span><br>  <span class="hljs-comment">// 设置Header头</span><br>  <span class="hljs-keyword">const</span> headers = &#123;<br>    Authorization: <span class="hljs-string">`Bearer <span class="hljs-subst">$&#123;token&#125;</span>`</span>,<br>  &#125;<br>  <span class="hljs-keyword">return</span> &#123;<br>    url,<br>    options: &#123; ...options, headers &#125;,<br>  &#125;<br>&#125;)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> request<br></code></pre></div></td></tr></table></figure>

<h2 id="3-2-获取用户信息"><a href="#3-2-获取用户信息" class="headerlink" title="3.2 获取用户信息"></a>3.2 获取用户信息</h2><h3 id="3-2-1-登录信息接口文档"><a href="#3-2-1-登录信息接口文档" class="headerlink" title="3.2.1 登录信息接口文档"></a>3.2.1 登录信息接口文档</h3><h5 id="接口描述-1"><a href="#接口描述-1" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>登录信息</li>
</ul>
<h5 id="请求-URL-1"><a href="#请求-URL-1" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/user</li>
</ul>
<h5 id="请求方式-1"><a href="#请求方式-1" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>GET</li>
</ul>
<h5 id="请求头部"><a href="#请求头部" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="返回参数-1"><a href="#返回参数-1" class="headerlink" title="返回参数"></a>返回参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必含</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>是</td>
<td>int</td>
<td>主键</td>
</tr>
<tr>
<td>name</td>
<td>是</td>
<td>string</td>
<td>昵称</td>
</tr>
<tr>
<td>email</td>
<td>是</td>
<td>string</td>
<td>邮箱</td>
</tr>
<tr>
<td>phone</td>
<td>是</td>
<td>string</td>
<td>手机号</td>
</tr>
<tr>
<td>avatar</td>
<td>是</td>
<td>string</td>
<td>头像</td>
</tr>
<tr>
<td>avatar_url</td>
<td>是</td>
<td>string</td>
<td>头像地址</td>
</tr>
<tr>
<td>is_locked</td>
<td>是</td>
<td>int</td>
<td>是否锁定： 0 正常 1 锁定</td>
</tr>
<tr>
<td>created_at</td>
<td>是</td>
<td>timestamp</td>
<td>创建时间</td>
</tr>
<tr>
<td>updated_at</td>
<td>是</td>
<td>timestamp</td>
<td>更新时间</td>
</tr>
</tbody></table>
<h5 id="返回示例-1"><a href="#返回示例-1" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 200 请求成功</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;超级管理员&quot;</span>,<br>    <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;super@a.com&quot;</span>,<br>    <span class="hljs-string">&quot;phone&quot;</span>: <span class="hljs-literal">null</span>,<br>    <span class="hljs-string">&quot;avatar&quot;</span>: <span class="hljs-literal">null</span>,<br>    <span class="hljs-string">&quot;avatar_url&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;is_locked&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-string">&quot;created_at&quot;</span>: <span class="hljs-string">&quot;2020-12-22T02:58:08.000000Z&quot;</span>,<br>    <span class="hljs-string">&quot;updated_at&quot;</span>: <span class="hljs-string">&quot;2020-12-22T04:32:27.000000Z&quot;</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="3-2-2-添加获取用户登录信息接口"><a href="#3-2-2-添加获取用户登录信息接口" class="headerlink" title="3.2.2 添加获取用户登录信息接口"></a>3.2.2 添加获取用户登录信息接口</h3><p>在\src\services\user.js 中</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/request&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">query</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/api/users&#x27;</span>)<br>&#125;<br><span class="hljs-comment">// 获取当前登录用户信息</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queryCurrent</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/admin/user&#x27;</span>)<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queryNotices</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/api/notices&#x27;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="3-2-3-将用户信息存入localstorage"><a href="#3-2-3-将用户信息存入localstorage" class="headerlink" title="3.2.3 将用户信息存入localstorage"></a>3.2.3 将用户信息存入<code>localstorage</code></h3><p>在\src\models\user.js 中判断<code>localstorage</code>是否有用户信息，没有则请求，再将用户信息存入<code>localstorage</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; queryCurrent, query <span class="hljs-keyword">as</span> queryUsers &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/user&#x27;</span><br><br><span class="hljs-keyword">const</span> UserModel = &#123;<br>  namespace: <span class="hljs-string">&#x27;user&#x27;</span>,<br>  state: &#123;<br>    currentUser: &#123;&#125;,<br>  &#125;,<br>  effects: &#123;<br>    *<span class="hljs-function"><span class="hljs-title">fetch</span>(<span class="hljs-params">_, &#123; call, put &#125;</span>)</span> &#123;<br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">yield</span> call(queryUsers)<br>      <span class="hljs-keyword">yield</span> put(&#123;<br>        type: <span class="hljs-string">&#x27;save&#x27;</span>,<br>        payload: response,<br>      &#125;)<br>    &#125;,<br><br>    <span class="hljs-comment">// 获取用户信息</span><br>    *<span class="hljs-function"><span class="hljs-title">fetchCurrent</span>(<span class="hljs-params">_, &#123; call, put &#125;</span>)</span> &#123;<br>      <span class="hljs-comment">// 查看localstorage是否有用户信息，没有再去请求</span><br>      <span class="hljs-keyword">let</span> userInfo = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">localStorage</span>.getItem(<span class="hljs-string">&#x27;userInfo&#x27;</span>))<br>      <span class="hljs-keyword">if</span> (!userInfo) &#123;<br>        userInfo = <span class="hljs-keyword">yield</span> call(queryCurrent)<br>        <span class="hljs-comment">//修复BUG：有时候userInfo返回的是useCache=false被误存入localStorage，错误的userInfo导致页面一直刷新</span><br>        <span class="hljs-keyword">if</span> (userInfo.useCache !== <span class="hljs-literal">false</span>) <span class="hljs-built_in">localStorage</span>.setItem(<span class="hljs-string">&#x27;userInfo&#x27;</span>, <span class="hljs-built_in">JSON</span>.stringify(userInfo))<br>      &#125;<br><br>      <span class="hljs-keyword">yield</span> put(&#123;<br>        type: <span class="hljs-string">&#x27;saveCurrentUser&#x27;</span>,<br>        payload: userInfo,<br>      &#125;)<br>    &#125;,<br>  &#125;,<br>  reducers: &#123;<br>    <span class="hljs-function"><span class="hljs-title">saveCurrentUser</span>(<span class="hljs-params">state, action</span>)</span> &#123;<br>      <span class="hljs-keyword">return</span> &#123; ...state, <span class="hljs-attr">currentUser</span>: action.payload || &#123;&#125; &#125;<br>    &#125;,<br>  &#125;,<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> UserModel<br></code></pre></div></td></tr></table></figure>

<h4 id="1-判断用户是否登录"><a href="#1-判断用户是否登录" class="headerlink" title="1.判断用户是否登录"></a>1.判断用户是否登录</h4><p>在\src\layouts\SecurityLayout.jsx 中精简代码，判断用户是否登录<br>//关键代码 <code>const isLogin = currentUser &amp;&amp; currentUser.id;</code>因为后台返回的用户<code>id</code>是<code>id</code>不是<code>userId</code></p>
<h5 id="返回示例-2"><a href="#返回示例-2" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 200 请求成功</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;超级管理员&quot;</span>,<br>    <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;super@a.com&quot;</span>,<br>    <span class="hljs-string">&quot;phone&quot;</span>: <span class="hljs-literal">null</span>,<br>    <span class="hljs-string">&quot;avatar&quot;</span>: <span class="hljs-literal">null</span>,<br>    <span class="hljs-string">&quot;avatar_url&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;is_locked&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-string">&quot;created_at&quot;</span>: <span class="hljs-string">&quot;2020-12-22T02:58:08.000000Z&quot;</span>,<br>    <span class="hljs-string">&quot;updated_at&quot;</span>: <span class="hljs-string">&quot;2020-12-22T04:32:27.000000Z&quot;</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> &#123; PageLoading &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-layout&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Redirect, connect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;umi&#x27;</span><br><span class="hljs-keyword">import</span> &#123; stringify &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;querystring&#x27;</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityLayout</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>&#123;<br>  state = &#123;<br>    isReady: <span class="hljs-literal">false</span>,<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-title">componentDidMount</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-built_in">this</span>.setState(&#123;<br>      isReady: <span class="hljs-literal">true</span>,<br>    &#125;)<br>    <span class="hljs-keyword">const</span> &#123; dispatch &#125; = <span class="hljs-built_in">this</span>.props<br><br>    <span class="hljs-keyword">if</span> (dispatch) &#123;<br>      dispatch(&#123;<br>        type: <span class="hljs-string">&#x27;user/fetchCurrent&#x27;</span>,<br>      &#125;)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; isReady &#125; = <span class="hljs-built_in">this</span>.state<br>    <span class="hljs-keyword">const</span> &#123; children, loading, currentUser &#125; = <span class="hljs-built_in">this</span>.props <span class="hljs-comment">// You can replace it to your authentication rule (such as check token exists)</span><br>    <span class="hljs-comment">// You can replace it with your own login authentication rules (such as judging whether the token exists)</span><br><br>    <span class="hljs-keyword">const</span> isLogin = currentUser &amp;&amp; currentUser.id<br>    <span class="hljs-keyword">const</span> queryString = stringify(&#123;<br>      redirect: <span class="hljs-built_in">window</span>.location.href,<br>    &#125;)<br><br>    <span class="hljs-keyword">if</span> ((!isLogin &amp;&amp; loading) || !isReady) &#123;<br>      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">PageLoading</span> /&gt;</span></span><br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!isLogin &amp;&amp; <span class="hljs-built_in">window</span>.location.pathname !== <span class="hljs-string">&#x27;/login&#x27;</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Redirect</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&#123;</span>`/<span class="hljs-attr">login</span>?$&#123;<span class="hljs-attr">queryString</span>&#125;`&#125; /&gt;</span></span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> children<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> connect(<span class="hljs-function">(<span class="hljs-params">&#123; user, loading &#125;</span>) =&gt;</span> (&#123;<br>  currentUser: user.currentUser,<br>  loading: loading.models.user,<br>&#125;))(SecurityLayout)<br></code></pre></div></td></tr></table></figure>

<h3 id="3-2-4-修改管理员头像"><a href="#3-2-4-修改管理员头像" class="headerlink" title="3.2.4 修改管理员头像"></a>3.2.4 修改管理员头像</h3><p>在\src\components\GlobalHeader\AvatarDropdown.jsx 修改管理员头像，将<code>currentUser.avatar</code>更改为<code>currentUser.avatar_url</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;Avatar size=<span class="hljs-string">&quot;small&quot;</span> className=&#123;styles.avatar&#125; src=&#123;currentUser.avatar_url&#125; alt=<span class="hljs-string">&quot;avatar&quot;</span> /&gt;<br></code></pre></div></td></tr></table></figure>

<h3 id="3-2-5-优化登录，判断登录之后重定向到首页"><a href="#3-2-5-优化登录，判断登录之后重定向到首页" class="headerlink" title="3.2.5 优化登录，判断登录之后重定向到首页"></a>3.2.5 优化登录，判断登录之后重定向到首页</h3><p>在\src\pages\Login\index.jsx 中 优化登录，判断登录之后重定向到首页<br>导入<code>useEffect</code>和<code>history</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> &#123; connect, history &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;umi&#x27;</span><br></code></pre></div></td></tr></table></figure>

<p>加入<code>useEffect</code>代替生命周期函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">useEffect(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// 判断如果已经登录过，直接去首页</span><br>  <span class="hljs-keyword">const</span> userInfo = <span class="hljs-built_in">localStorage</span>.getItem(<span class="hljs-string">&#x27;userInfo&#x27;</span>)<br>  <span class="hljs-keyword">if</span> (userInfo) history.replace(<span class="hljs-string">&#x27;/&#x27;</span>)<br>&#125;, [])<br></code></pre></div></td></tr></table></figure>

<h3 id="3-2-6-登录-bug"><a href="#3-2-6-登录-bug" class="headerlink" title="3.2.6 登录 bug"></a>3.2.6 登录 bug</h3><p>在在\src\models\user.js 中 将用户数据存入<code>localStorage</code>时，有时候<code>userInfo</code>返回的是<code>useCache=false</code>被误存入<code>localStorage</code>，错误的<code>userInfo</code>导致页面一直刷新</p>
<h4 id="1-解决"><a href="#1-解决" class="headerlink" title="1.解决"></a>1.解决</h4><p>在接口请求获取<code>userInfo</code>之后判断是否为正确的数据，是才存入<code>localStorage</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">if</span> (!userInfo) &#123;<br>  userInfo = <span class="hljs-keyword">yield</span> call(queryCurrent);<br>  <span class="hljs-comment">//修复BUG：有时候userInfo返回的是useCache=false被误存入localStorage，错误的userInfo导致页面一直刷新</span><br>  <span class="hljs-keyword">if</span> (userInfo.useCache !== <span class="hljs-literal">false</span>) <span class="hljs-built_in">localStorage</span>.setItem(<span class="hljs-string">&#x27;userInfo&#x27;</span>, <span class="hljs-built_in">JSON</span>.stringify(userInfo));<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="3-3-退出"><a href="#3-3-退出" class="headerlink" title="3.3 退出"></a>3.3 退出</h2><h3 id="3-3-1-退出接口文档"><a href="#3-3-1-退出接口文档" class="headerlink" title="3.3.1 退出接口文档"></a>3.3.1 退出接口文档</h3><h5 id="接口描述-2"><a href="#接口描述-2" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>退出登录</li>
</ul>
<h5 id="请求-URL-2"><a href="#请求-URL-2" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/auth/logout</li>
</ul>
<h5 id="请求方式-2"><a href="#请求方式-2" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>POST</li>
</ul>
<h5 id="请求头部-1"><a href="#请求头部-1" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="返回示例-3"><a href="#返回示例-3" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 204 请求成功</li>
</ul>
<h3 id="3-3-2-添加退出接口"><a href="#3-3-2-添加退出接口" class="headerlink" title="3.3.2 添加退出接口"></a>3.3.2 添加退出接口</h3><p>在\src\services\login.js 中</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logout</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.post(<span class="hljs-string">&#x27;/auth/logout&#x27;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="3-3-3-添加退出方法"><a href="#3-3-3-添加退出方法" class="headerlink" title="3.3.3 添加退出方法"></a>3.3.3 添加退出方法</h3><p>在\src\models\login.js 中导入<code>logout</code>并添加退出方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; history &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;umi&#x27;</span><br><span class="hljs-keyword">import</span> &#123; fakeAccountLogin, logout &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/login&#x27;</span><br><br><span class="hljs-keyword">import</span> &#123; message &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><br><span class="hljs-keyword">const</span> Model = &#123;<br>  namespace: <span class="hljs-string">&#x27;login&#x27;</span>,<br>  state: &#123;&#125;,<br>  effects: &#123;<br>    *<span class="hljs-function"><span class="hljs-title">login</span>(<span class="hljs-params">&#123; payload &#125;, &#123; call, put &#125;</span>)</span> &#123;<br>      <span class="hljs-comment">// loading</span><br>      <span class="hljs-keyword">const</span> load = message.loading(<span class="hljs-string">&#x27;登录中...&#x27;</span>)<br><br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">yield</span> call(fakeAccountLogin, payload)<br>      <span class="hljs-comment">// 判断是否登陆成功</span><br>      <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>        <span class="hljs-keyword">yield</span> put(&#123;<br>          type: <span class="hljs-string">&#x27;changeLoginStatus&#x27;</span>,<br>          payload: response,<br>        &#125;) <span class="hljs-comment">// Login successfully</span><br><br>        <span class="hljs-comment">// 跳转到首页</span><br>        history.replace(<span class="hljs-string">&#x27;/&#x27;</span>)<br>        message.success(<span class="hljs-string">&#x27;🎉 🎉 🎉  登录成功！&#x27;</span>)<br>      &#125;<br>      load()<br>    &#125;,<br><br>    *<span class="hljs-function"><span class="hljs-title">logout</span>(<span class="hljs-params">_, &#123; call &#125;</span>)</span> &#123;<br>      <span class="hljs-comment">// loading</span><br>      <span class="hljs-keyword">const</span> load = message.loading(<span class="hljs-string">&#x27;退出中...&#x27;</span>)<br><br>      <span class="hljs-comment">// 请求Api，退出登录</span><br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">yield</span> call(logout)<br><br>      <span class="hljs-comment">// 判断是否成功退出</span><br>      <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>        <span class="hljs-comment">// 删除本地存储的token和userInfo</span><br>        <span class="hljs-built_in">localStorage</span>.removeItem(<span class="hljs-string">&#x27;access_token&#x27;</span>)<br>        <span class="hljs-built_in">localStorage</span>.removeItem(<span class="hljs-string">&#x27;userInfo&#x27;</span>)<br>        <span class="hljs-comment">// 重定向到登录页</span><br>        history.replace(<span class="hljs-string">&#x27;/login&#x27;</span>)<br>        message.success(<span class="hljs-string">&#x27;🎉 🎉 🎉  退出成功！&#x27;</span>)<br>      &#125;<br>      load()<br>    &#125;,<br>  &#125;,<br>  reducers: &#123;<br>    <span class="hljs-function"><span class="hljs-title">changeLoginStatus</span>(<span class="hljs-params">state, &#123; payload &#125;</span>)</span> &#123;<br>      <span class="hljs-comment">// 将token存入localStorage</span><br>      <span class="hljs-built_in">localStorage</span>.setItem(<span class="hljs-string">&#x27;access_token&#x27;</span>, payload.access_token)<br>      <span class="hljs-keyword">return</span> &#123; ...state &#125;<br>    &#125;,<br>  &#125;,<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Model<br></code></pre></div></td></tr></table></figure>

<h1 id="四、首页统计"><a href="#四、首页统计" class="headerlink" title="四、首页统计"></a>四、首页统计</h1><h2 id="4-1-新建统计面板文件"><a href="#4-1-新建统计面板文件" class="headerlink" title="4.1 新建统计面板文件"></a>4.1 新建统计面板文件</h2><p>在 src\pages 文件夹下创建一个文件夹和文件 DashBoard\index.jsx<br>因为只有一个接口请求，而且不需要获取共享数据，就直接在文件里写请求，可以不用<code>models</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useEffect, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Statistic, Card, Row, Col &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; ArrowUpOutlined, ArrowDownOutlined &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/icons&#x27;</span><br><span class="hljs-keyword">import</span> &#123; fetchDashboard &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/dashboard&#x27;</span><br><br><span class="hljs-keyword">const</span> DashBoard = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// 定义组件状态，状态改变，重新渲染组件</span><br>  <span class="hljs-keyword">const</span> [data, setData] = useState(&#123;&#125;)<br>  useEffect(<span class="hljs-keyword">async</span> () =&gt; &#123;<br>    <span class="hljs-comment">// 发送请求，获取统计数据</span><br>    <span class="hljs-keyword">const</span> resData = <span class="hljs-keyword">await</span> fetchDashboard()<br>    <span class="hljs-comment">// 得到数据之后更新组件状态</span><br>    setData(resData)<br>  &#125;, [])<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;div&gt;<br>      &lt;Row gutter=&#123;<span class="hljs-number">16</span>&#125;&gt;<br>        &lt;Col span=&#123;<span class="hljs-number">8</span>&#125;&gt;<br>          &lt;Card&gt;<br>            &lt;Statistic<br>              title=<span class="hljs-string">&quot;用户数量&quot;</span><br>              value=&#123;data.users_count&#125;<br>              precision=&#123;<span class="hljs-number">0</span>&#125;<br>              valueStyle=&#123;&#123; <span class="hljs-attr">color</span>: <span class="hljs-string">&#x27;#3f8600&#x27;</span> &#125;&#125;<br>              prefix=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ArrowUpOutlined</span> /&gt;</span></span>&#125;<br>            /&gt;<br>          &lt;/Card&gt;<br>        &lt;/Col&gt;<br>        &lt;Col span=&#123;<span class="hljs-number">8</span>&#125;&gt;<br>          &lt;Card&gt;<br>            &lt;Statistic<br>              title=<span class="hljs-string">&quot;订单数量&quot;</span><br>              value=&#123;data.goods_count&#125;<br>              precision=&#123;<span class="hljs-number">0</span>&#125;<br>              valueStyle=&#123;&#123; <span class="hljs-attr">color</span>: <span class="hljs-string">&#x27;#cf1322&#x27;</span> &#125;&#125;<br>              prefix=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ArrowDownOutlined</span> /&gt;</span></span>&#125;<br>            /&gt;<br>          &lt;/Card&gt;<br>        &lt;/Col&gt;<br>        &lt;Col span=&#123;<span class="hljs-number">8</span>&#125;&gt;<br>          &lt;Card&gt;<br>            &lt;Statistic<br>              title=<span class="hljs-string">&quot;商品数量&quot;</span><br>              value=&#123;data.order_count&#125;<br>              precision=&#123;<span class="hljs-number">0</span>&#125;<br>              valueStyle=&#123;&#123; <span class="hljs-attr">color</span>: <span class="hljs-string">&#x27;#234abc&#x27;</span> &#125;&#125;<br>              prefix=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ArrowDownOutlined</span> /&gt;</span></span>&#125;<br>            /&gt;<br>          &lt;/Card&gt;<br>        &lt;/Col&gt;<br>      &lt;/Row&gt;<br>    &lt;/div&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> DashBoard<br></code></pre></div></td></tr></table></figure>

<h2 id="4-2-添加统计面板路由"><a href="#4-2-添加统计面板路由" class="headerlink" title="4.2 添加统计面板路由"></a>4.2 添加统计面板路由</h2><p>在 config\routes.js 中添加统计面板路由</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [<br>  &#123;<br>    path: <span class="hljs-string">&#x27;/&#x27;</span>,<br>    component: <span class="hljs-string">&#x27;../layouts/BlankLayout&#x27;</span>,<br>    routes: [<br>      &#123;<br>        path: <span class="hljs-string">&#x27;/login&#x27;</span>,<br>        component: <span class="hljs-string">&#x27;../layouts/LoginLayout&#x27;</span>,<br>        routes: [<br>          &#123;<br>            name: <span class="hljs-string">&#x27;login&#x27;</span>,<br>            path: <span class="hljs-string">&#x27;/login&#x27;</span>,<br>            component: <span class="hljs-string">&#x27;./Login&#x27;</span>,<br>          &#125;,<br>        ],<br>      &#125;,<br>      &#123;<br>        path: <span class="hljs-string">&#x27;/&#x27;</span>,<br>        component: <span class="hljs-string">&#x27;../layouts/SecurityLayout&#x27;</span>,<br>        routes: [<br>          &#123;<br>            path: <span class="hljs-string">&#x27;/&#x27;</span>,<br>            component: <span class="hljs-string">&#x27;../layouts/BasicLayout&#x27;</span>,<br>            routes: [<br>              &#123;<br>                path: <span class="hljs-string">&#x27;/&#x27;</span>,<br>                redirect: <span class="hljs-string">&#x27;/dashboard&#x27;</span>,<br>              &#125;,<br>              &#123;<br>                name: <span class="hljs-string">&#x27;dashboard&#x27;</span>,<br>                path: <span class="hljs-string">&#x27;/dashboard&#x27;</span>,<br>                icon: <span class="hljs-string">&#x27;PieChartOutlined&#x27;</span>,<br>                component: <span class="hljs-string">&#x27;@/pages/DashBoard&#x27;</span>,<br>              &#125;,<br><br>              &#123;<br>                component: <span class="hljs-string">&#x27;./404&#x27;</span>,<br>              &#125;,<br>            ],<br>          &#125;,<br>          &#123;<br>            component: <span class="hljs-string">&#x27;./404&#x27;</span>,<br>          &#125;,<br>        ],<br>      &#125;,<br>    ],<br>  &#125;,<br>  &#123;<br>    component: <span class="hljs-string">&#x27;./404&#x27;</span>,<br>  &#125;,<br>]<br></code></pre></div></td></tr></table></figure>

<h2 id="4-3-统计面板接口文档"><a href="#4-3-统计面板接口文档" class="headerlink" title="4.3 统计面板接口文档"></a>4.3 统计面板接口文档</h2><h5 id="接口描述-3"><a href="#接口描述-3" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>首页统计</li>
</ul>
<h5 id="请求-URL-3"><a href="#请求-URL-3" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/index</li>
</ul>
<h5 id="请求方式-3"><a href="#请求方式-3" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>GET</li>
</ul>
<h5 id="返回参数-2"><a href="#返回参数-2" class="headerlink" title="返回参数"></a>返回参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必含</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>users_count</td>
<td>是</td>
<td>int</td>
<td>用户数量</td>
</tr>
<tr>
<td>goods_count</td>
<td>是</td>
<td>int</td>
<td>商品数量</td>
</tr>
<tr>
<td>order_count</td>
<td>是</td>
<td>int</td>
<td>订单数据</td>
</tr>
</tbody></table>
<h5 id="返回示例-4"><a href="#返回示例-4" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 200 请求成功</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;users_count&quot;</span>: <span class="hljs-number">7</span>,<br>    <span class="hljs-string">&quot;goods_count&quot;</span>: <span class="hljs-number">237</span>,<br>    <span class="hljs-string">&quot;order_count&quot;</span>: <span class="hljs-number">1</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="4-4-添加统计面板接口"><a href="#4-4-添加统计面板接口" class="headerlink" title="4.4 添加统计面板接口"></a>4.4 添加统计面板接口</h2><p>在 src\services\dashboard.js 添加统计面板接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/request&#x27;</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取统计面板数据</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchDashboard</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/admin/index&#x27;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h1 id="五、用户列表"><a href="#五、用户列表" class="headerlink" title="五、用户列表"></a>五、用户列表</h1><h2 id="5-1-用户基本列表"><a href="#5-1-用户基本列表" class="headerlink" title="5.1 用户基本列表"></a>5.1 用户基本列表</h2><h3 id="5-1-1-用户列表接口文档"><a href="#5-1-1-用户列表接口文档" class="headerlink" title="5.1.1 用户列表接口文档"></a>5.1.1 用户列表接口文档</h3><h5 id="接口描述-4"><a href="#接口描述-4" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>用户列表</li>
</ul>
<h5 id="请求-URL-4"><a href="#请求-URL-4" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/users</li>
</ul>
<h5 id="请求方式-4"><a href="#请求方式-4" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>GET</li>
</ul>
<h5 id="请求头部-2"><a href="#请求头部-2" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="Query-请求参数"><a href="#Query-请求参数" class="headerlink" title="Query 请求参数"></a>Query 请求参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>current</td>
<td>否</td>
<td>int</td>
<td>分页-当前页</td>
</tr>
<tr>
<td>name</td>
<td>否</td>
<td>string</td>
<td>姓名模糊搜索</td>
</tr>
<tr>
<td>email</td>
<td>否</td>
<td>string</td>
<td>邮箱匹配搜索</td>
</tr>
<tr>
<td>phone</td>
<td>否</td>
<td>string</td>
<td>手机号匹配搜索</td>
</tr>
</tbody></table>
<h5 id="返回参数-3"><a href="#返回参数-3" class="headerlink" title="返回参数"></a>返回参数</h5><p><strong>data</strong></p>
<table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必含</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>是</td>
<td>int</td>
<td>主键</td>
</tr>
<tr>
<td>name</td>
<td>是</td>
<td>string</td>
<td>昵称</td>
</tr>
<tr>
<td>email</td>
<td>是</td>
<td>string</td>
<td>邮箱</td>
</tr>
<tr>
<td>phone</td>
<td>是</td>
<td>string</td>
<td>手机号</td>
</tr>
<tr>
<td>avatar</td>
<td>是</td>
<td>string</td>
<td>头像</td>
</tr>
<tr>
<td>avatar_url</td>
<td>是</td>
<td>string</td>
<td>头像地址</td>
</tr>
<tr>
<td>is_locked</td>
<td>是</td>
<td>int</td>
<td>是否锁定： 0 正常 1 锁定</td>
</tr>
<tr>
<td>created_at</td>
<td>是</td>
<td>timestamp</td>
<td>创建时间</td>
</tr>
<tr>
<td>updated_at</td>
<td>是</td>
<td>timestamp</td>
<td>更新时间</td>
</tr>
</tbody></table>
<p><strong>meta.pagination</strong></p>
<table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必含</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>total</td>
<td>是</td>
<td>int</td>
<td>数据总数</td>
</tr>
<tr>
<td>count</td>
<td>是</td>
<td>int</td>
<td>当前页数据</td>
</tr>
<tr>
<td>per_page</td>
<td>是</td>
<td>int</td>
<td>每页显示条数</td>
</tr>
<tr>
<td>current_page</td>
<td>是</td>
<td>int</td>
<td>当前页页码</td>
</tr>
<tr>
<td>total_pages</td>
<td>是</td>
<td>int</td>
<td>总页数</td>
</tr>
<tr>
<td>links.previous</td>
<td>是</td>
<td>string</td>
<td>上一页链接</td>
</tr>
<tr>
<td>links.next</td>
<td>是</td>
<td>string</td>
<td>下一页链接</td>
</tr>
</tbody></table>
<h5 id="返回示例-5"><a href="#返回示例-5" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 200 请求成功</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;data&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;超级管理员&quot;</span>,<br>            <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;super@a.com&quot;</span>,<br>            <span class="hljs-string">&quot;phone&quot;</span>: <span class="hljs-literal">null</span>,<br>            <span class="hljs-string">&quot;avatar&quot;</span>: <span class="hljs-literal">null</span>,<br>            <span class="hljs-string">&quot;avatar_url&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>            <span class="hljs-string">&quot;is_locked&quot;</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-string">&quot;created_at&quot;</span>: <span class="hljs-string">&quot;2020-12-22T02:58:08.000000Z&quot;</span>,<br>            <span class="hljs-string">&quot;updated_at&quot;</span>: <span class="hljs-string">&quot;2020-12-24T06:40:44.000000Z&quot;</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">2</span>,<br>            <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;xx&quot;</span>,<br>            <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;12311@qq.com&quot;</span>,<br>            <span class="hljs-string">&quot;phone&quot;</span>: <span class="hljs-literal">null</span>,<br>            <span class="hljs-string">&quot;avatar&quot;</span>: <span class="hljs-literal">null</span>,<br>            <span class="hljs-string">&quot;avatar_url&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>            <span class="hljs-string">&quot;is_locked&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&quot;created_at&quot;</span>: <span class="hljs-string">&quot;2020-12-24T03:47:48.000000Z&quot;</span>,<br>            <span class="hljs-string">&quot;updated_at&quot;</span>: <span class="hljs-string">&quot;2020-12-24T06:44:43.000000Z&quot;</span><br>        &#125;<br>    ],<br>    <span class="hljs-string">&quot;meta&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;pagination&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">7</span>,<br>            <span class="hljs-string">&quot;count&quot;</span>: <span class="hljs-number">2</span>,<br>            <span class="hljs-string">&quot;per_page&quot;</span>: <span class="hljs-number">2</span>,<br>            <span class="hljs-string">&quot;current_page&quot;</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-string">&quot;total_pages&quot;</span>: <span class="hljs-number">4</span>,<br>            <span class="hljs-string">&quot;links&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;previous&quot;</span>: <span class="hljs-literal">null</span>,<br>                <span class="hljs-string">&quot;next&quot;</span>: <span class="hljs-string">&quot;http://shopapi.mamp/api/admin/users?page=2&quot;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="5-1-2-添加用户列表接口"><a href="#5-1-2-添加用户列表接口" class="headerlink" title="5.1.2 添加用户列表接口"></a>5.1.2 添加用户列表接口</h3><p>在 src\services\user.js 中</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/request&#x27;</span><br><br><span class="hljs-comment">// 获取当前登录用户信息</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queryCurrent</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/admin/user&#x27;</span>)<br>&#125;<br><br><span class="hljs-comment">// 获取用户列表</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUsers</span>(<span class="hljs-params">params</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/admin/users&#x27;</span>, &#123; params &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="5-1-3-创建基本的用户列表"><a href="#5-1-3-创建基本的用户列表" class="headerlink" title="5.1.3 创建基本的用户列表"></a>5.1.3 创建基本的用户列表</h3><p><a target="_blank" rel="noopener" href="https://procomponents.ant.design/components/table">ProTable</a>参考文档<br>在\src\pages\User\index.jsx 中新建用户列表文件和文件，创建基本的 table，根据接口文档写需要的字段</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> &#123; PageContainer &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-layout&#x27;</span><br><span class="hljs-keyword">import</span> ProTable <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-table&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Button, Avatar, Switch &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; PlusOutlined, UserOutlined &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/icons&#x27;</span><br><span class="hljs-keyword">import</span> &#123; getUsers &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/user&#x27;</span><br><br><span class="hljs-keyword">const</span> index = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> actionRef = useRef()<br><br>  <span class="hljs-keyword">const</span> columns = [<br>    &#123;<br>      title: <span class="hljs-string">&#x27;头像&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;avatar_url&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;record.avatar_url&#125;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&#123;32&#125;</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">UserOutlined</span> /&gt;</span>&#125; /&gt;</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;姓名&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;name&#x27;</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;邮箱&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;email&#x27;</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;是否禁用&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;is_locked&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> (<br>        &lt;Switch<br>          checkedChildren=<span class="hljs-string">&quot;启用&quot;</span><br>          unCheckedChildren=<span class="hljs-string">&quot;禁用&quot;</span><br>          defaultChecked=&#123;record.is_locked === <span class="hljs-number">0</span>&#125;<br>          onChange=&#123;<span class="hljs-function">() =&gt;</span> &#123;&#125;&#125;<br>        /&gt;<br>      ),<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;created_at&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;操作&#x27;</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;&#125;&#125;&gt;编辑<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span>,<br>    &#125;,<br>  ]<br><br>  <span class="hljs-comment">// 获取用户列表数据</span><br>  <span class="hljs-keyword">const</span> getData = <span class="hljs-keyword">async</span> params =&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> getUsers(params)<br>    <span class="hljs-keyword">return</span> &#123;<br>      data: response.data,<br>      <span class="hljs-comment">// success 请返回 true，</span><br>      <span class="hljs-comment">// 不然 table 会停止解析数据，即使有数据</span><br>      success: <span class="hljs-literal">true</span>,<br>      <span class="hljs-comment">// 不传会使用 data 的长度，如果是分页一定要传</span><br>      total: response.meta.pagination.total,<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;PageContainer&gt;<br>      &lt;ProTable<br>        columns=&#123;columns&#125;<br>        actionRef=&#123;actionRef&#125;<br>        request=&#123;<span class="hljs-keyword">async</span> (params = &#123;&#125;) =&gt; getData(params)&#125;<br>        rowKey=<span class="hljs-string">&quot;id&quot;</span><br>        search=&#123;&#123;<br>          labelWidth: <span class="hljs-string">&#x27;auto&#x27;</span>,<br>        &#125;&#125;<br>        pagination=&#123;&#123;<br>          pageSize: <span class="hljs-number">10</span>,<br>        &#125;&#125;<br>        dateFormatter=<span class="hljs-string">&quot;string&quot;</span><br>        headerTitle=<span class="hljs-string">&quot;用户列表&quot;</span><br>        toolBarRender=&#123;<span class="hljs-function">() =&gt;</span> [<br>          &lt;Button key=<span class="hljs-string">&quot;button&quot;</span> icon=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">PlusOutlined</span> /&gt;</span></span>&#125; type=<span class="hljs-string">&quot;primary&quot;</span>&gt;<br>            新建<br>          &lt;/Button&gt;,<br>        ]&#125;<br>      /&gt;<br>    &lt;/PageContainer&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> index<br></code></pre></div></td></tr></table></figure>

<h2 id="5-2-禁用和启用"><a href="#5-2-禁用和启用" class="headerlink" title="5.2 禁用和启用"></a>5.2 禁用和启用</h2><h3 id="5-2-1-禁启和启用接口文档"><a href="#5-2-1-禁启和启用接口文档" class="headerlink" title="5.2.1 禁启和启用接口文档"></a>5.2.1 禁启和启用接口文档</h3><h5 id="接口描述-5"><a href="#接口描述-5" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>禁用和启用</li>
</ul>
<h5 id="请求-URL-5"><a href="#请求-URL-5" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/users/{user}/lock</li>
</ul>
<h5 id="请求方式-5"><a href="#请求方式-5" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>PATCH</li>
</ul>
<h5 id="请求头部-3"><a href="#请求头部-3" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="RESET-参数"><a href="#RESET-参数" class="headerlink" title="RESET 参数"></a>RESET 参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>user</td>
<td>是</td>
<td>int</td>
<td>用户 id</td>
</tr>
</tbody></table>
<h5 id="返回示例-6"><a href="#返回示例-6" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 204 请求成功</li>
</ul>
<h3 id="5-2-2-添加禁用和启用接口"><a href="#5-2-2-添加禁用和启用接口" class="headerlink" title="5.2.2 添加禁用和启用接口"></a>5.2.2 添加禁用和启用接口</h3><p>在\src\services\user.js 中添加禁启用接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 禁用和启用</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;用户id&#125;</span> <span class="hljs-variable">uid</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lockUser</span>(<span class="hljs-params">uid</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.patch(<span class="hljs-string">`/admin/users/<span class="hljs-subst">$&#123;uid&#125;</span>/lock`</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="5-2-3-添加和启用方法"><a href="#5-2-3-添加和启用方法" class="headerlink" title="5.2.3 添加和启用方法"></a>5.2.3 添加和启用方法</h3><p>在\src\pages\User\index.jsx 中，先导入<code>lockUser</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; getUsers, lockUser &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/user&#x27;</span><br></code></pre></div></td></tr></table></figure>

<p>创建禁启用函数接收用户 id，因为成功后后端返回值是空，所以<code>response.status===undefined</code>判断为空则操作成功</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 禁启用</span><br><span class="hljs-keyword">const</span> heandleLockUser = <span class="hljs-keyword">async</span> uid =&gt; &#123;<br>  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> lockUser(uid)<br>  <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>    message.success(<span class="hljs-string">&#x27;操作成功！&#x27;</span>)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    message.error(<span class="hljs-string">&#x27;操作失败！&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>然后在<code>columns</code>列表中，找到禁启用字段，使用禁启用函数，同时传出<code>record.id</code>用户 id</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    title:<span class="hljs-string">&quot;是否禁用&quot;</span>,<br>    dataIndex:<span class="hljs-string">&quot;is_locked&quot;</span>,<br>    hideInSearch:<span class="hljs-literal">true</span>,<br>    render:<span class="hljs-function">(<span class="hljs-params">_,record</span>)=&gt;</span> <span class="xml">&lt;Switch</span><br><span class="xml">        checkedChildren=&quot;启用&quot;</span><br><span class="xml">        unCheckedChildren=&quot;禁用&quot;</span><br><span class="xml">        defaultChecked=&#123;record.is_locked === 0&#125;</span><br><span class="xml">        onChange=&#123;()=&gt;&#123;heandleLockUser(record.id)&#125;&#125;</span><br><span class="xml">    /&gt;</span><br>&#125;,<br></code></pre></div></td></tr></table></figure>

<h2 id="5-3-添加用户"><a href="#5-3-添加用户" class="headerlink" title="5.3 添加用户"></a>5.3 添加用户</h2><p><a target="_blank" rel="noopener" href="https://ant.design/components/modal-cn/">Modal</a>对话框文档 <a target="_blank" rel="noopener" href="https://procomponents.ant.design/components/form#%E8%A1%A8%E5%8D%95%E8%81%94%E5%8A%A8">ProForm</a>高级表单文档</p>
<h3 id="5-3-1-添加用户接口文档"><a href="#5-3-1-添加用户接口文档" class="headerlink" title="5.3.1 添加用户接口文档"></a>5.3.1 添加用户接口文档</h3><h5 id="接口描述-6"><a href="#接口描述-6" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>添加用户</li>
</ul>
<p><em>注意： 后台 Api 做了 RBAC 权限验证， 新创建的用户无法登陆， 必须为新创建的用户分配响应的角色或权限才可以</em><br><em>注意： 权限管理暂未开放 Api</em></p>
<h5 id="请求-URL-6"><a href="#请求-URL-6" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/users</li>
</ul>
<h5 id="请求方式-6"><a href="#请求方式-6" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>POST</li>
</ul>
<h5 id="请求头部-4"><a href="#请求头部-4" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="Body-请求参数-1"><a href="#Body-请求参数-1" class="headerlink" title="Body 请求参数"></a>Body 请求参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>是</td>
<td>string</td>
<td>昵称</td>
</tr>
<tr>
<td>email</td>
<td>是</td>
<td>string</td>
<td>邮箱</td>
</tr>
<tr>
<td>password</td>
<td>是</td>
<td>string</td>
<td>密码</td>
</tr>
</tbody></table>
<h5 id="返回示例-7"><a href="#返回示例-7" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 201 创建成功</li>
<li>状态码 422 参数错误</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;The given data was invalid.&quot;</span>,<br>    <span class="hljs-string">&quot;errors&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;name&quot;</span>: [<br>            <span class="hljs-string">&quot;昵称 不能为空&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;email&quot;</span>: [<br>            <span class="hljs-string">&quot;邮箱 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;password&quot;</span>: [<br>            <span class="hljs-string">&quot;密码 不能为空。&quot;</span><br>        ]<br>    &#125;,<br>    <span class="hljs-string">&quot;status_code&quot;</span>: <span class="hljs-number">422</span>,<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="5-3-2-添加添加用户接口"><a href="#5-3-2-添加添加用户接口" class="headerlink" title="5.3.2 添加添加用户接口"></a>5.3.2 添加添加用户接口</h3><p>在\src\services\user.js 中<br>这里添加用户接口和获取用户列表是同一个接口<code>/admin/users</code>，但是他们的请求方式不一样，添加用户接口用<code>post</code>，而获取用户列表接口是用默认的<code>get</code>方式。</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 添加用户</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;*&#125;</span> <span class="hljs-variable">params</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addUser</span>(<span class="hljs-params">params</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.post(<span class="hljs-string">&#x27;/admin/users&#x27;</span>, &#123; params &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="5-3-3-封装添加用户模态框"><a href="#5-3-3-封装添加用户模态框" class="headerlink" title="5.3.3 封装添加用户模态框"></a>5.3.3 封装添加用户模态框</h3><h4 id="1-封装添加用户模态框组件Create"><a href="#1-封装添加用户模态框组件Create" class="headerlink" title="1.封装添加用户模态框组件Create"></a>1.封装添加用户模态框组件<code>Create</code></h4><p>在\src\pages\User 文件夹下新建公共文件夹和<code>Create.jsx</code>文件 \src\pages\User\components\Create.jsx<br><code>Create</code>组件在父组件中使用，并用<code>props</code>接收父组件传的方法和实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> ProForm, &#123; ProFormText &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-form&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Modal, message &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; addUser &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/user&#x27;</span><br><br><span class="hljs-keyword">const</span> Create = <span class="hljs-function"><span class="hljs-params">props</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; isModalVisible, isShowModal, actionRef &#125; = props<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 添加用户</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param <span class="hljs-type">&#123;表单数据&#125;</span> <span class="hljs-variable">values</span></span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">const</span> createUser = <span class="hljs-keyword">async</span> values =&gt; &#123;<br>    <span class="hljs-comment">// 发送请求，添加用户</span><br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> addUser(values)<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">&#x27;添加成功！&#x27;</span>)<br>      <span class="hljs-comment">// 刷新表格数据</span><br>      actionRef.current.reload()<br>      <span class="hljs-comment">// 关闭模态框</span><br>      isShowModal(<span class="hljs-literal">false</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;Modal<br>      title=<span class="hljs-string">&quot;添加用户&quot;</span><br>      visible=&#123;isModalVisible&#125;<br>      onCancel=&#123;<span class="hljs-function">() =&gt;</span> isShowModal(<span class="hljs-literal">false</span>)&#125;<br>      footer=&#123;<span class="hljs-literal">null</span>&#125;<br>      destroyOnClose=&#123;<span class="hljs-literal">true</span>&#125;&gt;<br>      &lt;ProForm<br>        onFinish=&#123;<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> &#123;<br>          createUser(values)<br>        &#125;&#125;&gt;<br>        &lt;ProFormText<br>          name=<span class="hljs-string">&quot;name&quot;</span><br>          label=<span class="hljs-string">&quot;昵称&quot;</span><br>          placeholder=<span class="hljs-string">&quot;请输入昵称&quot;</span><br>          rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入昵称&#x27;</span> &#125;]&#125;<br>        /&gt;<br>        &lt;ProFormText<br>          name=<span class="hljs-string">&quot;email&quot;</span><br>          label=<span class="hljs-string">&quot;邮箱&quot;</span><br>          placeholder=<span class="hljs-string">&quot;请输入邮箱&quot;</span><br>          rules=&#123;[<br>            &#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入邮箱&#x27;</span> &#125;,<br>            &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;email&#x27;</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;邮箱格式不正确&#x27;</span> &#125;,<br>          ]&#125;<br>        /&gt;<br>        &lt;ProFormText.Password<br>          name=<span class="hljs-string">&quot;password&quot;</span><br>          label=<span class="hljs-string">&quot;密码&quot;</span><br>          placeholder=<span class="hljs-string">&quot;请输入密码&quot;</span><br>          rules=&#123;[<br>            &#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入密码&#x27;</span> &#125;,<br>            &#123; <span class="hljs-attr">min</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;密码最小6位&#x27;</span> &#125;,<br>          ]&#125;<br>        /&gt;<br>      &lt;/ProForm&gt;<br>    &lt;/Modal&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Create<br></code></pre></div></td></tr></table></figure>

<h4 id="2-调用封装的Create组件"><a href="#2-调用封装的Create组件" class="headerlink" title="2.调用封装的Create组件"></a>2.调用封装的<code>Create</code>组件</h4><p>这里是使用<code>Create</code>组件，并且将方法和实例传给子组件，在父组件里只做简单的显示关闭操作，不做过多的逻辑</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;Create isModalVisible=&#123;isModalVisible&#125; isShowModal=&#123;isShowModal&#125; actionRef=&#123;actionRef&#125; /&gt;<br></code></pre></div></td></tr></table></figure>

<p>在\src\pages\User\index.jsx，在父组件中导入<code>import Create from &#39;./components/Create&#39;;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useRef, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> &#123; PageContainer &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-layout&#x27;</span><br><span class="hljs-keyword">import</span> ProTable <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-table&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Button, Avatar, Switch, message &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; PlusOutlined, UserOutlined &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/icons&#x27;</span><br><span class="hljs-keyword">import</span> &#123; getUsers, lockUser &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/user&#x27;</span><br><span class="hljs-keyword">import</span> Create <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./components/Create&#x27;</span><br><br><span class="hljs-keyword">const</span> index = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> [isModalVisible, setisModalVisible] = useState(<span class="hljs-literal">false</span>)<br><br>  <span class="hljs-comment">// 表格的ref，便于操作自定义操作表格</span><br>  <span class="hljs-keyword">const</span> actionRef = useRef()<br><br>  <span class="hljs-comment">// 获取用户列表数据</span><br>  <span class="hljs-keyword">const</span> getData = <span class="hljs-keyword">async</span> params =&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> getUsers(params)<br>    <span class="hljs-keyword">return</span> &#123;<br>      data: response.data,<br>      <span class="hljs-comment">// success 请返回 true，</span><br>      <span class="hljs-comment">// 不然 table 会停止解析数据，即使有数据</span><br>      success: <span class="hljs-literal">true</span>,<br>      <span class="hljs-comment">// 不传会使用 data 的长度，如果是分页一定要传</span><br>      total: response.meta.pagination.total,<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 禁启用</span><br>  <span class="hljs-keyword">const</span> heandleLockUser = <span class="hljs-keyword">async</span> uid =&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> lockUser(uid)<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">&#x27;操作成功！&#x27;</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 控制新建用户模态框显示和隐藏</span><br>  <span class="hljs-keyword">const</span> isShowModal = <span class="hljs-function"><span class="hljs-params">show</span> =&gt;</span> &#123;<br>    setisModalVisible(show)<br>  &#125;<br><br>  <span class="hljs-keyword">const</span> columns = [<br>    &#123;<br>      title: <span class="hljs-string">&#x27;头像&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;avatar_url&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;record.avatar_url&#125;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&#123;32&#125;</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">UserOutlined</span> /&gt;</span>&#125; /&gt;</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;姓名&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;name&#x27;</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;邮箱&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;email&#x27;</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;是否禁用&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;is_locked&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> (<br>        &lt;Switch<br>          checkedChildren=<span class="hljs-string">&quot;启用&quot;</span><br>          unCheckedChildren=<span class="hljs-string">&quot;禁用&quot;</span><br>          defaultChecked=&#123;record.is_locked === <span class="hljs-number">0</span>&#125;<br>          onChange=&#123;<span class="hljs-function">() =&gt;</span> &#123;<br>            heandleLockUser(record.id)<br>          &#125;&#125;<br>        /&gt;<br>      ),<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;created_at&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;操作&#x27;</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;&#125;&#125;&gt;编辑<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span>,<br>    &#125;,<br>  ]<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;PageContainer&gt;<br>      &lt;ProTable<br>        columns=&#123;columns&#125;<br>        actionRef=&#123;actionRef&#125;<br>        request=&#123;<span class="hljs-keyword">async</span> (params = &#123;&#125;) =&gt; getData(params)&#125;<br>        rowKey=<span class="hljs-string">&quot;id&quot;</span><br>        search=&#123;&#123;<br>          labelWidth: <span class="hljs-string">&#x27;auto&#x27;</span>,<br>        &#125;&#125;<br>        pagination=&#123;&#123;<br>          pageSize: <span class="hljs-number">10</span>,<br>        &#125;&#125;<br>        dateFormatter=<span class="hljs-string">&quot;string&quot;</span><br>        headerTitle=<span class="hljs-string">&quot;用户列表&quot;</span><br>        toolBarRender=&#123;<span class="hljs-function">() =&gt;</span> [<br>          &lt;Button<br>            key=<span class="hljs-string">&quot;button&quot;</span><br>            icon=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">PlusOutlined</span> /&gt;</span></span>&#125;<br>            type=<span class="hljs-string">&quot;primary&quot;</span><br>            onClick=&#123;<span class="hljs-function">() =&gt;</span> isShowModal(<span class="hljs-literal">true</span>)&#125;&gt;<br>            新建<br>          &lt;/Button&gt;,<br>        ]&#125;<br>      /&gt;<br>      &lt;Create isModalVisible=&#123;isModalVisible&#125; isShowModal=&#123;isShowModal&#125; actionRef=&#123;actionRef&#125; /&gt;<br>    &lt;/PageContainer&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> index<br></code></pre></div></td></tr></table></figure>

<h2 id="5-4-编辑用户"><a href="#5-4-编辑用户" class="headerlink" title="5.4 编辑用户"></a>5.4 编辑用户</h2><h3 id="5-4-1-更新用户信息和用户详情接口文档"><a href="#5-4-1-更新用户信息和用户详情接口文档" class="headerlink" title="5.4.1 更新用户信息和用户详情接口文档"></a>5.4.1 更新用户信息和用户详情接口文档</h3><h5 id="接口描述-7"><a href="#接口描述-7" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>更新用户信息</li>
</ul>
<h5 id="请求-URL-7"><a href="#请求-URL-7" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/users/{users}</li>
</ul>
<h5 id="请求方式-7"><a href="#请求方式-7" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>PUT</li>
</ul>
<h5 id="REST-请求参数"><a href="#REST-请求参数" class="headerlink" title="REST 请求参数"></a>REST 请求参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>users</td>
<td>是</td>
<td>int</td>
<td>用户 id</td>
</tr>
</tbody></table>
<h5 id="Body-请求参数-2"><a href="#Body-请求参数-2" class="headerlink" title="Body 请求参数"></a>Body 请求参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>是</td>
<td>string</td>
<td>昵称</td>
</tr>
<tr>
<td>email</td>
<td>是</td>
<td>string</td>
<td>邮箱</td>
</tr>
</tbody></table>
<h5 id="返回示例-8"><a href="#返回示例-8" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 201 创建成功</li>
<li>状态码 422 参数错误</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;The given data was invalid.&quot;</span>,<br>    <span class="hljs-string">&quot;errors&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;name&quot;</span>: [<br>            <span class="hljs-string">&quot;昵称 不能为空&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;email&quot;</span>: [<br>            <span class="hljs-string">&quot;邮箱 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;password&quot;</span>: [<br>            <span class="hljs-string">&quot;密码 不能为空。&quot;</span><br>        ]<br>    &#125;,<br>    <span class="hljs-string">&quot;status_code&quot;</span>: <span class="hljs-number">422</span>,<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h5 id="接口描述-8"><a href="#接口描述-8" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>用户详情</li>
</ul>
<h5 id="请求-URL-8"><a href="#请求-URL-8" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/users/{user}</li>
</ul>
<h5 id="请求方式-8"><a href="#请求方式-8" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>GET</li>
</ul>
<h5 id="请求头部-5"><a href="#请求头部-5" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="RESET-参数-1"><a href="#RESET-参数-1" class="headerlink" title="RESET 参数"></a>RESET 参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>user</td>
<td>是</td>
<td>string</td>
<td>用户 id</td>
</tr>
</tbody></table>
<h5 id="返回参数-4"><a href="#返回参数-4" class="headerlink" title="返回参数"></a>返回参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必含</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>是</td>
<td>int</td>
<td>主键</td>
</tr>
<tr>
<td>name</td>
<td>是</td>
<td>string</td>
<td>昵称</td>
</tr>
<tr>
<td>email</td>
<td>是</td>
<td>string</td>
<td>邮箱</td>
</tr>
<tr>
<td>phone</td>
<td>是</td>
<td>string</td>
<td>手机号</td>
</tr>
<tr>
<td>avatar</td>
<td>是</td>
<td>string</td>
<td>头像</td>
</tr>
<tr>
<td>avatar_url</td>
<td>是</td>
<td>string</td>
<td>头像地址</td>
</tr>
<tr>
<td>is_locked</td>
<td>是</td>
<td>int</td>
<td>是否锁定： 0 正常 1 锁定</td>
</tr>
<tr>
<td>created_at</td>
<td>是</td>
<td>timestamp</td>
<td>创建时间</td>
</tr>
<tr>
<td>updated_at</td>
<td>是</td>
<td>timestamp</td>
<td>更新时间</td>
</tr>
</tbody></table>
<h5 id="返回示例-9"><a href="#返回示例-9" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 200 请求成功</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;超级管理员&quot;</span>,<br>    <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;super@a.com&quot;</span>,<br>    <span class="hljs-string">&quot;phone&quot;</span>: <span class="hljs-literal">null</span>,<br>    <span class="hljs-string">&quot;avatar&quot;</span>: <span class="hljs-literal">null</span>,<br>    <span class="hljs-string">&quot;avatar_url&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;is_locked&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-string">&quot;created_at&quot;</span>: <span class="hljs-string">&quot;2020-12-22T02:58:08.000000Z&quot;</span>,<br>    <span class="hljs-string">&quot;updated_at&quot;</span>: <span class="hljs-string">&quot;2020-12-22T04:32:27.000000Z&quot;</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="5-4-2-添加更新用户信息和用户详情接口"><a href="#5-4-2-添加更新用户信息和用户详情接口" class="headerlink" title="5.4.2 添加更新用户信息和用户详情接口"></a>5.4.2 添加更新用户信息和用户详情接口</h3><p>在\src\services\user.js 中添加更新用户和用户详情接口，虽然这两个接口请求是同一个，但是他们的传参方式和参数是不一样的。<br><code>updateUser</code>是<code>put</code>方法，用于更新数据，需要传编辑的用户 id 和修改的参数，<br><code>showUser</code>是<code>get</code>方法，用于设置编辑栏上的默认值，只需要传编辑用户 id，后端返回改用户具体参数</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 更新用户</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;*&#125;</span> <span class="hljs-variable">params</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateUser</span>(<span class="hljs-params">editId, params</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.put(<span class="hljs-string">`/admin/users/<span class="hljs-subst">$&#123;editId&#125;</span>`</span>, &#123; params &#125;)<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用户详情</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;*&#125;</span> <span class="hljs-variable">editId</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showUser</span>(<span class="hljs-params">editId</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">`/admin/users/<span class="hljs-subst">$&#123;editId&#125;</span>`</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="5-4-3-封装编辑用户模态框"><a href="#5-4-3-封装编辑用户模态框" class="headerlink" title="5.4.3 封装编辑用户模态框"></a>5.4.3 封装编辑用户模态框</h3><h4 id="1-封装编辑模态框组件-Edit"><a href="#1-封装编辑模态框组件-Edit" class="headerlink" title="1.封装编辑模态框组件 Edit"></a>1.封装编辑模态框组件 Edit</h4><p>在\src\pages\User\components 文件夹下创建编辑用户组件<code>Edit.jsx</code>，先导入接口请求方法<code>import &#123; showUser, updateUser &#125; from &#39;@/services/user&#39;;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useEffect, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> ProForm, &#123; ProFormText &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-form&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Modal, message, Skeleton &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; showUser, updateUser &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/user&#x27;</span><br><br><span class="hljs-keyword">const</span> Edit = <span class="hljs-function"><span class="hljs-params">props</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; isModalVisible, isShowModal, actionRef, editId &#125; = props<br>  <span class="hljs-keyword">const</span> [initialValues, setinitialValues] = useState(<span class="hljs-literal">undefined</span>)<br><br>  useEffect(<span class="hljs-keyword">async</span> () =&gt; &#123;<br>    <span class="hljs-comment">// 发送请求，获取用户详情</span><br>    <span class="hljs-keyword">if</span> (editId !== <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> showUser(editId)<br>      setinitialValues(&#123;<br>        name: response.name,<br>        email: response.email,<br>      &#125;)<br>    &#125;<br>  &#125;, [])<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 添加用户</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param <span class="hljs-type">&#123;表单数据&#125;</span> <span class="hljs-variable">values</span></span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">const</span> editUser = <span class="hljs-keyword">async</span> values =&gt; &#123;<br>    <span class="hljs-comment">// 发送请求，更新用户</span><br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> updateUser(editId, values)<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">&#x27;更新成功！&#x27;</span>)<br>      <span class="hljs-comment">// 刷新表格数据</span><br>      actionRef.current.reload()<br>      <span class="hljs-comment">// 关闭模态框</span><br>      isShowModal(<span class="hljs-literal">false</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;Modal<br>      title=<span class="hljs-string">&quot;编辑用户&quot;</span><br>      visible=&#123;isModalVisible&#125;<br>      onCancel=&#123;<span class="hljs-function">() =&gt;</span> isShowModal(<span class="hljs-literal">false</span>)&#125;<br>      footer=&#123;<span class="hljs-literal">null</span>&#125;<br>      destroyOnClose=&#123;<span class="hljs-literal">true</span>&#125;&gt;<br>      &#123;initialValues === <span class="hljs-literal">undefined</span> ? (<br>        &lt;Skeleton active=&#123;<span class="hljs-literal">true</span>&#125; paragraph=&#123;&#123; <span class="hljs-attr">rows</span>: <span class="hljs-number">4</span> &#125;&#125; /&gt;<br>      ) : (<br>        &lt;ProForm<br>          initialValues=&#123;initialValues&#125;<br>          onFinish=&#123;<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> &#123;<br>            editUser(values)<br>          &#125;&#125;&gt;<br>          &lt;ProFormText<br>            name=<span class="hljs-string">&quot;name&quot;</span><br>            label=<span class="hljs-string">&quot;昵称&quot;</span><br>            placeholder=<span class="hljs-string">&quot;请输入昵称&quot;</span><br>            rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入昵称&#x27;</span> &#125;]&#125;<br>          /&gt;<br>          &lt;ProFormText<br>            name=<span class="hljs-string">&quot;email&quot;</span><br>            label=<span class="hljs-string">&quot;邮箱&quot;</span><br>            placeholder=<span class="hljs-string">&quot;请输入邮箱&quot;</span><br>            rules=&#123;[<br>              &#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入邮箱&#x27;</span> &#125;,<br>              &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;email&#x27;</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;邮箱格式不正确&#x27;</span> &#125;,<br>            ]&#125;<br>          /&gt;<br>        &lt;/ProForm&gt;<br>      )&#125;<br>    &lt;/Modal&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Edit<br></code></pre></div></td></tr></table></figure>

<p>其中加入了<code>antd</code>的骨架框，原因是页面渲染比接口请求快，在获取用户详情之前页面就渲染完了，导致编辑栏上没有得到该被编辑用户的数据，加入骨架框起到缓冲作用。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1621443253764-18ae7b8e-90db-433d-8917-67c3ad549ba2.png#clientId=u76ffcb00-d6fc-4&from=paste&height=292&id=fwwDs&margin=%5Bobject%20Object%5D&name=image.png&originHeight=292&originWidth=527&originalType=binary&size=15903&status=done&style=none&taskId=ub7c5cca0-015f-4df4-991d-46b3a3aed8a&width=527" srcset="/img/loading.gif" lazyload alt="image.png"><br>同时给骨架框和编辑表单添加了三元运算符，避免两个同时被渲染，判断接口请求接收到用户详情之后骨架框消失，编辑表单出现。一下是主要代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> [initialValues, setinitialValues] = useState(<span class="hljs-literal">undefined</span>)<br><br>useEffect(<span class="hljs-keyword">async</span> () =&gt; &#123;<br>  <span class="hljs-comment">// 发送请求，获取用户详情</span><br>  <span class="hljs-keyword">if</span> (editId !== <span class="hljs-literal">undefined</span>) &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> showUser(editId)<br>    setinitialValues(&#123;<br>      name: response.name,<br>      email: response.email,<br>    &#125;)<br>  &#125;<br>&#125;, [])<br></code></pre></div></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>  initialValues === <span class="hljs-literal">undefined</span> ? (<br>    &lt;Skeleton active=&#123;<span class="hljs-literal">true</span>&#125; paragraph=&#123;&#123; <span class="hljs-attr">rows</span>: <span class="hljs-number">4</span> &#125;&#125; /&gt;<br>  ) : (<br>    &lt;ProForm<br>      initialValues=&#123;initialValues&#125;<br>      onFinish=&#123;<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> &#123;<br>        editUser(values)<br>      &#125;&#125;&gt;<br>      &lt;ProFormText<br>        name=<span class="hljs-string">&quot;name&quot;</span><br>        label=<span class="hljs-string">&quot;昵称&quot;</span><br>        placeholder=<span class="hljs-string">&quot;请输入昵称&quot;</span><br>        rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入昵称&#x27;</span> &#125;]&#125;<br>      /&gt;<br>      &lt;ProFormText<br>        name=<span class="hljs-string">&quot;email&quot;</span><br>        label=<span class="hljs-string">&quot;邮箱&quot;</span><br>        placeholder=<span class="hljs-string">&quot;请输入邮箱&quot;</span><br>        rules=&#123;[<br>          &#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入邮箱&#x27;</span> &#125;,<br>          &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;email&#x27;</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;邮箱格式不正确&#x27;</span> &#125;,<br>        ]&#125;<br>      /&gt;<br>    &lt;/ProForm&gt;<br>  )<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="2-调用封装的Edit组件"><a href="#2-调用封装的Edit组件" class="headerlink" title="2.调用封装的Edit组件"></a>2.调用封装的<code>Edit</code>组件</h4><p>在\src\pages\User\index.jsx 中，导入编辑组件<code>import Edit from &#39;./components/Edit&#39;;</code><br>调用了<code>Edit</code>组件并且多传一个被编辑用户 id <code>editId=&#123;editId&#125;</code>给子组件</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useRef, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> &#123; PageContainer &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-layout&#x27;</span><br><span class="hljs-keyword">import</span> ProTable <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-table&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Button, Avatar, Switch, message &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; PlusOutlined, UserOutlined &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/icons&#x27;</span><br><span class="hljs-keyword">import</span> &#123; getUsers, lockUser &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/user&#x27;</span><br><span class="hljs-keyword">import</span> Create <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./components/Create&#x27;</span><br><span class="hljs-keyword">import</span> Edit <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./components/Edit&#x27;</span><br><br><span class="hljs-keyword">const</span> index = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> [isModalVisible, setisModalVisible] = useState(<span class="hljs-literal">false</span>)<br>  <span class="hljs-keyword">const</span> [isModalVisibleEdit, setisModalVisibleEdit] = useState(<span class="hljs-literal">false</span>)<br>  <span class="hljs-keyword">const</span> [editId, setEditId] = useState(<span class="hljs-literal">undefined</span>)<br><br>  <span class="hljs-comment">// 表格的ref，便于操作自定义操作表格</span><br>  <span class="hljs-keyword">const</span> actionRef = useRef()<br><br>  <span class="hljs-comment">// 获取用户列表数据</span><br>  <span class="hljs-keyword">const</span> getData = <span class="hljs-keyword">async</span> params =&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> getUsers(params)<br>    <span class="hljs-keyword">return</span> &#123;<br>      data: response.data,<br>      <span class="hljs-comment">// success 请返回 true，</span><br>      <span class="hljs-comment">// 不然 table 会停止解析数据，即使有数据</span><br>      success: <span class="hljs-literal">true</span>,<br>      <span class="hljs-comment">// 不传会使用 data 的长度，如果是分页一定要传</span><br>      total: response.meta.pagination.total,<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 禁启用</span><br>  <span class="hljs-keyword">const</span> heandleLockUser = <span class="hljs-keyword">async</span> uid =&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> lockUser(uid)<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">&#x27;操作成功！&#x27;</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 控制新建用户模态框显示和隐藏</span><br>  <span class="hljs-keyword">const</span> isShowModal = <span class="hljs-function"><span class="hljs-params">show</span> =&gt;</span> &#123;<br>    setisModalVisible(show)<br>  &#125;<br><br>  <span class="hljs-comment">// 控制编辑用户模态框显示和隐藏</span><br>  <span class="hljs-keyword">const</span> isShowModalEdit = <span class="hljs-function">(<span class="hljs-params">show, id</span>) =&gt;</span> &#123;<br>    setisModalVisibleEdit(show)<br>    setEditId(id)<br>  &#125;<br><br>  <span class="hljs-keyword">const</span> columns = [<br>    &#123;<br>      title: <span class="hljs-string">&#x27;头像&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;avatar_url&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;record.avatar_url&#125;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&#123;32&#125;</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">UserOutlined</span> /&gt;</span>&#125; /&gt;</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;姓名&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;name&#x27;</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;邮箱&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;email&#x27;</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;是否禁用&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;is_locked&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> (<br>        &lt;Switch<br>          checkedChildren=<span class="hljs-string">&quot;启用&quot;</span><br>          unCheckedChildren=<span class="hljs-string">&quot;禁用&quot;</span><br>          defaultChecked=&#123;record.is_locked === <span class="hljs-number">0</span>&#125;<br>          onChange=&#123;<span class="hljs-function">() =&gt;</span> &#123;<br>            heandleLockUser(record.id)<br>          &#125;&#125;<br>        /&gt;<br>      ),<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;created_at&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;操作&#x27;</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> isShowModalEdit(true, record.id)&#125;&gt;编辑<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span>,<br>    &#125;,<br>  ]<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;PageContainer&gt;<br>      &lt;ProTable<br>        columns=&#123;columns&#125;<br>        actionRef=&#123;actionRef&#125;<br>        request=&#123;<span class="hljs-keyword">async</span> (params = &#123;&#125;) =&gt; getData(params)&#125;<br>        rowKey=<span class="hljs-string">&quot;id&quot;</span><br>        search=&#123;&#123;<br>          labelWidth: <span class="hljs-string">&#x27;auto&#x27;</span>,<br>        &#125;&#125;<br>        pagination=&#123;&#123;<br>          pageSize: <span class="hljs-number">10</span>,<br>        &#125;&#125;<br>        dateFormatter=<span class="hljs-string">&quot;string&quot;</span><br>        headerTitle=<span class="hljs-string">&quot;用户列表&quot;</span><br>        toolBarRender=&#123;<span class="hljs-function">() =&gt;</span> [<br>          &lt;Button<br>            key=<span class="hljs-string">&quot;button&quot;</span><br>            icon=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">PlusOutlined</span> /&gt;</span></span>&#125;<br>            type=<span class="hljs-string">&quot;primary&quot;</span><br>            onClick=&#123;<span class="hljs-function">() =&gt;</span> isShowModal(<span class="hljs-literal">true</span>)&#125;&gt;<br>            新建<br>          &lt;/Button&gt;,<br>        ]&#125;<br>      /&gt;<br>      &lt;Create isModalVisible=&#123;isModalVisible&#125; isShowModal=&#123;isShowModal&#125; actionRef=&#123;actionRef&#125; /&gt;<br><br>      &#123;!isModalVisibleEdit ? (<br>        <span class="hljs-string">&#x27;&#x27;</span><br>      ) : (<br>        &lt;Edit<br>          isModalVisible=&#123;isModalVisibleEdit&#125;<br>          isShowModal=&#123;isShowModalEdit&#125;<br>          actionRef=&#123;actionRef&#125;<br>          editId=&#123;editId&#125;<br>        /&gt;<br>      )&#125;<br>    &lt;/PageContainer&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> index<br></code></pre></div></td></tr></table></figure>

<p>其中关键代码<br>这里设置了编辑模态框的打开或者关闭，并且设置被编辑用户 id，传给<code>Edit</code>子组件</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> [isModalVisibleEdit, setisModalVisibleEdit] = useState(<span class="hljs-literal">false</span>);<br><span class="hljs-keyword">const</span> [editId, setEditId] = useState(<span class="hljs-literal">undefined</span>);<br><br><br><br><span class="hljs-comment">// 控制编辑用户模态框显示和隐藏</span><br><span class="hljs-keyword">const</span> isShowModalEdit = <span class="hljs-function">(<span class="hljs-params">show, id</span>) =&gt;</span> &#123;<br>  setisModalVisibleEdit(show);<br>  setEditId(id);<br>&#125;;<br><br><br><br>  &#123;<br>    title: <span class="hljs-string">&#x27;操作&#x27;</span>,<br>    render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> isShowModalEdit(true, record.id)&#125;&gt;编辑<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span>,<br>  &#125;,<br></code></pre></div></td></tr></table></figure>

<p>这里也设置了三目运算，主要原因是因为每次编辑都会有不同的用户 id，在编辑组件时挂载时，触发<code>Edit</code>子组件的生命周期请求用户 id，编辑组件关闭时卸载生命周期</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">//关键代码,  isModalVisibleEdit编辑模态框显示时，挂载生命周期获取用户详情，编辑模态框关闭时卸载生命周期函数</span><br>useEffect(<span class="hljs-keyword">async</span> () =&gt; &#123;<br>  <span class="hljs-comment">// 发送请求，获取用户详情</span><br>  <span class="hljs-keyword">if</span> (editId !== <span class="hljs-literal">undefined</span>) &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> showUser(editId)<br>    setinitialValues(&#123;<br>      name: response.name,<br>      email: response.email,<br>    &#125;)<br>  &#125;<br>&#125;, [])<br><br>&#123;<br>  !isModalVisibleEdit ? (<br>    <span class="hljs-string">&#x27;&#x27;</span><br>  ) : (<br>    &lt;Edit<br>      isModalVisible=&#123;isModalVisibleEdit&#125;<br>      isShowModal=&#123;isShowModalEdit&#125;<br>      actionRef=&#123;actionRef&#125;<br>      editId=&#123;editId&#125;<br>    /&gt;<br>  )<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="5-5-封装编辑和添加用户"><a href="#5-5-封装编辑和添加用户" class="headerlink" title="5.5 封装编辑和添加用户"></a>5.5 封装编辑和添加用户</h2><p>1.在\src\pages\User\components 文件夹中，复制<code>Edit.jsx</code>并重命名<code>CreateOrEdit.jsx</code>，将<code>Create</code>组件和<code>Edit</code>组件合并在一起，通过有<code>editId</code>判断是编辑。</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useEffect, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> ProForm, &#123; ProFormText &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-form&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Modal, message, Skeleton &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; showUser, updateUser, addUser &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/user&#x27;</span><br><br><span class="hljs-keyword">const</span> CreateOrEdit = <span class="hljs-function"><span class="hljs-params">props</span> =&gt;</span> &#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * isModalVisible 模态框是否显示</span><br><span class="hljs-comment">   * isShowModal 操作模态框显示隐藏的方法</span><br><span class="hljs-comment">   * actionRef 父组件传来的表格的引用，可以用来操作表格，比如刷新表单</span><br><span class="hljs-comment">   * editId 要编辑的id，添加的时候是undefined，只有编辑时才有</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">const</span> &#123; isModalVisible, isShowModal, actionRef, editId &#125; = props<br><br>  <span class="hljs-comment">// 将表单初始化的值设置成状态，在编辑的时候使用这个状态</span><br>  <span class="hljs-keyword">const</span> [initialValues, setinitialValues] = useState(<span class="hljs-literal">undefined</span>)<br><br>  <span class="hljs-comment">// 添加或者编辑的描述</span><br>  <span class="hljs-keyword">const</span> type = editId === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">&#x27;添加&#x27;</span> : <span class="hljs-string">&#x27;编辑&#x27;</span><br><br>  useEffect(<span class="hljs-keyword">async</span> () =&gt; &#123;<br>    <span class="hljs-comment">// 发送请求，获取用户详情</span><br>    <span class="hljs-keyword">if</span> (editId !== <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> showUser(editId)<br>      <span class="hljs-comment">// 获取数据之后,修改状态；状态改变，组件重新渲染，骨架框消失，编辑表单出现</span><br>      setinitialValues(&#123;<br>        name: response.name,<br>        email: response.email,<br>      &#125;)<br>    &#125;<br>  &#125;, [])<br><br>  <span class="hljs-comment">// 提交表单，执行编辑或者添加</span><br>  <span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-keyword">async</span> values =&gt; &#123;<br>    <span class="hljs-keyword">let</span> response = []<br>    <span class="hljs-keyword">if</span> (editId === <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-comment">// 执行添加</span><br>      <span class="hljs-comment">// 发送请求，添加用户</span><br>      response = <span class="hljs-keyword">await</span> addUser(values)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 执行编辑</span><br>      <span class="hljs-comment">// 发送请求，更新用户</span><br>      response = <span class="hljs-keyword">await</span> updateUser(editId, values)<br>    &#125;<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>成功！`</span>)<br>      <span class="hljs-comment">// 刷新表格数据</span><br>      actionRef.current.reload()<br>      <span class="hljs-comment">// 关闭模态框</span><br>      isShowModal(<span class="hljs-literal">false</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;Modal<br>      title=&#123;<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>用户`</span>&#125;<br>      visible=&#123;isModalVisible&#125;<br>      onCancel=&#123;<span class="hljs-function">() =&gt;</span> isShowModal(<span class="hljs-literal">false</span>)&#125;<br>      footer=&#123;<span class="hljs-literal">null</span>&#125;<br>      destroyOnClose=&#123;<span class="hljs-literal">true</span>&#125;&gt;<br>      &#123;<br>        <span class="hljs-comment">// 只有是编辑的情况下，并且要显示的数据还有返回，才显示骨架框</span><br>        initialValues === <span class="hljs-literal">undefined</span> &amp;&amp; editId !== <span class="hljs-literal">undefined</span> ? (<br>          &lt;Skeleton active=&#123;<span class="hljs-literal">true</span>&#125; paragraph=&#123;&#123; <span class="hljs-attr">rows</span>: <span class="hljs-number">4</span> &#125;&#125; /&gt;<br>        ) : (<br>          &lt;ProForm<br>            initialValues=&#123;initialValues&#125;<br>            onFinish=&#123;<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> &#123;<br>              handleSubmit(values)<br>            &#125;&#125;&gt;<br>            &lt;ProFormText<br>              name=<span class="hljs-string">&quot;name&quot;</span><br>              label=<span class="hljs-string">&quot;昵称&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入昵称&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入昵称&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormText<br>              name=<span class="hljs-string">&quot;email&quot;</span><br>              label=<span class="hljs-string">&quot;邮箱&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入邮箱&quot;</span><br>              rules=&#123;[<br>                &#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入邮箱&#x27;</span> &#125;,<br>                &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;email&#x27;</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;邮箱格式不正确&#x27;</span> &#125;,<br>              ]&#125;<br>            /&gt;<br>            &#123;<br>              <span class="hljs-comment">// 只有添加用户才有密码框</span><br>              editId !== <span class="hljs-literal">undefined</span> ? (<br>                <span class="hljs-string">&#x27;&#x27;</span><br>              ) : (<br>                &lt;ProFormText.Password<br>                  name=<span class="hljs-string">&quot;password&quot;</span><br>                  label=<span class="hljs-string">&quot;密码&quot;</span><br>                  placeholder=<span class="hljs-string">&quot;请输入密码&quot;</span><br>                  rules=&#123;[<br>                    &#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入密码&#x27;</span> &#125;,<br>                    &#123; <span class="hljs-attr">min</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;密码最小6位&#x27;</span> &#125;,<br>                  ]&#125;<br>                /&gt;<br>              )<br>            &#125;<br>          &lt;/ProForm&gt;<br>        )<br>      &#125;<br>    &lt;/Modal&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> CreateOrEdit<br></code></pre></div></td></tr></table></figure>

<p>2.在\src\pages\User\index.jsx 中导入<code>import CreateOrEdit from &#39;./components/CreateOrEdit&#39;;``CreateOrEdit</code>组件，将编辑和添加用户的方法改成相同的，并用过是否有<code>editId</code>来判断是编辑（有 id 是编辑）还是添加。最后删除掉\src\pages\User\components 文件夹中的<code>Create.jsx</code>和<code>Edit.jsx</code>文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useRef, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> &#123; PageContainer &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-layout&#x27;</span><br><span class="hljs-keyword">import</span> ProTable <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-table&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Button, Avatar, Switch, message &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; PlusOutlined, UserOutlined &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/icons&#x27;</span><br><span class="hljs-keyword">import</span> &#123; getUsers, lockUser &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/user&#x27;</span><br><span class="hljs-keyword">import</span> CreateOrEdit <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./components/CreateOrEdit&#x27;</span><br><br><span class="hljs-keyword">const</span> index = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> [isModalVisible, setisModalVisible] = useState(<span class="hljs-literal">false</span>)<br>  <span class="hljs-keyword">const</span> [editId, setEditId] = useState(<span class="hljs-literal">undefined</span>)<br><br>  <span class="hljs-comment">// 表格的ref，便于操作自定义操作表格</span><br>  <span class="hljs-keyword">const</span> actionRef = useRef()<br><br>  <span class="hljs-comment">// 获取用户列表数据</span><br>  <span class="hljs-keyword">const</span> getData = <span class="hljs-keyword">async</span> params =&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> getUsers(params)<br>    <span class="hljs-keyword">return</span> &#123;<br>      data: response.data,<br>      <span class="hljs-comment">// success 请返回 true，</span><br>      <span class="hljs-comment">// 不然 table 会停止解析数据，即使有数据</span><br>      success: <span class="hljs-literal">true</span>,<br>      <span class="hljs-comment">// 不传会使用 data 的长度，如果是分页一定要传</span><br>      total: response.meta.pagination.total,<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 禁启用</span><br>  <span class="hljs-keyword">const</span> heandleLockUser = <span class="hljs-keyword">async</span> uid =&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> lockUser(uid)<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">&#x27;操作成功！&#x27;</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 控制新建/添加用户模态框显示和隐藏</span><br>  <span class="hljs-keyword">const</span> isShowModal = <span class="hljs-function">(<span class="hljs-params">show, id = <span class="hljs-literal">undefined</span></span>) =&gt;</span> &#123;<br>    setEditId(id)<br>    setisModalVisible(show)<br>  &#125;<br><br>  <span class="hljs-keyword">const</span> columns = [<br>    &#123;<br>      title: <span class="hljs-string">&#x27;头像&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;avatar_url&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;record.avatar_url&#125;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&#123;32&#125;</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">UserOutlined</span> /&gt;</span>&#125; /&gt;</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;姓名&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;name&#x27;</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;邮箱&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;email&#x27;</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;是否禁用&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;is_locked&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> (<br>        &lt;Switch<br>          checkedChildren=<span class="hljs-string">&quot;启用&quot;</span><br>          unCheckedChildren=<span class="hljs-string">&quot;禁用&quot;</span><br>          defaultChecked=&#123;record.is_locked === <span class="hljs-number">0</span>&#125;<br>          onChange=&#123;<span class="hljs-function">() =&gt;</span> &#123;<br>            heandleLockUser(record.id)<br>          &#125;&#125;<br>        /&gt;<br>      ),<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;created_at&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;操作&#x27;</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> isShowModal(true, record.id)&#125;&gt;编辑<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span>,<br>    &#125;,<br>  ]<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;PageContainer&gt;<br>      &lt;ProTable<br>        columns=&#123;columns&#125;<br>        actionRef=&#123;actionRef&#125;<br>        request=&#123;<span class="hljs-keyword">async</span> (params = &#123;&#125;) =&gt; getData(params)&#125;<br>        rowKey=<span class="hljs-string">&quot;id&quot;</span><br>        search=&#123;&#123;<br>          labelWidth: <span class="hljs-string">&#x27;auto&#x27;</span>,<br>        &#125;&#125;<br>        pagination=&#123;&#123;<br>          pageSize: <span class="hljs-number">10</span>,<br>        &#125;&#125;<br>        dateFormatter=<span class="hljs-string">&quot;string&quot;</span><br>        headerTitle=<span class="hljs-string">&quot;用户列表&quot;</span><br>        toolBarRender=&#123;<span class="hljs-function">() =&gt;</span> [<br>          &lt;Button<br>            key=<span class="hljs-string">&quot;button&quot;</span><br>            icon=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">PlusOutlined</span> /&gt;</span></span>&#125;<br>            type=<span class="hljs-string">&quot;primary&quot;</span><br>            onClick=&#123;<span class="hljs-function">() =&gt;</span> isShowModal(<span class="hljs-literal">true</span>)&#125;&gt;<br>            新建<br>          &lt;/Button&gt;,<br>        ]&#125;<br>      /&gt;<br><br>      &#123;<br>        <span class="hljs-comment">// 模态框隐藏的时候，不挂载组件，显示的时候挂载组件，这是为了触发子组件的生命周期</span><br>        !isModalVisible ? (<br>          <span class="hljs-string">&#x27;&#x27;</span><br>        ) : (<br>          &lt;CreateOrEdit<br>            isModalVisible=&#123;isModalVisible&#125;<br>            isShowModal=&#123;isShowModal&#125;<br>            actionRef=&#123;actionRef&#125;<br>            editId=&#123;editId&#125;<br>          /&gt;<br>        )<br>      &#125;<br>    &lt;/PageContainer&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> index<br></code></pre></div></td></tr></table></figure>

<h1 id="六、商品列表"><a href="#六、商品列表" class="headerlink" title="六、商品列表"></a>六、商品列表</h1><h2 id="6-1-商品基本列表"><a href="#6-1-商品基本列表" class="headerlink" title="6.1 商品基本列表"></a>6.1 商品基本列表</h2><h3 id="6-1-1-商品列表接口"><a href="#6-1-1-商品列表接口" class="headerlink" title="6.1.1 商品列表接口"></a>6.1.1 商品列表接口</h3><h5 id="接口描述-9"><a href="#接口描述-9" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>商品列表</li>
</ul>
<h5 id="请求-URL-9"><a href="#请求-URL-9" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/goods</li>
</ul>
<h5 id="请求方式-9"><a href="#请求方式-9" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>GET</li>
</ul>
<h5 id="请求头部-6"><a href="#请求头部-6" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="Query-请求参数-1"><a href="#Query-请求参数-1" class="headerlink" title="Query 请求参数"></a>Query 请求参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>current</td>
<td>否</td>
<td>int</td>
<td>分页-当前页</td>
</tr>
<tr>
<td>title</td>
<td>否</td>
<td>string</td>
<td>商品名模糊搜索</td>
</tr>
<tr>
<td>category_id</td>
<td>否</td>
<td>int</td>
<td>分类</td>
</tr>
<tr>
<td>is_on</td>
<td>否</td>
<td>int</td>
<td>是否上架 0 不上架 1 上架</td>
</tr>
<tr>
<td>is_recommend</td>
<td>否</td>
<td>int</td>
<td>是否推荐 0 不推荐 1 推荐</td>
</tr>
<tr>
<td>include</td>
<td>否</td>
<td>string</td>
<td>包含额外的数据： category 分类，user 用户， comments 评论</td>
</tr>
</tbody></table>
<p><em>inlude 可以返回额外的数据， 多个使用，分隔， 比如：include=category,user,comments</em></p>
<h5 id="返回参数-5"><a href="#返回参数-5" class="headerlink" title="返回参数"></a>返回参数</h5><p><strong>data</strong></p>
<table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必含</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>是</td>
<td>int</td>
<td>自增长主键 ID</td>
</tr>
<tr>
<td>user_id</td>
<td>是</td>
<td>int</td>
<td>创建者</td>
</tr>
<tr>
<td>category_id</td>
<td>是</td>
<td>int</td>
<td>分类</td>
</tr>
<tr>
<td>title</td>
<td>是</td>
<td>string</td>
<td>标题</td>
</tr>
<tr>
<td>description</td>
<td>是</td>
<td>string</td>
<td>描述</td>
</tr>
<tr>
<td>price</td>
<td>是</td>
<td>int</td>
<td>价格</td>
</tr>
<tr>
<td>stock</td>
<td>是</td>
<td>int</td>
<td>库存</td>
</tr>
<tr>
<td>sales</td>
<td>是</td>
<td>int</td>
<td>销量</td>
</tr>
<tr>
<td>cover</td>
<td>是</td>
<td>string</td>
<td>封面图</td>
</tr>
<tr>
<td>cover_url</td>
<td>是</td>
<td>string</td>
<td>封面图 url</td>
</tr>
<tr>
<td>pics</td>
<td>是</td>
<td>array</td>
<td>小图集</td>
</tr>
<tr>
<td>pics_url</td>
<td>是</td>
<td>array</td>
<td>小图集 url</td>
</tr>
<tr>
<td>is_on</td>
<td>是</td>
<td>int</td>
<td>是否上架 0 不上架 1 上架</td>
</tr>
<tr>
<td>is_recommend</td>
<td>是</td>
<td>int</td>
<td>是否推荐 0 不推荐 1 推荐</td>
</tr>
<tr>
<td>details</td>
<td>是</td>
<td>string</td>
<td>详情</td>
</tr>
<tr>
<td>created_at</td>
<td>是</td>
<td>timestamp</td>
<td>注册时间</td>
</tr>
<tr>
<td>updated_at</td>
<td>是</td>
<td>timestamp</td>
<td>修改时间</td>
</tr>
</tbody></table>
<p><strong>meta.pagination</strong></p>
<table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必含</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>total</td>
<td>是</td>
<td>int</td>
<td>数据总数</td>
</tr>
<tr>
<td>count</td>
<td>是</td>
<td>int</td>
<td>当前页数据</td>
</tr>
<tr>
<td>per_page</td>
<td>是</td>
<td>int</td>
<td>每页显示条数</td>
</tr>
<tr>
<td>current_page</td>
<td>是</td>
<td>int</td>
<td>当前页页码</td>
</tr>
<tr>
<td>total_pages</td>
<td>是</td>
<td>int</td>
<td>总页数</td>
</tr>
<tr>
<td>links.previous</td>
<td>是</td>
<td>string</td>
<td>上一页链接</td>
</tr>
<tr>
<td>links.next</td>
<td>是</td>
<td>string</td>
<td>下一页链接</td>
</tr>
</tbody></table>
<h5 id="返回示例-10"><a href="#返回示例-10" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 200 请求成功</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;data&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;电脑11111电脑&quot;</span>,<br>            <span class="hljs-string">&quot;category_id&quot;</span>: <span class="hljs-number">7</span>,<br>            <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;这是一个电脑1111&quot;</span>,<br>            <span class="hljs-string">&quot;price&quot;</span>: <span class="hljs-number">5000</span>,<br>            <span class="hljs-string">&quot;stock&quot;</span>: <span class="hljs-number">999</span>,<br>            <span class="hljs-string">&quot;sales&quot;</span>: <span class="hljs-number">2</span>,<br>            <span class="hljs-string">&quot;cover&quot;</span>: <span class="hljs-string">&quot;100x100.jpg&quot;</span>,<br>            <span class="hljs-string">&quot;cover_url&quot;</span>: <span class="hljs-string">&quot;https://laravel-shop-api.oss-cn-beijing.aliyuncs.com/100x100.jpg&quot;</span>,<br>            <span class="hljs-string">&quot;pics&quot;</span>: [<br>                <span class="hljs-string">&quot;a.png&quot;</span>,<br>                <span class="hljs-string">&quot;b.png&quot;</span><br>            ],<br>            <span class="hljs-string">&quot;pics_url&quot;</span>: [<br>                <span class="hljs-string">&quot;https://laravel-shop-api.oss-cn-beijing.aliyuncs.com/a.png&quot;</span>,<br>                <span class="hljs-string">&quot;https://laravel-shop-api.oss-cn-beijing.aliyuncs.com/b.png&quot;</span><br>            ],<br>            <span class="hljs-string">&quot;details&quot;</span>: <span class="hljs-string">&quot;这是一个电脑这是一个电脑这是一个电脑这是一个电脑&quot;</span>,<br>            <span class="hljs-string">&quot;is_on&quot;</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-string">&quot;is_recommend&quot;</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-string">&quot;created_at&quot;</span>: <span class="hljs-string">&quot;2020-12-12T07:38:37.000000Z&quot;</span>,<br>            <span class="hljs-string">&quot;updated_at&quot;</span>: <span class="hljs-string">&quot;2020-12-12T10:13:45.000000Z&quot;</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">2</span>,<br>            <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;电脑2&quot;</span>,<br>            <span class="hljs-string">&quot;category_id&quot;</span>: <span class="hljs-number">7</span>,<br>            <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;这是一个电脑&quot;</span>,<br>            <span class="hljs-string">&quot;price&quot;</span>: <span class="hljs-number">5000</span>,<br>            <span class="hljs-string">&quot;stock&quot;</span>: <span class="hljs-number">999</span>,<br>            <span class="hljs-string">&quot;sales&quot;</span>: <span class="hljs-number">2</span>,<br>            <span class="hljs-string">&quot;cover&quot;</span>: <span class="hljs-string">&quot;/imgs/img1.png&quot;</span>,<br>            <span class="hljs-string">&quot;cover_url&quot;</span>: <span class="hljs-string">&quot;https://laravel-shop-api.oss-cn-beijing.aliyuncs.com//imgs/img1.png&quot;</span>,<br>            <span class="hljs-string">&quot;pics&quot;</span>: [<br>                <span class="hljs-string">&quot;a.png&quot;</span>,<br>                <span class="hljs-string">&quot;b.png&quot;</span><br>            ],<br>            <span class="hljs-string">&quot;pics_url&quot;</span>: [<br>                <span class="hljs-string">&quot;https://laravel-shop-api.oss-cn-beijing.aliyuncs.com/a.png&quot;</span>,<br>                <span class="hljs-string">&quot;https://laravel-shop-api.oss-cn-beijing.aliyuncs.com/b.png&quot;</span><br>            ],<br>            <span class="hljs-string">&quot;details&quot;</span>: <span class="hljs-string">&quot;这是一个电脑这是一个电脑这是一个电脑这是一个电脑&quot;</span>,<br>            <span class="hljs-string">&quot;is_on&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&quot;is_recommend&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&quot;created_at&quot;</span>: <span class="hljs-string">&quot;2020-12-12T07:38:45.000000Z&quot;</span>,<br>            <span class="hljs-string">&quot;updated_at&quot;</span>: <span class="hljs-string">&quot;2020-12-12T07:38:45.000000Z&quot;</span><br>        &#125;<br>    ],<br>    <span class="hljs-string">&quot;meta&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;pagination&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">7</span>,<br>            <span class="hljs-string">&quot;count&quot;</span>: <span class="hljs-number">2</span>,<br>            <span class="hljs-string">&quot;per_page&quot;</span>: <span class="hljs-number">2</span>,<br>            <span class="hljs-string">&quot;current_page&quot;</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-string">&quot;total_pages&quot;</span>: <span class="hljs-number">4</span>,<br>            <span class="hljs-string">&quot;links&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;previous&quot;</span>: <span class="hljs-literal">null</span>,<br>                <span class="hljs-string">&quot;next&quot;</span>: <span class="hljs-string">&quot;http://api.test/api/admin/goods?page=2&quot;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="6-1-2-添加商品列表接口"><a href="#6-1-2-添加商品列表接口" class="headerlink" title="6.1.2 添加商品列表接口"></a>6.1.2 添加商品列表接口</h3><p>在\src\services 文件夹中复制<code>user.jsx</code>文件夹并重命名<code>goods.jsx</code><br>根据接口文档添加商品列表接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/request&#x27;</span><br><br><span class="hljs-comment">// 获取商品列表</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getGoods</span>(<span class="hljs-params">params</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/admin/goods&#x27;</span>, &#123; params &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="6-1-3-创建基本商品列表页面"><a href="#6-1-3-创建基本商品列表页面" class="headerlink" title="6.1.3 创建基本商品列表页面"></a>6.1.3 创建基本商品列表页面</h3><p>在\src\pages 文件夹中，复制<code>User</code>文件夹并重命名<code>Goods</code>，<br>修改基本页面，添加商品图片预览，<br>其中<code>valueType</code>是设置筛选的单选按钮，<code>valueEnum</code>是选项，可以枚举也可以直接列出来，<a target="_blank" rel="noopener" href="https://procomponents.ant.design/components/table#valuetype---%E9%80%89%E6%8B%A9%E7%B1%BB">选择类</a>参考文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">valueType: <span class="hljs-string">&#x27;radioButton&#x27;</span>,<br>valueEnum: &#123;<br>  <span class="hljs-number">1</span>: &#123; <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;已推荐&#x27;</span> &#125;,<br>  <span class="hljs-number">0</span>: &#123; <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;未推荐&#x27;</span> &#125;,<br>&#125;,<br></code></pre></div></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useRef, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> &#123; PageContainer &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-layout&#x27;</span><br><span class="hljs-keyword">import</span> ProTable <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-table&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Button, Image, Switch, message &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; PlusOutlined &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/icons&#x27;</span><br><span class="hljs-keyword">import</span> &#123; getGoods &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/goods&#x27;</span><br><span class="hljs-keyword">import</span> CreateOrEdit <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./components/CreateOrEdit&#x27;</span><br><br><span class="hljs-keyword">const</span> index = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> [isModalVisible, setisModalVisible] = useState(<span class="hljs-literal">false</span>)<br>  <span class="hljs-keyword">const</span> [editId, setEditId] = useState(<span class="hljs-literal">undefined</span>)<br><br>  <span class="hljs-comment">// 表格的ref，便于操作自定义操作表格</span><br>  <span class="hljs-keyword">const</span> actionRef = useRef()<br><br>  <span class="hljs-comment">// 获取商品列表数据</span><br>  <span class="hljs-keyword">const</span> getData = <span class="hljs-keyword">async</span> params =&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> getGoods(params)<br><br>    <span class="hljs-keyword">return</span> &#123;<br>      data: response.data,<br>      <span class="hljs-comment">// success 请返回 true，</span><br>      <span class="hljs-comment">// 不然 table 会停止解析数据，即使有数据</span><br>      success: <span class="hljs-literal">true</span>,<br>      <span class="hljs-comment">// 不传会使用 data 的长度，如果是分页一定要传</span><br>      total: response.meta.pagination.total,<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 禁启用</span><br>  <span class="hljs-keyword">const</span> heandleLockUser = <span class="hljs-keyword">async</span> uid =&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> lockUser(uid)<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">&#x27;操作成功！&#x27;</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 控制新建/添加用户模态框显示和隐藏</span><br>  <span class="hljs-keyword">const</span> isShowModal = <span class="hljs-function">(<span class="hljs-params">show, id = <span class="hljs-literal">undefined</span></span>) =&gt;</span> &#123;<br>    setEditId(id)<br>    setisModalVisible(show)<br>  &#125;<br><br>  <span class="hljs-keyword">const</span> columns = [<br>    &#123;<br>      title: <span class="hljs-string">&#x27;商品图&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;cover_url&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> (<br>        &lt;Image<br>          width=&#123;<span class="hljs-number">64</span>&#125;<br>          src=&#123;record.cover_url&#125;<br>          placeholder=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span> <span class="hljs-attr">preview</span>=<span class="hljs-string">&#123;false&#125;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;record.cover_url&#125;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&#123;200&#125;</span> /&gt;</span></span>&#125;<br>        /&gt;<br>      ),<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;标题&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;title&#x27;</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;价格&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;price&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;库存&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;stock&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;销量&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;sales&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>    &#125;,<br><br>    &#123;<br>      title: <span class="hljs-string">&#x27;是否上架&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;is_on&#x27;</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> (<br>        &lt;Switch<br>          checkedChildren=<span class="hljs-string">&quot;已上架&quot;</span><br>          unCheckedChildren=<span class="hljs-string">&quot;未上架&quot;</span><br>          defaultChecked=&#123;record.is_on === <span class="hljs-number">1</span>&#125;<br>          onChange=&#123;<span class="hljs-function">() =&gt;</span> &#123;<br>            heandleLockUser(record.id)<br>          &#125;&#125;<br>        /&gt;<br>      ),<br>      valueType: <span class="hljs-string">&#x27;radioButton&#x27;</span>,<br>      valueEnum: &#123;<br>        <span class="hljs-number">1</span>: &#123; <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;已上架&#x27;</span> &#125;,<br>        <span class="hljs-number">0</span>: &#123; <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;未上架&#x27;</span> &#125;,<br>      &#125;,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;是否推荐&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;is_recommend&#x27;</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> (<br>        &lt;Switch<br>          checkedChildren=<span class="hljs-string">&quot;已推荐&quot;</span><br>          unCheckedChildren=<span class="hljs-string">&quot;未推荐&quot;</span><br>          defaultChecked=&#123;record.is_recommend === <span class="hljs-number">1</span>&#125;<br>          onChange=&#123;<span class="hljs-function">() =&gt;</span> &#123;<br>            heandleLockUser(record.id)<br>          &#125;&#125;<br>        /&gt;<br>      ),<br>      valueType: <span class="hljs-string">&#x27;radioButton&#x27;</span>,<br>      valueEnum: &#123;<br>        <span class="hljs-number">1</span>: &#123; <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;已推荐&#x27;</span> &#125;,<br>        <span class="hljs-number">0</span>: &#123; <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;未推荐&#x27;</span> &#125;,<br>      &#125;,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;created_at&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;操作&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> isShowModal(true, record.id)&#125;&gt;编辑<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span>,<br>    &#125;,<br>  ]<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;PageContainer&gt;<br>      &lt;ProTable<br>        columns=&#123;columns&#125;<br>        actionRef=&#123;actionRef&#125;<br>        request=&#123;<span class="hljs-keyword">async</span> (params = &#123;&#125;) =&gt; getData(params)&#125;<br>        rowKey=<span class="hljs-string">&quot;id&quot;</span><br>        search=&#123;&#123;<br>          labelWidth: <span class="hljs-string">&#x27;auto&#x27;</span>,<br>        &#125;&#125;<br>        pagination=&#123;&#123;<br>          pageSize: <span class="hljs-number">10</span>,<br>        &#125;&#125;<br>        dateFormatter=<span class="hljs-string">&quot;string&quot;</span><br>        headerTitle=<span class="hljs-string">&quot;用户列表&quot;</span><br>        toolBarRender=&#123;<span class="hljs-function">() =&gt;</span> [<br>          &lt;Button<br>            key=<span class="hljs-string">&quot;button&quot;</span><br>            icon=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">PlusOutlined</span> /&gt;</span></span>&#125;<br>            type=<span class="hljs-string">&quot;primary&quot;</span><br>            onClick=&#123;<span class="hljs-function">() =&gt;</span> isShowModal(<span class="hljs-literal">true</span>)&#125;&gt;<br>            新建<br>          &lt;/Button&gt;,<br>        ]&#125;<br>      /&gt;<br><br>      &#123;<br>        <span class="hljs-comment">// 模态框隐藏的时候，不挂载组件，显示的时候挂载组件，这是为了触发子组件的生命周期</span><br>        !isModalVisible ? (<br>          <span class="hljs-string">&#x27;&#x27;</span><br>        ) : (<br>          &lt;CreateOrEdit<br>            isModalVisible=&#123;isModalVisible&#125;<br>            isShowModal=&#123;isShowModal&#125;<br>            actionRef=&#123;actionRef&#125;<br>            editId=&#123;editId&#125;<br>          /&gt;<br>        )<br>      &#125;<br>    &lt;/PageContainer&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> index<br></code></pre></div></td></tr></table></figure>

<h2 id="6-2-是否上架-推荐商品"><a href="#6-2-是否上架-推荐商品" class="headerlink" title="6.2 是否上架/推荐商品"></a>6.2 是否上架/推荐商品</h2><h3 id="6-2-1-商品上架和下架接口文档"><a href="#6-2-1-商品上架和下架接口文档" class="headerlink" title="6.2.1 商品上架和下架接口文档"></a>6.2.1 商品上架和下架接口文档</h3><h5 id="接口描述-10"><a href="#接口描述-10" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>上架和下架</li>
</ul>
<h5 id="请求-URL-10"><a href="#请求-URL-10" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/goods/{good}/on</li>
</ul>
<h5 id="请求方式-10"><a href="#请求方式-10" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>PATCH</li>
</ul>
<h5 id="请求头部-7"><a href="#请求头部-7" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="RESET-参数-2"><a href="#RESET-参数-2" class="headerlink" title="RESET 参数"></a>RESET 参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>good</td>
<td>是</td>
<td>int</td>
<td>商品 id</td>
</tr>
</tbody></table>
<h5 id="返回示例-11"><a href="#返回示例-11" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 204 请求成功</li>
</ul>
<h3 id="6-2-2-商品推荐和不推荐接口文档"><a href="#6-2-2-商品推荐和不推荐接口文档" class="headerlink" title="6.2.2 商品推荐和不推荐接口文档"></a>6.2.2 商品推荐和不推荐接口文档</h3><h5 id="接口描述-11"><a href="#接口描述-11" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>推荐和不推荐</li>
</ul>
<h5 id="请求-URL-11"><a href="#请求-URL-11" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/goods/{good}/recommend</li>
</ul>
<h5 id="请求方式-11"><a href="#请求方式-11" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>PATCH</li>
</ul>
<h5 id="请求头部-8"><a href="#请求头部-8" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="RESET-参数-3"><a href="#RESET-参数-3" class="headerlink" title="RESET 参数"></a>RESET 参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>good</td>
<td>是</td>
<td>int</td>
<td>商品 id</td>
</tr>
</tbody></table>
<h5 id="返回示例-12"><a href="#返回示例-12" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 204 请求成功</li>
</ul>
<h3 id="6-2-3-添加是否上架-推荐商品接口"><a href="#6-2-3-添加是否上架-推荐商品接口" class="headerlink" title="6.2.3 添加是否上架/推荐商品接口"></a>6.2.3 添加是否上架/推荐商品接口</h3><p>在\src\services\goods.js 中添加是否上架/推荐商品接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/request&#x27;</span><br><br><span class="hljs-comment">// 获取商品列表</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getGoods</span>(<span class="hljs-params">params</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/admin/goods&#x27;</span>, &#123; params &#125;)<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 上架和下架商品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;商品id&#125;</span> <span class="hljs-variable">goodsid</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isOn</span>(<span class="hljs-params">goodsId</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.patch(<span class="hljs-string">`/admin/goods/<span class="hljs-subst">$&#123;goodsId&#125;</span>/on`</span>)<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 推荐和不推荐商品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;商品id&#125;</span> <span class="hljs-variable">goodsid</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isRecommend</span>(<span class="hljs-params">goodsId</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.patch(<span class="hljs-string">`/admin/goods/<span class="hljs-subst">$&#123;goodsId&#125;</span>/recommend`</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="6-2-4-添加是否上架-推荐商品方法"><a href="#6-2-4-添加是否上架-推荐商品方法" class="headerlink" title="6.2.4 添加是否上架/推荐商品方法"></a>6.2.4 添加是否上架/推荐商品方法</h3><p>在\src\pages\Goods\index.jsx 中,先导入接口<code>import &#123; getGoods, isOn, isRecommend &#125; from &#39;@/services/goods&#39;;</code><br>修改并添加是否上架/推荐商品方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useRef, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> &#123; PageContainer &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-layout&#x27;</span><br><span class="hljs-keyword">import</span> ProTable <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-table&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Button, Image, Switch, message &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; PlusOutlined &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/icons&#x27;</span><br><span class="hljs-keyword">import</span> &#123; getGoods, isOn, isRecommend &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/goods&#x27;</span><br><span class="hljs-keyword">import</span> CreateOrEdit <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./components/CreateOrEdit&#x27;</span><br><br><span class="hljs-keyword">const</span> index = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> [isModalVisible, setisModalVisible] = useState(<span class="hljs-literal">false</span>)<br>  <span class="hljs-keyword">const</span> [editId, setEditId] = useState(<span class="hljs-literal">undefined</span>)<br><br>  <span class="hljs-comment">// 表格的ref，便于操作自定义操作表格</span><br>  <span class="hljs-keyword">const</span> actionRef = useRef()<br><br>  <span class="hljs-comment">// 获取商品列表数据</span><br>  <span class="hljs-keyword">const</span> getData = <span class="hljs-keyword">async</span> params =&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> getGoods(params)<br><br>    <span class="hljs-keyword">return</span> &#123;<br>      data: response.data,<br>      <span class="hljs-comment">// success 请返回 true，</span><br>      <span class="hljs-comment">// 不然 table 会停止解析数据，即使有数据</span><br>      success: <span class="hljs-literal">true</span>,<br>      <span class="hljs-comment">// 不传会使用 data 的长度，如果是分页一定要传</span><br>      total: response.meta.pagination.total,<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 是否上架商品</span><br>  <span class="hljs-keyword">const</span> heandleIsOn = <span class="hljs-keyword">async</span> goodsId =&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> isOn(goodsId)<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">&#x27;操作成功！&#x27;</span>)<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 是否推荐商品</span><br>  <span class="hljs-keyword">const</span> heandleIsRecommend = <span class="hljs-keyword">async</span> goodsId =&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> isRecommend(goodsId)<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">&#x27;操作成功！&#x27;</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 控制新建/添加用户模态框显示和隐藏</span><br>  <span class="hljs-keyword">const</span> isShowModal = <span class="hljs-function">(<span class="hljs-params">show, id = <span class="hljs-literal">undefined</span></span>) =&gt;</span> &#123;<br>    setEditId(id)<br>    setisModalVisible(show)<br>  &#125;<br><br>  <span class="hljs-keyword">const</span> columns = [<br>    &#123;<br>      title: <span class="hljs-string">&#x27;商品图&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;cover_url&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> (<br>        &lt;Image<br>          width=&#123;<span class="hljs-number">64</span>&#125;<br>          src=&#123;record.cover_url&#125;<br>          placeholder=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span> <span class="hljs-attr">preview</span>=<span class="hljs-string">&#123;false&#125;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;record.cover_url&#125;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&#123;200&#125;</span> /&gt;</span></span>&#125;<br>        /&gt;<br>      ),<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;标题&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;title&#x27;</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;价格&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;price&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;库存&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;stock&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;销量&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;sales&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>    &#125;,<br><br>    &#123;<br>      title: <span class="hljs-string">&#x27;是否上架&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;is_on&#x27;</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> (<br>        &lt;Switch<br>          checkedChildren=<span class="hljs-string">&quot;已上架&quot;</span><br>          unCheckedChildren=<span class="hljs-string">&quot;未上架&quot;</span><br>          defaultChecked=&#123;record.is_on === <span class="hljs-number">1</span>&#125;<br>          onChange=&#123;<span class="hljs-function">() =&gt;</span> &#123;<br>            heandleIsOn(record.id)<br>          &#125;&#125;<br>        /&gt;<br>      ),<br>      valueType: <span class="hljs-string">&#x27;radioButton&#x27;</span>,<br>      valueEnum: &#123;<br>        <span class="hljs-number">1</span>: &#123; <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;已上架&#x27;</span> &#125;,<br>        <span class="hljs-number">0</span>: &#123; <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;未上架&#x27;</span> &#125;,<br>      &#125;,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;是否推荐&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;is_recommend&#x27;</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> (<br>        &lt;Switch<br>          checkedChildren=<span class="hljs-string">&quot;已推荐&quot;</span><br>          unCheckedChildren=<span class="hljs-string">&quot;未推荐&quot;</span><br>          defaultChecked=&#123;record.is_recommend === <span class="hljs-number">1</span>&#125;<br>          onChange=&#123;<span class="hljs-function">() =&gt;</span> &#123;<br>            heandleIsRecommend(record.id)<br>          &#125;&#125;<br>        /&gt;<br>      ),<br>      valueType: <span class="hljs-string">&#x27;radioButton&#x27;</span>,<br>      valueEnum: &#123;<br>        <span class="hljs-number">1</span>: &#123; <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;已推荐&#x27;</span> &#125;,<br>        <span class="hljs-number">0</span>: &#123; <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;未推荐&#x27;</span> &#125;,<br>      &#125;,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>      dataIndex: <span class="hljs-string">&#x27;created_at&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>    &#125;,<br>    &#123;<br>      title: <span class="hljs-string">&#x27;操作&#x27;</span>,<br>      hideInSearch: <span class="hljs-literal">true</span>,<br>      render: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> isShowModal(true, record.id)&#125;&gt;编辑<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span>,<br>    &#125;,<br>  ]<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;PageContainer&gt;<br>      &lt;ProTable<br>        columns=&#123;columns&#125;<br>        actionRef=&#123;actionRef&#125;<br>        request=&#123;<span class="hljs-keyword">async</span> (params = &#123;&#125;) =&gt; getData(params)&#125;<br>        rowKey=<span class="hljs-string">&quot;id&quot;</span><br>        search=&#123;&#123;<br>          labelWidth: <span class="hljs-string">&#x27;auto&#x27;</span>,<br>        &#125;&#125;<br>        pagination=&#123;&#123;<br>          pageSize: <span class="hljs-number">10</span>,<br>        &#125;&#125;<br>        dateFormatter=<span class="hljs-string">&quot;string&quot;</span><br>        headerTitle=<span class="hljs-string">&quot;商品列表&quot;</span><br>        toolBarRender=&#123;<span class="hljs-function">() =&gt;</span> [<br>          &lt;Button<br>            key=<span class="hljs-string">&quot;button&quot;</span><br>            icon=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">PlusOutlined</span> /&gt;</span></span>&#125;<br>            type=<span class="hljs-string">&quot;primary&quot;</span><br>            onClick=&#123;<span class="hljs-function">() =&gt;</span> isShowModal(<span class="hljs-literal">true</span>)&#125;&gt;<br>            新建<br>          &lt;/Button&gt;,<br>        ]&#125;<br>      /&gt;<br><br>      &#123;<br>        <span class="hljs-comment">// 模态框隐藏的时候，不挂载组件，显示的时候挂载组件，这是为了触发子组件的生命周期</span><br>        !isModalVisible ? (<br>          <span class="hljs-string">&#x27;&#x27;</span><br>        ) : (<br>          &lt;CreateOrEdit<br>            isModalVisible=&#123;isModalVisible&#125;<br>            isShowModal=&#123;isShowModal&#125;<br>            actionRef=&#123;actionRef&#125;<br>            editId=&#123;editId&#125;<br>          /&gt;<br>        )<br>      &#125;<br>    &lt;/PageContainer&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> index<br></code></pre></div></td></tr></table></figure>

<h2 id="6-3-新建商品页面"><a href="#6-3-新建商品页面" class="headerlink" title="6.3 新建商品页面"></a>6.3 新建商品页面</h2><h3 id="6-3-1-添加商品接口文档"><a href="#6-3-1-添加商品接口文档" class="headerlink" title="6.3.1 添加商品接口文档"></a>6.3.1 添加商品接口文档</h3><h5 id="接口描述-12"><a href="#接口描述-12" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>添加商品</li>
</ul>
<h5 id="请求-URL-12"><a href="#请求-URL-12" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/goods</li>
</ul>
<h5 id="请求方式-12"><a href="#请求方式-12" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>POST</li>
</ul>
<h5 id="请求头部-9"><a href="#请求头部-9" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="Body-请求参数-3"><a href="#Body-请求参数-3" class="headerlink" title="Body 请求参数"></a>Body 请求参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>category_id</td>
<td>是</td>
<td>int</td>
<td>分类</td>
</tr>
<tr>
<td>title</td>
<td>是</td>
<td>string</td>
<td>标题</td>
</tr>
<tr>
<td>description</td>
<td>是</td>
<td>string</td>
<td>描述</td>
</tr>
<tr>
<td>price</td>
<td>是</td>
<td>int</td>
<td>价格</td>
</tr>
<tr>
<td>stock</td>
<td>是</td>
<td>int</td>
<td>库存</td>
</tr>
<tr>
<td>cover</td>
<td>是</td>
<td>string</td>
<td>封面图</td>
</tr>
<tr>
<td>pics</td>
<td>否</td>
<td>array</td>
<td>小图集</td>
</tr>
<tr>
<td>details</td>
<td>是</td>
<td>string</td>
<td>详情</td>
</tr>
</tbody></table>
<h5 id="返回示例-13"><a href="#返回示例-13" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 201 创建成功</li>
<li>状态码 400 请求错误</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;分类不存在&quot;</span>,<br>    <span class="hljs-string">&quot;status_code&quot;</span>: <span class="hljs-number">400</span>,<br>&#125;<br><br>&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;分类被禁用&quot;</span>,<br>    <span class="hljs-string">&quot;status_code&quot;</span>: <span class="hljs-number">400</span>,<br>&#125;<br><br>&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;只能向2级分类添加商品&quot;</span>,<br>    <span class="hljs-string">&quot;status_code&quot;</span>: <span class="hljs-number">400</span>,<br>&#125;<br><br>状态码 <span class="hljs-number">422</span> 参数错误<br>&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;The given data was invalid.&quot;</span>,<br>    <span class="hljs-string">&quot;errors&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;title&quot;</span>: [<br>            <span class="hljs-string">&quot;标题 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;category_id&quot;</span>: [<br>            <span class="hljs-string">&quot;category id 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;description&quot;</span>: [<br>            <span class="hljs-string">&quot;描述 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;price&quot;</span>: [<br>            <span class="hljs-string">&quot;price 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;stock&quot;</span>: [<br>            <span class="hljs-string">&quot;stock 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;cover&quot;</span>: [<br>            <span class="hljs-string">&quot;cover 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;pics&quot;</span>: [<br>            <span class="hljs-string">&quot;pics 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;details&quot;</span>: [<br>            <span class="hljs-string">&quot;details 不能为空。&quot;</span><br>        ]<br>    &#125;,<br>    <span class="hljs-string">&quot;status_code&quot;</span>: <span class="hljs-number">422</span>,<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="6-3-2-编辑添加商品页面"><a href="#6-3-2-编辑添加商品页面" class="headerlink" title="6.3.2 编辑添加商品页面"></a>6.3.2 编辑添加商品页面</h3><p>在\src\pages\Goods\components\CreateOrEdit.jsx 中，<a target="_blank" rel="noopener" href="https://procomponents.ant.design/components/field-set">ProFormFields</a> 表单项 参考文档。<br>只是简单完成添加商品必须的页面</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useEffect, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> ProForm, &#123;<br>  ProFormText,<br>  ProFormTextArea,<br>  ProFormDigit,<br>  ProFormUploadButton,<br>&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-form&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Modal, message, Skeleton &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; showUser, updateUser, addUser &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/user&#x27;</span><br><br><span class="hljs-keyword">const</span> CreateOrEdit = <span class="hljs-function"><span class="hljs-params">props</span> =&gt;</span> &#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * isModalVisible 模态框是否显示</span><br><span class="hljs-comment">   * isShowModal 操作模态框显示隐藏的方法</span><br><span class="hljs-comment">   * actionRef 父组件传来的表格的引用，可以用来操作表格，比如刷新表单</span><br><span class="hljs-comment">   * editId 要编辑的id，添加的时候是undefined，只有编辑时才有</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">const</span> &#123; isModalVisible, isShowModal, actionRef, editId &#125; = props<br><br>  <span class="hljs-comment">// 将表单初始化的值设置成状态，在编辑的时候使用这个状态</span><br>  <span class="hljs-keyword">const</span> [initialValues, setinitialValues] = useState(<span class="hljs-literal">undefined</span>)<br><br>  <span class="hljs-comment">// 添加或者编辑的描述</span><br>  <span class="hljs-keyword">const</span> type = editId === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">&#x27;添加&#x27;</span> : <span class="hljs-string">&#x27;编辑&#x27;</span><br><br>  useEffect(<span class="hljs-keyword">async</span> () =&gt; &#123;<br>    <span class="hljs-comment">// 发送请求，获取用户详情</span><br>    <span class="hljs-keyword">if</span> (editId !== <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> showUser(editId)<br>      <span class="hljs-comment">// 获取数据之后,修改状态；状态改变，组件重新渲染，骨架框消失，编辑表单出现</span><br>      setinitialValues(&#123;<br>        name: response.name,<br>        email: response.email,<br>      &#125;)<br>    &#125;<br>  &#125;, [])<br><br>  <span class="hljs-comment">// 提交表单，执行编辑或者添加</span><br>  <span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-keyword">async</span> values =&gt; &#123;<br>    <span class="hljs-keyword">let</span> response = []<br>    <span class="hljs-keyword">if</span> (editId === <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-comment">// 执行添加</span><br>      <span class="hljs-comment">// 发送请求，添加用户</span><br>      response = <span class="hljs-keyword">await</span> addUser(values)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 执行编辑</span><br>      <span class="hljs-comment">// 发送请求，更新用户</span><br>      response = <span class="hljs-keyword">await</span> updateUser(editId, values)<br>    &#125;<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>成功！`</span>)<br>      <span class="hljs-comment">// 刷新表格数据</span><br>      actionRef.current.reload()<br>      <span class="hljs-comment">// 关闭模态框</span><br>      isShowModal(<span class="hljs-literal">false</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;Modal<br>      title=&#123;<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>商品`</span>&#125;<br>      visible=&#123;isModalVisible&#125;<br>      onCancel=&#123;<span class="hljs-function">() =&gt;</span> isShowModal(<span class="hljs-literal">false</span>)&#125;<br>      footer=&#123;<span class="hljs-literal">null</span>&#125;<br>      destroyOnClose=&#123;<span class="hljs-literal">true</span>&#125;&gt;<br>      &#123;<br>        <span class="hljs-comment">// 只有是编辑的情况下，并且要显示的数据还有返回，才显示骨架框</span><br>        initialValues === <span class="hljs-literal">undefined</span> &amp;&amp; editId !== <span class="hljs-literal">undefined</span> ? (<br>          &lt;Skeleton active=&#123;<span class="hljs-literal">true</span>&#125; paragraph=&#123;&#123; <span class="hljs-attr">rows</span>: <span class="hljs-number">4</span> &#125;&#125; /&gt;<br>        ) : (<br>          &lt;ProForm<br>            initialValues=&#123;initialValues&#125;<br>            onFinish=&#123;<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> &#123;<br>              handleSubmit(values)<br>            &#125;&#125;&gt;<br>            &lt;ProFormText<br>              name=<span class="hljs-string">&quot;category_id&quot;</span><br>              label=<span class="hljs-string">&quot;分类&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入分类&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入分类&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormText<br>              name=<span class="hljs-string">&quot;title&quot;</span><br>              label=<span class="hljs-string">&quot;商品名&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品名&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品名&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormTextArea<br>              name=<span class="hljs-string">&quot;description&quot;</span><br>              label=<span class="hljs-string">&quot;描述&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品描述&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品描述&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormDigit<br>              name=<span class="hljs-string">&quot;price&quot;</span><br>              label=<span class="hljs-string">&quot;价格&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品价格&quot;</span><br>              min=&#123;<span class="hljs-number">0</span>&#125;<br>              max=&#123;<span class="hljs-number">99999999</span>&#125;<br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商商品价格&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormDigit<br>              name=<span class="hljs-string">&quot;stock&quot;</span><br>              label=<span class="hljs-string">&quot;库存&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品库存&quot;</span><br>              min=&#123;<span class="hljs-number">0</span>&#125;<br>              max=&#123;<span class="hljs-number">99999999</span>&#125;<br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品库存&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormUploadButton<br>              label=<span class="hljs-string">&quot;上传封面图&quot;</span><br>              name=<span class="hljs-string">&quot;cover&quot;</span><br>              action=<span class="hljs-string">&quot;upload.do&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请选择商品主图&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormTextArea<br>              name=<span class="hljs-string">&quot;details&quot;</span><br>              label=<span class="hljs-string">&quot;详情&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品详情&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品详情&#x27;</span> &#125;]&#125;<br>            /&gt;<br>          &lt;/ProForm&gt;<br>        )<br>      &#125;<br>    &lt;/Modal&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> CreateOrEdit<br></code></pre></div></td></tr></table></figure>

<h2 id="6-4-处理商品分类"><a href="#6-4-处理商品分类" class="headerlink" title="6.4 处理商品分类"></a>6.4 处理商品分类</h2><h3 id="6-4-1-商品分类接口文档"><a href="#6-4-1-商品分类接口文档" class="headerlink" title="6.4.1 商品分类接口文档"></a>6.4.1 商品分类接口文档</h3><h5 id="接口描述-13"><a href="#接口描述-13" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>分类列表</li>
</ul>
<h5 id="请求-URL-13"><a href="#请求-URL-13" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/category</li>
</ul>
<h5 id="请求方式-13"><a href="#请求方式-13" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>GET</li>
</ul>
<h5 id="请求头部-10"><a href="#请求头部-10" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="Query-请求参数-2"><a href="#Query-请求参数-2" class="headerlink" title="Query 请求参数"></a>Query 请求参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>type</td>
<td>否</td>
<td>string</td>
<td>all 查所有分类，包含禁用的。不传则只返回非禁用的</td>
</tr>
</tbody></table>
<h5 id="返回参数-6"><a href="#返回参数-6" class="headerlink" title="返回参数"></a>返回参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必含</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>是</td>
<td>int</td>
<td>主键</td>
</tr>
<tr>
<td>pid</td>
<td>是</td>
<td>int</td>
<td>父级</td>
</tr>
<tr>
<td>name</td>
<td>是</td>
<td>string</td>
<td>名称</td>
</tr>
<tr>
<td>level</td>
<td>是</td>
<td>int</td>
<td>层级</td>
</tr>
<tr>
<td>status</td>
<td>是</td>
<td>int</td>
<td>状态： 0 正常 1 禁用</td>
</tr>
<tr>
<td>children</td>
<td>否</td>
<td>array</td>
<td>子类</td>
</tr>
</tbody></table>
<h5 id="返回示例-14"><a href="#返回示例-14" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 200 请求成功</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">;[<br>  &#123;<br>    id: <span class="hljs-number">1</span>,<br>    pid: <span class="hljs-number">0</span>,<br>    name: <span class="hljs-string">&#x27;电子数码&#x27;</span>,<br>    level: <span class="hljs-number">1</span>,<br>    status: <span class="hljs-number">1</span>,<br>    children: [<br>      &#123;<br>        id: <span class="hljs-number">3</span>,<br>        pid: <span class="hljs-number">1</span>,<br>        name: <span class="hljs-string">&#x27;手机&#x27;</span>,<br>        level: <span class="hljs-number">2</span>,<br>        status: <span class="hljs-number">1</span>,<br>        children: [<br>          &#123;<br>            id: <span class="hljs-number">5</span>,<br>            pid: <span class="hljs-number">3</span>,<br>            name: <span class="hljs-string">&#x27;华为&#x27;</span>,<br>            level: <span class="hljs-number">3</span>,<br>            status: <span class="hljs-number">1</span>,<br>          &#125;,<br>          &#123;<br>            id: <span class="hljs-number">6</span>,<br>            pid: <span class="hljs-number">3</span>,<br>            name: <span class="hljs-string">&#x27;小米&#x27;</span>,<br>            level: <span class="hljs-number">3</span>,<br>            status: <span class="hljs-number">1</span>,<br>          &#125;,<br>        ],<br>      &#125;,<br>      &#123;<br>        id: <span class="hljs-number">4</span>,<br>        pid: <span class="hljs-number">1</span>,<br>        name: <span class="hljs-string">&#x27;电脑&#x27;</span>,<br>        level: <span class="hljs-number">2</span>,<br>        status: <span class="hljs-number">1</span>,<br>        children: [<br>          &#123;<br>            id: <span class="hljs-number">7</span>,<br>            pid: <span class="hljs-number">4</span>,<br>            name: <span class="hljs-string">&#x27;戴尔&#x27;</span>,<br>            level: <span class="hljs-number">3</span>,<br>            status: <span class="hljs-number">1</span>,<br>          &#125;,<br>        ],<br>      &#125;,<br>    ],<br>  &#125;,<br>  &#123;<br>    id: <span class="hljs-number">2</span>,<br>    pid: <span class="hljs-number">0</span>,<br>    name: <span class="hljs-string">&#x27;服装衣帽&#x27;</span>,<br>    level: <span class="hljs-number">1</span>,<br>    status: <span class="hljs-number">1</span>,<br>    children: [<br>      &#123;<br>        id: <span class="hljs-number">9</span>,<br>        pid: <span class="hljs-number">2</span>,<br>        name: <span class="hljs-string">&#x27;男装&#x27;</span>,<br>        level: <span class="hljs-number">2</span>,<br>        status: <span class="hljs-number">1</span>,<br>        children: [],<br>      &#125;,<br>      &#123;<br>        id: <span class="hljs-number">10</span>,<br>        pid: <span class="hljs-number">2</span>,<br>        name: <span class="hljs-string">&#x27;女装&#x27;</span>,<br>        level: <span class="hljs-number">2</span>,<br>        status: <span class="hljs-number">1</span>,<br>        children: [],<br>      &#125;,<br>    ],<br>  &#125;,<br>]<br></code></pre></div></td></tr></table></figure>

<h3 id="6-4-2-添加分类列表接口–非禁用的分类"><a href="#6-4-2-添加分类列表接口–非禁用的分类" class="headerlink" title="6.4.2 添加分类列表接口–非禁用的分类"></a>6.4.2 添加分类列表接口–非禁用的分类</h3><p>在 src\services 中新建一个<code>category.js</code>文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/request&#x27;</span><br><br><span class="hljs-comment">// 获取分类列表-非禁用的分类</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCategory</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/admin/category&#x27;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="6-4-3-添加商品分类Select组件"><a href="#6-4-3-添加商品分类Select组件" class="headerlink" title="6.4.3 添加商品分类Select组件"></a>6.4.3 添加商品分类<code>Select</code>组件</h3><p>在\src\pages\Goods\components\CreateOrEdit.jsx 中<br>设置<code>options</code>为空，储存后端返回的数据 <code>const [options, setOptions] = useState([]);</code><br>在生命周期函数中<code>useEffect</code>请求查询分类数据</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">useEffect(<span class="hljs-keyword">async</span> () =&gt; &#123;<br>  <span class="hljs-comment">// 查询分类数据</span><br>  <span class="hljs-keyword">const</span> resCategory = <span class="hljs-keyword">await</span> getCategory()<br>  <span class="hljs-keyword">if</span> (resCategory.status === <span class="hljs-literal">undefined</span>) setOptions(resCategory)<br><br>  <span class="hljs-comment">// 发送请求，获取用户详情</span><br>  <span class="hljs-keyword">if</span> (editId !== <span class="hljs-literal">undefined</span>) &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> showUser(editId)<br>    <span class="hljs-comment">// 获取数据之后,修改状态；状态改变，组件重新渲染，骨架框消失，编辑表单出现</span><br>    setinitialValues(&#123;<br>      name: response.name,<br>      email: response.email,<br>    &#125;)<br>  &#125;<br>&#125;, [])<br></code></pre></div></td></tr></table></figure>

<p>其中需要加 <a target="_blank" rel="noopener" href="https://ant.design/components/cascader-cn/#components-cascader-demo-lazy">Cascader</a> 级联选择，还要加<code>ProForm.Item</code>标签包裹<code>Cascader</code>，设置分类的<code>name</code>和<code>rules</code>等，<a target="_blank" rel="noopener" href="https://procomponents.ant.design/components/field-set/#proformfields-%E8%A1%A8%E5%8D%95%E9%A1%B9">ProFormFields</a>表单项参考文档。<br>同时，后端返回来的字段和<code>Cascader</code>官方的文档字段不一样时，查看 API 文档<code>fieldNames</code>属性可以自定义字段</p>
<table>
<thead>
<tr>
<th><strong>fieldNames</strong></th>
<th>自定义 options 中 label name children 的字段</th>
<th>object</th>
<th>{ label: label, value: value, children: children }</th>
</tr>
</thead>
</table>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;ProForm.Item name=<span class="hljs-string">&quot;category_id&quot;</span> label=<span class="hljs-string">&quot;分类&quot;</span> rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入分类&#x27;</span> &#125;]&#125;&gt;<br>  &lt;Cascader<br>    fieldNames=&#123;&#123; <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;id&#x27;</span> &#125;&#125;<br>    options=&#123;options&#125;<br>    placeholder=<span class="hljs-string">&quot;请输入分类&quot;</span><br>  /&gt;<br>&lt;/ProForm.Item&gt;<br></code></pre></div></td></tr></table></figure>

<p>然后导入<code>import &#123; getCategory &#125; from &#39;@/services/category&#39;;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useEffect, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> ProForm, &#123;<br>  ProFormText,<br>  ProFormTextArea,<br>  ProFormDigit,<br>  ProFormUploadButton,<br>&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-form&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Modal, message, Skeleton, Cascader &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; showUser, updateUser, addUser &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/user&#x27;</span><br><span class="hljs-keyword">import</span> &#123; getCategory &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/category&#x27;</span><br><br><span class="hljs-keyword">const</span> CreateOrEdit = <span class="hljs-function"><span class="hljs-params">props</span> =&gt;</span> &#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * isModalVisible 模态框是否显示</span><br><span class="hljs-comment">   * isShowModal 操作模态框显示隐藏的方法</span><br><span class="hljs-comment">   * actionRef 父组件传来的表格的引用，可以用来操作表格，比如刷新表单</span><br><span class="hljs-comment">   * editId 要编辑的id，添加的时候是undefined，只有编辑时才有</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">const</span> &#123; isModalVisible, isShowModal, actionRef, editId &#125; = props<br><br>  <span class="hljs-comment">// 将表单初始化的值设置成状态，在编辑的时候使用这个状态</span><br>  <span class="hljs-keyword">const</span> [initialValues, setinitialValues] = useState(<span class="hljs-literal">undefined</span>)<br>  <span class="hljs-keyword">const</span> [options, setOptions] = useState([])<br><br>  <span class="hljs-comment">// 添加或者编辑的描述</span><br>  <span class="hljs-keyword">const</span> type = editId === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">&#x27;添加&#x27;</span> : <span class="hljs-string">&#x27;编辑&#x27;</span><br><br>  useEffect(<span class="hljs-keyword">async</span> () =&gt; &#123;<br>    <span class="hljs-comment">// 查询分类数据</span><br>    <span class="hljs-keyword">const</span> resCategory = <span class="hljs-keyword">await</span> getCategory()<br>    <span class="hljs-keyword">if</span> (resCategory.status === <span class="hljs-literal">undefined</span>) setOptions(resCategory)<br><br>    <span class="hljs-comment">// 发送请求，获取用户详情</span><br>    <span class="hljs-keyword">if</span> (editId !== <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> showUser(editId)<br>      <span class="hljs-comment">// 获取数据之后,修改状态；状态改变，组件重新渲染，骨架框消失，编辑表单出现</span><br>      setinitialValues(&#123;<br>        name: response.name,<br>        email: response.email,<br>      &#125;)<br>    &#125;<br>  &#125;, [])<br><br>  <span class="hljs-comment">// 提交表单，执行编辑或者添加</span><br>  <span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-keyword">async</span> values =&gt; &#123;<br>    <span class="hljs-keyword">let</span> response = []<br>    <span class="hljs-keyword">if</span> (editId === <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-comment">// 执行添加</span><br>      <span class="hljs-comment">// 发送请求，添加用户</span><br>      response = <span class="hljs-keyword">await</span> addUser(values)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 执行编辑</span><br>      <span class="hljs-comment">// 发送请求，更新用户</span><br>      response = <span class="hljs-keyword">await</span> updateUser(editId, values)<br>    &#125;<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>成功！`</span>)<br>      <span class="hljs-comment">// 刷新表格数据</span><br>      actionRef.current.reload()<br>      <span class="hljs-comment">// 关闭模态框</span><br>      isShowModal(<span class="hljs-literal">false</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;Modal<br>      title=&#123;<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>商品`</span>&#125;<br>      visible=&#123;isModalVisible&#125;<br>      onCancel=&#123;<span class="hljs-function">() =&gt;</span> isShowModal(<span class="hljs-literal">false</span>)&#125;<br>      footer=&#123;<span class="hljs-literal">null</span>&#125;<br>      destroyOnClose=&#123;<span class="hljs-literal">true</span>&#125;&gt;<br>      &#123;<br>        <span class="hljs-comment">// 只有是编辑的情况下，并且要显示的数据还有返回，才显示骨架框</span><br>        initialValues === <span class="hljs-literal">undefined</span> &amp;&amp; editId !== <span class="hljs-literal">undefined</span> ? (<br>          &lt;Skeleton active=&#123;<span class="hljs-literal">true</span>&#125; paragraph=&#123;&#123; <span class="hljs-attr">rows</span>: <span class="hljs-number">4</span> &#125;&#125; /&gt;<br>        ) : (<br>          &lt;ProForm<br>            initialValues=&#123;initialValues&#125;<br>            onFinish=&#123;<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> &#123;<br>              handleSubmit(values)<br>            &#125;&#125;&gt;<br>            &lt;ProForm.Item<br>              name=<span class="hljs-string">&quot;category_id&quot;</span><br>              label=<span class="hljs-string">&quot;分类&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入分类&#x27;</span> &#125;]&#125;&gt;<br>              &lt;Cascader<br>                fieldNames=&#123;&#123; <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;id&#x27;</span> &#125;&#125;<br>                options=&#123;options&#125;<br>                placeholder=<span class="hljs-string">&quot;请输入分类&quot;</span><br>              /&gt;<br>            &lt;/ProForm.Item&gt;<br>            &lt;ProFormText<br>              name=<span class="hljs-string">&quot;title&quot;</span><br>              label=<span class="hljs-string">&quot;商品名&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品名&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品名&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormTextArea<br>              name=<span class="hljs-string">&quot;description&quot;</span><br>              label=<span class="hljs-string">&quot;描述&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品描述&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品描述&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormDigit<br>              name=<span class="hljs-string">&quot;price&quot;</span><br>              label=<span class="hljs-string">&quot;价格&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品价格&quot;</span><br>              min=&#123;<span class="hljs-number">0</span>&#125;<br>              max=&#123;<span class="hljs-number">99999999</span>&#125;<br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商商品价格&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormDigit<br>              name=<span class="hljs-string">&quot;stock&quot;</span><br>              label=<span class="hljs-string">&quot;库存&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品库存&quot;</span><br>              min=&#123;<span class="hljs-number">0</span>&#125;<br>              max=&#123;<span class="hljs-number">99999999</span>&#125;<br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品库存&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormUploadButton<br>              label=<span class="hljs-string">&quot;上传封面图&quot;</span><br>              name=<span class="hljs-string">&quot;cover&quot;</span><br>              action=<span class="hljs-string">&quot;upload.do&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请选择商品主图&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormTextArea<br>              name=<span class="hljs-string">&quot;details&quot;</span><br>              label=<span class="hljs-string">&quot;详情&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品详情&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品详情&#x27;</span> &#125;]&#125;<br>            /&gt;<br>          &lt;/ProForm&gt;<br>        )<br>      &#125;<br>    &lt;/Modal&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> CreateOrEdit<br></code></pre></div></td></tr></table></figure>

<h2 id="6-5-封装-OSS-上传"><a href="#6-5-封装-OSS-上传" class="headerlink" title="6.5 封装 OSS 上传"></a>6.5 封装 OSS 上传</h2><h3 id="6-5-1-获取阿里云-OSS-Token-接口文档"><a href="#6-5-1-获取阿里云-OSS-Token-接口文档" class="headerlink" title="6.5.1 获取阿里云 OSS Token 接口文档"></a>6.5.1 获取阿里云 OSS Token 接口文档</h3><h5 id="接口描述-14"><a href="#接口描述-14" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>获取阿里云 OSS Token，用于前端直传文件使用</li>
</ul>
<h5 id="请求-URL-14"><a href="#请求-URL-14" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/auth/oss/token</li>
</ul>
<h5 id="请求方式-14"><a href="#请求方式-14" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>GET</li>
</ul>
<h5 id="请求头部-11"><a href="#请求头部-11" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="返回参数-7"><a href="#返回参数-7" class="headerlink" title="返回参数"></a>返回参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必含</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>accessid</td>
<td>是</td>
<td>string</td>
<td>accessid</td>
</tr>
<tr>
<td>host</td>
<td>是</td>
<td>string</td>
<td>host</td>
</tr>
<tr>
<td>policy</td>
<td>是</td>
<td>string</td>
<td>policy</td>
</tr>
<tr>
<td>signature</td>
<td>是</td>
<td>string</td>
<td>signature</td>
</tr>
<tr>
<td>expire</td>
<td>是</td>
<td>int</td>
<td>expire</td>
</tr>
<tr>
<td>callback</td>
<td>是</td>
<td>string</td>
<td>callback</td>
</tr>
<tr>
<td>callback-var</td>
<td>是</td>
<td>string</td>
<td>callback-var</td>
</tr>
<tr>
<td>dir</td>
<td>是</td>
<td>string</td>
<td>dir</td>
</tr>
</tbody></table>
<h5 id="返回示例-15"><a href="#返回示例-15" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 200 请求成功</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;accessid&quot;</span>: <span class="hljs-string">&quot;C4jYcNjUFLSKHToP&quot;</span>,<br>    <span class="hljs-string">&quot;host&quot;</span>: <span class="hljs-string">&quot;http:/laravel_shop_api.luwnto.oss-cn-beijing.aliyuncs.com/&quot;</span>,<br>    <span class="hljs-string">&quot;policy&quot;</span>: <span class="hljs-string">&quot;eyJleHBpcmF0aW9uIjoiMjAyMC0xMi0yM1QwMToyMzo1OFoiLCJjb25kaXRpb25zIjpbWyJjb250ZW50LWxlbmd0aC1yYW5nZSIsMCwxMDQ4NTc2MDAwXSxbInN0YXJ0cy13aXRoIiwiJGtleSIsIiJdXX0=&quot;</span>,<br>    <span class="hljs-string">&quot;signature&quot;</span>: <span class="hljs-string">&quot;Vx3jPcUQXVQ7rKSJvYRHyYCS5pA=&quot;</span>,<br>    <span class="hljs-string">&quot;expire&quot;</span>: <span class="hljs-number">1608686638</span>,<br>    <span class="hljs-string">&quot;callback&quot;</span>: <span class="hljs-string">&quot;eyJjYWxsYmFja1VybCI6IiIsImNhbGxiYWNrQm9keSI6ImJ1Y2tldD0ke2J1Y2tldH0mZXRhZz0ke2V0YWd9JmZpbGVuYW1lPSR7b2JqZWN0fSZzaXplPSR7c2l6ZX0mbWltZVR5cGU9JHttaW1lVHlwZX0maGVpZ2h0PSR7aW1hZ2VJbmZvLmhlaWdodH0md2lkdGg9JHtpbWFnZUluZm8ud2lkdGh9JmZvcm1hdD0ke2ltYWdlSW5mby5mb3JtYXR9IiwiY2FsbGJhY2tCb2R5VHlwZSI6ImFwcGxpY2F0aW9uXC94LXd3dy1mb3JtLXVybGVuY29kZWQifQ==&quot;</span>,<br>    <span class="hljs-string">&quot;callback-var&quot;</span>: [],<br>    <span class="hljs-string">&quot;dir&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="6-5-2-添加阿里云-OSS-Token-接口"><a href="#6-5-2-添加阿里云-OSS-Token-接口" class="headerlink" title="6.5.2 添加阿里云 OSS Token 接口"></a>6.5.2 添加阿里云 OSS Token 接口</h3><p>在\src\services 文件夹中新建一个<code>commom.js</code>​</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/request&#x27;</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取oss上传策略和签名</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ossConfig</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/auth/oss/token&#x27;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="6-5-3-初步封装公共AliyunOSSUpload组件"><a href="#6-5-3-初步封装公共AliyunOSSUpload组件" class="headerlink" title="6.5.3 初步封装公共AliyunOSSUpload组件"></a>6.5.3 初步封装公共<code>AliyunOSSUpload</code>组件</h3><p>在 src\components 中新建<code>AliyunOSSUpload</code>文件夹<code>index.jsx</code>文件<br><a target="_blank" rel="noopener" href="https://ant.design/components/upload-cn/#components-upload-demo-upload-with-aliyun-oss">Upload</a>参考文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Form, Upload, message, Button &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; UploadOutlined &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/icons&#x27;</span><br><span class="hljs-keyword">import</span> &#123; ossConfig &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/commom&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AliyunOSSUpload</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>&#123;<br>  state = &#123;<br>    OSSData: &#123;&#125;,<br>  &#125;<br><br>  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">componentDidMount</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.init()<br>  &#125;<br><br>  <span class="hljs-comment">// 初始化获取oss上传签名</span><br>  init = <span class="hljs-keyword">async</span> () =&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">const</span> OSSData = <span class="hljs-keyword">await</span> ossConfig()<br><br>      <span class="hljs-built_in">this</span>.setState(&#123;<br>        OSSData,<br>      &#125;)<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>      message.error(error)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 文件上传过程中触发的回调函数，直到上传完成</span><br>  onChange = <span class="hljs-function">(<span class="hljs-params">&#123; fileList &#125;</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; onChange &#125; = <span class="hljs-built_in">this</span>.props<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Aliyun OSS:&#x27;</span>, fileList)<br>    <span class="hljs-keyword">if</span> (onChange) &#123;<br>      onChange([...fileList])<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 额外的上传参数</span><br>  getExtraData = <span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; OSSData &#125; = <span class="hljs-built_in">this</span>.state<br><br>    <span class="hljs-keyword">return</span> &#123;<br>      key: file.url,<br>      OSSAccessKeyId: OSSData.accessid, <span class="hljs-comment">// 注意查看后端返回的字段是否和官方的OSSData一致</span><br>      policy: OSSData.policy,<br>      Signature: OSSData.signature,<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 选择文件之后，上传文件之前，执行的回调</span><br>  beforeUpload = <span class="hljs-keyword">async</span> file =&gt; &#123;<br>    <span class="hljs-keyword">const</span> &#123; OSSData &#125; = <span class="hljs-built_in">this</span>.state<br>    <span class="hljs-keyword">const</span> expire = OSSData.expire * <span class="hljs-number">1000</span><br><br>    <span class="hljs-keyword">if</span> (expire &lt; <span class="hljs-built_in">Date</span>.now()) &#123;<br>      <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.init()<br>    &#125;<br><br>    <span class="hljs-keyword">const</span> suffix = file.name.slice(file.name.lastIndexOf(<span class="hljs-string">&#x27;.&#x27;</span>))<br>    <span class="hljs-keyword">const</span> filename = <span class="hljs-built_in">Date</span>.now() + suffix<br>    file.url = OSSData.dir + filename<br><br>    <span class="hljs-keyword">return</span> file<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; value &#125; = <span class="hljs-built_in">this</span>.props<br>    <span class="hljs-keyword">const</span> props = &#123;<br>      name: <span class="hljs-string">&#x27;file&#x27;</span>,<br>      fileList: value,<br>      action: <span class="hljs-built_in">this</span>.state.OSSData.host,<br>      onChange: <span class="hljs-built_in">this</span>.onChange,<br>      <span class="hljs-comment">// onRemove: this.onRemove,</span><br>      data: <span class="hljs-built_in">this</span>.getExtraData,<br>      beforeUpload: <span class="hljs-built_in">this</span>.beforeUpload,<br>      listType: <span class="hljs-string">&#x27;picture&#x27;</span>,<br>      maxCount: <span class="hljs-number">1</span>,<br>    &#125;<br>    <span class="hljs-keyword">return</span> (<br>      &lt;Upload &#123;...props&#125;&gt;<br>        &lt;Button icon=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UploadOutlined</span> /&gt;</span></span>&#125;&gt;Click to Upload&lt;/Button&gt;<br>      &lt;/Upload&gt;<br>    )<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>其中注意额外上传的参数，后端返回的字段是否和阿里云 OSS 字段一致，</p>
<h3 id="6-5-4-在新建商品模态框中使用AliyunOSSUpload组件"><a href="#6-5-4-在新建商品模态框中使用AliyunOSSUpload组件" class="headerlink" title="6.5.4 在新建商品模态框中使用AliyunOSSUpload组件"></a>6.5.4 在新建商品模态框中使用<code>AliyunOSSUpload</code>组件</h3><p>在\src\pages\Goods\components\CreateOrEdit.jsx 中，先导入<code>AliyunOSSUpload</code>，最后在上传封面图标签后添加<code>&lt;AliyunOSSUpload /&gt;</code>标签</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useEffect, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> ProForm, &#123;<br>  ProFormText,<br>  ProFormTextArea,<br>  ProFormDigit,<br>  ProFormUploadButton,<br>&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-form&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Modal, message, Skeleton, Cascader &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; showUser, updateUser, addUser &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/user&#x27;</span><br><span class="hljs-keyword">import</span> &#123; getCategory &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/category&#x27;</span><br><span class="hljs-keyword">import</span> AliyunOSSUpload <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/AliyunOSSUpload&#x27;</span><br><br><span class="hljs-keyword">const</span> CreateOrEdit = <span class="hljs-function"><span class="hljs-params">props</span> =&gt;</span> &#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * isModalVisible 模态框是否显示</span><br><span class="hljs-comment">   * isShowModal 操作模态框显示隐藏的方法</span><br><span class="hljs-comment">   * actionRef 父组件传来的表格的引用，可以用来操作表格，比如刷新表单</span><br><span class="hljs-comment">   * editId 要编辑的id，添加的时候是undefined，只有编辑时才有</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">const</span> &#123; isModalVisible, isShowModal, actionRef, editId &#125; = props<br><br>  <span class="hljs-comment">// 将表单初始化的值设置成状态，在编辑的时候使用这个状态</span><br>  <span class="hljs-keyword">const</span> [initialValues, setinitialValues] = useState(<span class="hljs-literal">undefined</span>)<br>  <span class="hljs-keyword">const</span> [options, setOptions] = useState([])<br><br>  <span class="hljs-comment">// 添加或者编辑的描述</span><br>  <span class="hljs-keyword">const</span> type = editId === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">&#x27;添加&#x27;</span> : <span class="hljs-string">&#x27;编辑&#x27;</span><br><br>  useEffect(<span class="hljs-keyword">async</span> () =&gt; &#123;<br>    <span class="hljs-comment">// 查询分类数据</span><br>    <span class="hljs-keyword">const</span> resCategory = <span class="hljs-keyword">await</span> getCategory()<br>    <span class="hljs-keyword">if</span> (resCategory.status === <span class="hljs-literal">undefined</span>) setOptions(resCategory)<br><br>    <span class="hljs-comment">// 发送请求，获取用户详情</span><br>    <span class="hljs-keyword">if</span> (editId !== <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> showUser(editId)<br>      <span class="hljs-comment">// 获取数据之后,修改状态；状态改变，组件重新渲染，骨架框消失，编辑表单出现</span><br>      setinitialValues(&#123;<br>        name: response.name,<br>        email: response.email,<br>      &#125;)<br>    &#125;<br>  &#125;, [])<br><br>  <span class="hljs-comment">// 提交表单，执行编辑或者添加</span><br>  <span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-keyword">async</span> values =&gt; &#123;<br>    <span class="hljs-keyword">let</span> response = []<br>    <span class="hljs-keyword">if</span> (editId === <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-comment">// 执行添加</span><br>      <span class="hljs-comment">// 发送请求，添加用户</span><br>      response = <span class="hljs-keyword">await</span> addUser(values)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 执行编辑</span><br>      <span class="hljs-comment">// 发送请求，更新用户</span><br>      response = <span class="hljs-keyword">await</span> updateUser(editId, values)<br>    &#125;<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>成功！`</span>)<br>      <span class="hljs-comment">// 刷新表格数据</span><br>      actionRef.current.reload()<br>      <span class="hljs-comment">// 关闭模态框</span><br>      isShowModal(<span class="hljs-literal">false</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;Modal<br>      title=&#123;<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>商品`</span>&#125;<br>      visible=&#123;isModalVisible&#125;<br>      onCancel=&#123;<span class="hljs-function">() =&gt;</span> isShowModal(<span class="hljs-literal">false</span>)&#125;<br>      footer=&#123;<span class="hljs-literal">null</span>&#125;<br>      destroyOnClose=&#123;<span class="hljs-literal">true</span>&#125;&gt;<br>      &#123;<br>        <span class="hljs-comment">// 只有是编辑的情况下，并且要显示的数据还有返回，才显示骨架框</span><br>        initialValues === <span class="hljs-literal">undefined</span> &amp;&amp; editId !== <span class="hljs-literal">undefined</span> ? (<br>          &lt;Skeleton active=&#123;<span class="hljs-literal">true</span>&#125; paragraph=&#123;&#123; <span class="hljs-attr">rows</span>: <span class="hljs-number">4</span> &#125;&#125; /&gt;<br>        ) : (<br>          &lt;ProForm<br>            initialValues=&#123;initialValues&#125;<br>            onFinish=&#123;<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> &#123;<br>              handleSubmit(values)<br>            &#125;&#125;&gt;<br>            &lt;ProForm.Item<br>              name=<span class="hljs-string">&quot;category_id&quot;</span><br>              label=<span class="hljs-string">&quot;分类&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入分类&#x27;</span> &#125;]&#125;&gt;<br>              &lt;Cascader<br>                fieldNames=&#123;&#123; <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;id&#x27;</span> &#125;&#125;<br>                options=&#123;options&#125;<br>                placeholder=<span class="hljs-string">&quot;请输入分类&quot;</span><br>              /&gt;<br>            &lt;/ProForm.Item&gt;<br>            &lt;ProFormText<br>              name=<span class="hljs-string">&quot;title&quot;</span><br>              label=<span class="hljs-string">&quot;商品名&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品名&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品名&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormTextArea<br>              name=<span class="hljs-string">&quot;description&quot;</span><br>              label=<span class="hljs-string">&quot;描述&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品描述&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品描述&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormDigit<br>              name=<span class="hljs-string">&quot;price&quot;</span><br>              label=<span class="hljs-string">&quot;价格&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品价格&quot;</span><br>              min=&#123;<span class="hljs-number">0</span>&#125;<br>              max=&#123;<span class="hljs-number">99999999</span>&#125;<br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商商品价格&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormDigit<br>              name=<span class="hljs-string">&quot;stock&quot;</span><br>              label=<span class="hljs-string">&quot;库存&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品库存&quot;</span><br>              min=&#123;<span class="hljs-number">0</span>&#125;<br>              max=&#123;<span class="hljs-number">99999999</span>&#125;<br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品库存&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormUploadButton<br>              label=<span class="hljs-string">&quot;上传封面图&quot;</span><br>              name=<span class="hljs-string">&quot;cover&quot;</span><br>              action=<span class="hljs-string">&quot;upload.do&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请选择商品主图&#x27;</span> &#125;]&#125;<br>            /&gt;<br><br>            &lt;AliyunOSSUpload /&gt;<br>            &lt;ProFormTextArea<br>              name=<span class="hljs-string">&quot;details&quot;</span><br>              label=<span class="hljs-string">&quot;详情&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品详情&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品详情&#x27;</span> &#125;]&#125;<br>            /&gt;<br>          &lt;/ProForm&gt;<br>        )<br>      &#125;<br>    &lt;/Modal&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> CreateOrEdit<br></code></pre></div></td></tr></table></figure>

<h3 id="6-5-5-简单封装优化AliyunOSSUpload组件"><a href="#6-5-5-简单封装优化AliyunOSSUpload组件" class="headerlink" title="6.5.5 简单封装优化AliyunOSSUpload组件"></a>6.5.5 简单封装优化<code>AliyunOSSUpload</code>组件</h3><h4 id="1-将原来上传图片的ProFormUploadButton组件替换成AliyunOSSUpload组件"><a href="#1-将原来上传图片的ProFormUploadButton组件替换成AliyunOSSUpload组件" class="headerlink" title="1.将原来上传图片的ProFormUploadButton组件替换成AliyunOSSUpload组件"></a>1.将原来上传图片的<code>ProFormUploadButton</code>组件替换成<code>AliyunOSSUpload</code>组件</h4><p>在\src\pages\Goods\components\CreateOrEdit.jsx 中，将原来上传图片的<code>ProFormUploadButton</code>组件替换为<code>AliyunOSSUpload</code>组件，添加验证规则并写成双标签，将在其中显示的内容写入。</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;ProForm.Item<br>  name=<span class="hljs-string">&quot;cover&quot;</span><br>  label=<span class="hljs-string">&quot;上传商品主图&quot;</span><br>  rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请选择商品主图&#x27;</span> &#125;]&#125;&gt;<br>  &lt;AliyunOSSUpload&gt;点击上传商品主图&lt;/AliyunOSSUpload&gt;<br>&lt;/ProForm.Item&gt;<br></code></pre></div></td></tr></table></figure>

<h4 id="2-修改OSSData文件上传路径，简单封装优化AliyunOSSUpload组件"><a href="#2-修改OSSData文件上传路径，简单封装优化AliyunOSSUpload组件" class="headerlink" title="2.修改OSSData文件上传路径，简单封装优化AliyunOSSUpload组件"></a>2.修改<code>OSSData</code>文件上传路径，简单封装优化<code>AliyunOSSUpload</code>组件</h4><p>在\src\components\AliyunOSSUpload\index.jsx 中</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Upload, message, Button &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; UploadOutlined &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/icons&#x27;</span><br><span class="hljs-keyword">import</span> &#123; ossConfig &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/commom&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AliyunOSSUpload</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>&#123;<br>  state = &#123;<br>    OSSData: &#123;&#125;,<br>  &#125;<br><br>  <span class="hljs-comment">// 组件挂载完成后，进行初始化，获取oss配置</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">componentDidMount</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.init()<br>  &#125;<br><br>  <span class="hljs-comment">// 初始化获取oss上传签名</span><br>  init = <span class="hljs-keyword">async</span> () =&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">const</span> OSSData = <span class="hljs-keyword">await</span> ossConfig()<br><br>      <span class="hljs-built_in">this</span>.setState(&#123;<br>        OSSData,<br>      &#125;)<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>      message.error(error)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 文件上传过程中触发的回调函数，直到上传完成</span><br>  onChange = <span class="hljs-function">(<span class="hljs-params">&#123; file &#125;</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (file.status === <span class="hljs-string">&#x27;done&#x27;</span>) message.success(<span class="hljs-string">&#x27;上传成功！&#x27;</span>)<br>  &#125;<br><br>  <span class="hljs-comment">// 额外的上传参数</span><br>  getExtraData = <span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; OSSData &#125; = <span class="hljs-built_in">this</span>.state<br><br>    <span class="hljs-keyword">return</span> &#123;<br>      key: file.key,<br>      OSSAccessKeyId: OSSData.accessid, <span class="hljs-comment">// 注意查看后端返回的字段是否和官方的OSSData一致</span><br>      policy: OSSData.policy,<br>      Signature: OSSData.signature,<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 选择文件之后，上传文件之前，执行的回调</span><br>  beforeUpload = <span class="hljs-keyword">async</span> file =&gt; &#123;<br>    <span class="hljs-keyword">const</span> &#123; OSSData &#125; = <span class="hljs-built_in">this</span>.state<br>    <span class="hljs-keyword">const</span> expire = OSSData.expire * <span class="hljs-number">1000</span><br><br>    <span class="hljs-comment">// 如果签名过期了就重新获取</span><br>    <span class="hljs-keyword">if</span> (expire &lt; <span class="hljs-built_in">Date</span>.now()) &#123;<br>      <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.init()<br>    &#125;<br><br>    <span class="hljs-keyword">const</span> dir = <span class="hljs-string">&#x27;react/&#x27;</span> <span class="hljs-comment">// 定义上传的目录</span><br><br>    <span class="hljs-keyword">const</span> suffix = file.name.slice(file.name.lastIndexOf(<span class="hljs-string">&#x27;.&#x27;</span>))<br>    <span class="hljs-keyword">const</span> filename = OSSData.dir + dir + <span class="hljs-built_in">Date</span>.now() + suffix<br>    file.key = OSSData.dir + dir + filename <span class="hljs-comment">// 在getExtraData 函数中会用到，在云存储的文件的 key</span><br>    file.url = OSSData.host + OSSData.dir + dir + filename <span class="hljs-comment">// 上传完成后，用于显示内容</span><br><br>    <span class="hljs-keyword">return</span> file<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; value &#125; = <span class="hljs-built_in">this</span>.props<br>    <span class="hljs-keyword">const</span> props = &#123;<br>      name: <span class="hljs-string">&#x27;file&#x27;</span>,<br>      fileList: value,<br>      action: <span class="hljs-built_in">this</span>.state.OSSData.host,<br>      onChange: <span class="hljs-built_in">this</span>.onChange,<br>      <span class="hljs-comment">// onRemove: this.onRemove,</span><br>      data: <span class="hljs-built_in">this</span>.getExtraData,<br>      beforeUpload: <span class="hljs-built_in">this</span>.beforeUpload,<br>      listType: <span class="hljs-string">&#x27;picture&#x27;</span>,<br>      maxCount: <span class="hljs-number">1</span>,<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> (<br>      &lt;Upload &#123;...props&#125;&gt;<br>        &#123;<span class="hljs-comment">/* 将Button标签放在在AliyunOSSUpload组件里写，这里直接使用&#123;this.props.children&#125;，会报错 */</span>&#125;<br>        &#123;<span class="hljs-comment">/* 这里的解决方案是，Button标签封装在AliyunOSSUpload组件内部，其他函数使用AliyunOSSUpload组件时，只需要将AliyunOSSUpload写成双标签，里边写显示的文字 */</span>&#125;<br>        &lt;Button icon=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UploadOutlined</span> /&gt;</span></span>&#125;&gt;&#123;<span class="hljs-built_in">this</span>.props.children&#125;&lt;/Button&gt;<br>      &lt;/Upload&gt;<br>    )<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p><strong>修复上传主图，显示默认文字 bug</strong><br>其中<code>Upload</code>内部直接写<code>&#123;this.props.children&#125;</code>获取父组件的内容，无法渲染会报错，最后只需要在父组件中将<code>AliyunOSSUpload</code>写成双标签，里边写显示的文字。将<code>Button</code>封装在<code>AliyunOSSUpload</code>组件内部，自取显示内容即可解决</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;Upload &#123;...props&#125;&gt;<br>  &#123;<span class="hljs-comment">/* 将Button标签放在在AliyunOSSUpload组件里写，这里直接使用&#123;this.props.children&#125;，会报错 */</span>&#125;<br>  &#123;<span class="hljs-comment">/* 这里的解决方案是，Button标签封装在AliyunOSSUpload组件内部，其他函数使用AliyunOSSUpload组件时，只需要将AliyunOSSUpload写成双标签，里边写显示的文字 */</span>&#125;<br>  &lt;Button icon=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UploadOutlined</span> /&gt;</span></span>&#125;&gt;&#123;<span class="hljs-built_in">this</span>.props.children&#125;&lt;/Button&gt;<br>&lt;/Upload&gt;<br></code></pre></div></td></tr></table></figure>

<p>后期富文本编辑器将<strong>显示默认文字 bug</strong>解决了，可以将<code>button</code>封装在<code>AliyunOSSUpload</code></p>
<h4 id="3-限制上传文件类型为图片"><a href="#3-限制上传文件类型为图片" class="headerlink" title="3.限制上传文件类型为图片"></a>3.限制上传文件类型为图片</h4><p>在\src\components\AliyunOSSUpload\index.jsx 中，解构<code>accept</code>，并且设置<code>accept</code>的值</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; value, accept &#125; = <span class="hljs-built_in">this</span>.props;<br>  <span class="hljs-keyword">const</span> props = &#123;<br>    accept: accept || <span class="hljs-string">&#x27;&#x27;</span>,<br>    name: <span class="hljs-string">&#x27;file&#x27;</span>,<br>    fileList: value,<br>    action: <span class="hljs-built_in">this</span>.state.OSSData.host,<br>    onChange: <span class="hljs-built_in">this</span>.onChange,<br>    <span class="hljs-comment">// onRemove: this.onRemove,</span><br>    data: <span class="hljs-built_in">this</span>.getExtraData,<br>    beforeUpload: <span class="hljs-built_in">this</span>.beforeUpload,<br>    listType: <span class="hljs-string">&#x27;picture&#x27;</span>,<br>    maxCount: <span class="hljs-number">1</span>,<br>  &#125;;<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;Upload &#123;...props&#125;&gt;<br>      &#123;<span class="hljs-comment">/* 将Button标签放在在AliyunOSSUpload组件里写，这里直接使用&#123;this.props.children&#125;，会报错 */</span>&#125;<br>      &#123;<span class="hljs-comment">/* 这里的解决方案是，Button标签封装在AliyunOSSUpload组件内部，其他函数使用AliyunOSSUpload组件时，只需要将AliyunOSSUpload写成双标签，里边写显示的文字 */</span>&#125;<br>      &lt;Button icon=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UploadOutlined</span> /&gt;</span></span>&#125;&gt;&#123;<span class="hljs-built_in">this</span>.props.children&#125;&lt;/Button&gt;<br>    &lt;/Upload&gt;<br>  );<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>在\src\pages\Goods\components\CreateOrEdit.jsx 中，<code>AliyunOSSUpload</code>标签中设置<code>accept</code>属性，<br><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file#accept">accept</a>参考文档，<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/accept">详情</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;ProForm.Item<br>  name=<span class="hljs-string">&quot;cover&quot;</span><br>  label=<span class="hljs-string">&quot;上传商品主图&quot;</span><br>  rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请选择商品主图&#x27;</span> &#125;]&#125;&gt;<br>  &lt;AliyunOSSUpload accept=<span class="hljs-string">&quot;image/*&quot;</span>&gt;点击上传商品主图&lt;/AliyunOSSUpload&gt;<br>&lt;/ProForm.Item&gt;<br></code></pre></div></td></tr></table></figure>

<p>但是其中也有一个 bug，<code>ProForm.Item</code>组件和我们封装的<code>AliyunOSSUpload</code>组件(或者第三方组件)并不关联，<code>ProForm.Item</code>当进行表单验证的时候，并没有包括<code>AliyunOSSUpload</code>。所以当文件上传成功之后，把文件的 key，设置成表单某个字段的值。</p>
<h4 id="4-关联ProForm-Item和AliyunOSSUpload，完成图片验证"><a href="#4-关联ProForm-Item和AliyunOSSUpload，完成图片验证" class="headerlink" title="4.关联ProForm.Item和AliyunOSSUpload，完成图片验证"></a>4.关联<code>ProForm.Item</code>和<code>AliyunOSSUpload</code>，完成图片验证</h4><h4 id="使用通用方式完成文件验证以及解除组件受控"><a href="#使用通用方式完成文件验证以及解除组件受控" class="headerlink" title="使用通用方式完成文件验证以及解除组件受控"></a>使用通用方式完成文件验证以及解除组件受控</h4><p>通过 <a target="_blank" rel="noopener" href="https://ant.design/components/form-cn/#components-form-demo-control-hooks">Form.useForm</a> 对表单数据域进行交互。<br>在\src\pages\Goods\components\CreateOrEdit.jsx 中，为<code>ProForm</code>标签添加<code>form=&#123;formObj&#125;</code>控制实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;ProForm<br>        form=&#123;formObj&#125;<br>        initialValues=&#123;initialValues&#125;<br>        onFinish=&#123;<span class="hljs-function">(<span class="hljs-params">values</span>) =&gt;</span> &#123;<br>          handleSubmit(values);<br>        &#125;&#125;<br>      &gt;<br></code></pre></div></td></tr></table></figure>

<p>定义<code>Form</code>实例和<code>setCoverKey</code>方法，用于当文件上传之后设置<code>cover</code>字段的<code>value</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 定义Form实例，用来操作表单</span><br><span class="hljs-keyword">const</span> [formObj] = ProForm.useForm()<br><br><span class="hljs-comment">// 文件上传成功后，设置cover字段的value</span><br><span class="hljs-keyword">const</span> setCoverKey = <span class="hljs-function"><span class="hljs-params">fileKey</span> =&gt;</span> formObj.setFieldsValue(&#123; <span class="hljs-attr">cover</span>: fileKey &#125;)<br></code></pre></div></td></tr></table></figure>

<p>在<code>AliyunOSSUpload</code>组件中传入<code>setCoverKey</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;AliyunOSSUpload setCoverKey=&#123;setCoverKey&#125; accept=<span class="hljs-string">&quot;image/*&quot;</span>&gt;<br>  点击上传商品主图<br>&lt;/AliyunOSSUpload&gt;<br></code></pre></div></td></tr></table></figure>

<p>在\src\components\AliyunOSSUpload\index.jsx 中设置上传文件的回调函数，将文件的<code>key</code>设置成文件某个字段的值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 文件上传过程中触发的回调函数，直到上传完成</span><br>onChange = <span class="hljs-function">(<span class="hljs-params">&#123; file &#125;</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (file.status === <span class="hljs-string">&#x27;done&#x27;</span>) &#123;<br>    <span class="hljs-comment">// 上传成功之后，把文件的key，设置成表单某个字段的值</span><br>    <span class="hljs-built_in">this</span>.props.setCoverKey(file.key)<br>    message.success(<span class="hljs-string">&#x27;上传成功&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>当点击上传文件时会报错<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1622121030697-e1898d39-f9a8-4f0f-9b23-5f055fe79f41.png#clientId=u1314c606-21ea-4&from=paste&height=855&id=ued8660b4&margin=%5Bobject%20Object%5D&name=image.png&originHeight=855&originWidth=1151&originalType=binary&size=76930&status=done&style=none&taskId=ube7311d5-7a2f-4889-95ac-3428b202387&width=1151" srcset="/img/loading.gif" lazyload alt="image.png"><br>原因是当我们文件上传过程中触发的回调函数时通过 <code> // 文件上传成功后，设置cover字段的value const setCoverKey = (fileKey) =&gt; formObj.setFieldsValue(&#123; cover: fileKey &#125;);</code>设置了<code>ProForm.Item</code>中<code>name=&quot;cover&quot;</code>的值，<code>ProForm.Item</code>组件和<code>AliyunOSSUpload</code>组件形成了受控组件，<code>value</code>值被设置了，但是上传过程中触发的回调函数检测到文件还没有，拿不到文件就会报错。<br>查看<a target="_blank" rel="noopener" href="https://ant.design/components/form-cn/#Form.Item">Form.Item</a>的 api 就有介绍<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1622123548883-f5da8b27-70a4-455b-b39e-ac08b831ea6e.png#clientId=u1314c606-21ea-4&from=paste&height=343&id=uc94ee111&margin=%5Bobject%20Object%5D&name=image.png&originHeight=343&originWidth=1206&originalType=binary&size=61746&status=done&style=none&taskId=u0c1c7d0a-41dc-4b6d-b04f-3d07f9e95ad&width=1206" srcset="/img/loading.gif" lazyload alt="image.png"><br><strong>解决办法</strong>：用<code>div</code>标签将<code>AliyunOSSUpload</code>组件包裹，<code>div</code>成为<code>ProForm.Item</code>的第一个子组件，他们两个形成受控组件，<code>div</code>受它控制。<code>AliyunOSSUpload</code>组件可以验证但是不受控，就解决了这个问题。</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useEffect, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> ProForm, &#123;<br>  ProFormText,<br>  ProFormTextArea,<br>  ProFormDigit,<br>  ProFormUploadButton,<br>  UploadOutlined,<br>&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-form&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Modal, message, Skeleton, Cascader, Button &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; showUser, updateUser, addUser &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/user&#x27;</span><br><span class="hljs-keyword">import</span> &#123; getCategory &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/category&#x27;</span><br><span class="hljs-keyword">import</span> AliyunOSSUpload <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/AliyunOSSUpload&#x27;</span><br><br><span class="hljs-keyword">const</span> CreateOrEdit = <span class="hljs-function"><span class="hljs-params">props</span> =&gt;</span> &#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * isModalVisible 模态框是否显示</span><br><span class="hljs-comment">   * isShowModal 操作模态框显示隐藏的方法</span><br><span class="hljs-comment">   * actionRef 父组件传来的表格的引用，可以用来操作表格，比如刷新表单</span><br><span class="hljs-comment">   * editId 要编辑的id，添加的时候是undefined，只有编辑时才有</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">const</span> &#123; isModalVisible, isShowModal, actionRef, editId &#125; = props<br><br>  <span class="hljs-comment">// 将表单初始化的值设置成状态，在编辑的时候使用这个状态</span><br>  <span class="hljs-keyword">const</span> [initialValues, setinitialValues] = useState(<span class="hljs-literal">undefined</span>)<br>  <span class="hljs-keyword">const</span> [options, setOptions] = useState([])<br><br>  <span class="hljs-comment">// 定义Form实例，用来操作表单</span><br>  <span class="hljs-keyword">const</span> [formObj] = ProForm.useForm()<br><br>  <span class="hljs-comment">// 文件上传成功后，设置cover字段的value</span><br>  <span class="hljs-keyword">const</span> setCoverKey = <span class="hljs-function"><span class="hljs-params">fileKey</span> =&gt;</span> formObj.setFieldsValue(&#123; <span class="hljs-attr">cover</span>: fileKey &#125;)<br><br>  <span class="hljs-comment">// 添加或者编辑的描述</span><br>  <span class="hljs-keyword">const</span> type = editId === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">&#x27;添加&#x27;</span> : <span class="hljs-string">&#x27;编辑&#x27;</span><br><br>  useEffect(<span class="hljs-keyword">async</span> () =&gt; &#123;<br>    <span class="hljs-comment">// 查询分类数据</span><br>    <span class="hljs-keyword">const</span> resCategory = <span class="hljs-keyword">await</span> getCategory()<br>    <span class="hljs-keyword">if</span> (resCategory.status === <span class="hljs-literal">undefined</span>) setOptions(resCategory)<br><br>    <span class="hljs-comment">// 发送请求，获取用户详情</span><br>    <span class="hljs-keyword">if</span> (editId !== <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> showUser(editId)<br>      <span class="hljs-comment">// 获取数据之后,修改状态；状态改变，组件重新渲染，骨架框消失，编辑表单出现</span><br>      setinitialValues(&#123;<br>        name: response.name,<br>        email: response.email,<br>      &#125;)<br>    &#125;<br>  &#125;, [])<br><br>  <span class="hljs-comment">// 提交表单，执行编辑或者添加</span><br>  <span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-keyword">async</span> values =&gt; &#123;<br>    <span class="hljs-keyword">let</span> response = []<br>    <span class="hljs-keyword">if</span> (editId === <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-comment">// 执行添加</span><br>      <span class="hljs-comment">// 发送请求，添加用户</span><br>      response = <span class="hljs-keyword">await</span> addUser(values)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 执行编辑</span><br>      <span class="hljs-comment">// 发送请求，更新用户</span><br>      response = <span class="hljs-keyword">await</span> updateUser(editId, values)<br>    &#125;<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>成功！`</span>)<br>      <span class="hljs-comment">// 刷新表格数据</span><br>      actionRef.current.reload()<br>      <span class="hljs-comment">// 关闭模态框</span><br>      isShowModal(<span class="hljs-literal">false</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;Modal<br>      title=&#123;<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>商品`</span>&#125;<br>      visible=&#123;isModalVisible&#125;<br>      onCancel=&#123;<span class="hljs-function">() =&gt;</span> isShowModal(<span class="hljs-literal">false</span>)&#125;<br>      footer=&#123;<span class="hljs-literal">null</span>&#125;<br>      destroyOnClose=&#123;<span class="hljs-literal">true</span>&#125;&gt;<br>      &#123;<br>        <span class="hljs-comment">// 只有是编辑的情况下，并且要显示的数据还有返回，才显示骨架框</span><br>        initialValues === <span class="hljs-literal">undefined</span> &amp;&amp; editId !== <span class="hljs-literal">undefined</span> ? (<br>          &lt;Skeleton active=&#123;<span class="hljs-literal">true</span>&#125; paragraph=&#123;&#123; <span class="hljs-attr">rows</span>: <span class="hljs-number">4</span> &#125;&#125; /&gt;<br>        ) : (<br>          &lt;ProForm<br>            form=&#123;formObj&#125;<br>            initialValues=&#123;initialValues&#125;<br>            onFinish=&#123;<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> &#123;<br>              handleSubmit(values)<br>            &#125;&#125;&gt;<br>            &lt;ProForm.Item<br>              name=<span class="hljs-string">&quot;category_id&quot;</span><br>              label=<span class="hljs-string">&quot;分类&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入分类&#x27;</span> &#125;]&#125;&gt;<br>              &lt;Cascader<br>                fieldNames=&#123;&#123; <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;id&#x27;</span> &#125;&#125;<br>                options=&#123;options&#125;<br>                placeholder=<span class="hljs-string">&quot;请输入分类&quot;</span><br>              /&gt;<br>            &lt;/ProForm.Item&gt;<br>            &lt;ProFormText<br>              name=<span class="hljs-string">&quot;title&quot;</span><br>              label=<span class="hljs-string">&quot;商品名&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品名&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品名&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormTextArea<br>              name=<span class="hljs-string">&quot;description&quot;</span><br>              label=<span class="hljs-string">&quot;描述&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品描述&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品描述&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormDigit<br>              name=<span class="hljs-string">&quot;price&quot;</span><br>              label=<span class="hljs-string">&quot;价格&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品价格&quot;</span><br>              min=&#123;<span class="hljs-number">0</span>&#125;<br>              max=&#123;<span class="hljs-number">99999999</span>&#125;<br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商商品价格&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormDigit<br>              name=<span class="hljs-string">&quot;stock&quot;</span><br>              label=<span class="hljs-string">&quot;库存&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品库存&quot;</span><br>              min=&#123;<span class="hljs-number">0</span>&#125;<br>              max=&#123;<span class="hljs-number">99999999</span>&#125;<br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品库存&#x27;</span> &#125;]&#125;<br>            /&gt;<br><br>            &lt;ProForm.Item<br>              name=<span class="hljs-string">&quot;cover&quot;</span><br>              label=<span class="hljs-string">&quot;上传商品主图&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请选择商品主图&#x27;</span> &#125;]&#125;&gt;<br>              &lt;div&gt;<br>                &lt;AliyunOSSUpload setCoverKey=&#123;setCoverKey&#125; accept=<span class="hljs-string">&quot;image/*&quot;</span>&gt;<br>                  点击上传商品主图<br>                &lt;/AliyunOSSUpload&gt;<br>              &lt;/div&gt;<br>            &lt;/ProForm.Item&gt;<br><br>            &lt;ProFormTextArea<br>              name=<span class="hljs-string">&quot;details&quot;</span><br>              label=<span class="hljs-string">&quot;详情&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品详情&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品详情&#x27;</span> &#125;]&#125;<br>            /&gt;<br>          &lt;/ProForm&gt;<br>        )<br>      &#125;<br>    &lt;/Modal&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> CreateOrEdit<br></code></pre></div></td></tr></table></figure>

<h2 id="6-6-使用富文本编辑器"><a href="#6-6-使用富文本编辑器" class="headerlink" title="6.6 使用富文本编辑器"></a>6.6 使用富文本编辑器</h2><h3 id="6-6-1-安装富文本编辑器"><a href="#6-6-1-安装富文本编辑器" class="headerlink" title="6.6.1 安装富文本编辑器"></a>6.6.1 安装富文本编辑器</h3><p>富文本编辑器文档在<a target="_blank" rel="noopener" href="https://ant.design/index-cn">antd</a>官网=&gt;组件=&gt;社区精选组件可以找到<br>​</p>
<p>我们选择的是<a target="_blank" rel="noopener" href="https://github.com/margox/braft-editor">braft-editor</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">yarn add braft-editor<br></code></pre></div></td></tr></table></figure>

<h3 id="6-6-2-封装富文本编辑器"><a href="#6-6-2-封装富文本编辑器" class="headerlink" title="6.6.2 封装富文本编辑器"></a>6.6.2 封装富文本编辑器</h3><h4 id="1-简单封装文本编辑器"><a href="#1-简单封装文本编辑器" class="headerlink" title="1.简单封装文本编辑器"></a>1.简单封装文本编辑器</h4><p>在\src\components 文件夹中，新建<code>Editor</code>文件夹，并在<code>Editor</code>下新建 i<code>ndex.jsx</code>和<code>index.less</code>文件<br>在\src\components\Editor\index.less 中设置基本样式</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">.my-component &#123;<br>  border: 1px solid #d1d1d1;<br>  border-radius: 5px;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>参考<a target="_blank" rel="noopener" href="https://www.yuque.com/braft-editor/be/lzwpnr">braft-editor</a>官方手册将<code>EditorDemo</code>拷贝，将不用的暂时注释掉，并引入样式<code>import &#39;./index.less&#39;;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-comment">// 引入编辑器组件</span><br><span class="hljs-keyword">import</span> BraftEditor <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;braft-editor&#x27;</span><br><span class="hljs-comment">// 引入编辑器样式</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;braft-editor/dist/index.css&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./index.less&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EditorDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>&#123;<br>  state = &#123;<br>    <span class="hljs-comment">// 创建一个空的editorState作为初始值</span><br>    editorState: BraftEditor.createEditorState(<span class="hljs-literal">null</span>),<br>  &#125;<br><br>  <span class="hljs-comment">// async componentDidMount() &#123;</span><br>  <span class="hljs-comment">//   // 假设此处从服务端获取html格式的编辑器内容</span><br>  <span class="hljs-comment">//   const htmlContent = await fetchEditorContent();</span><br>  <span class="hljs-comment">//   // 使用BraftEditor.createEditorState将html字符串转换为编辑器需要的editorStat</span><br>  <span class="hljs-comment">//   this.setState(&#123;</span><br>  <span class="hljs-comment">//     editorState: BraftEditor.createEditorState(htmlContent),</span><br>  <span class="hljs-comment">//   &#125;);</span><br>  <span class="hljs-comment">// &#125;</span><br><br>  <span class="hljs-comment">// submitContent = async () =&gt; &#123;</span><br>  <span class="hljs-comment">//   // 在编辑器获得焦点时按下ctrl+s会执行此方法</span><br>  <span class="hljs-comment">//   // 编辑器内容提交到服务端之前，可直接调用editorState.toHTML()来获取HTML格式的内容</span><br>  <span class="hljs-comment">//   const htmlContent = this.state.editorState.toHTML();</span><br>  <span class="hljs-comment">//   const result = await saveEditorContent(htmlContent);</span><br>  <span class="hljs-comment">// &#125;;</span><br><br>  handleEditorChange = <span class="hljs-function"><span class="hljs-params">editorState</span> =&gt;</span> &#123;<br>    <span class="hljs-built_in">this</span>.setState(&#123; editorState &#125;)<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; editorState &#125; = <span class="hljs-built_in">this</span>.state<br>    <span class="hljs-keyword">return</span> (<br>      &lt;div className=<span class="hljs-string">&quot;my-component&quot;</span>&gt;<br>        &lt;BraftEditor<br>          value=&#123;editorState&#125;<br>          onChange=&#123;<span class="hljs-built_in">this</span>.handleEditorChange&#125;<br>          <span class="hljs-comment">// onSave=&#123;this.submitContent&#125;</span><br>        /&gt;<br>      &lt;/div&gt;<br>    )<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="2-使用富文本编辑器"><a href="#2-使用富文本编辑器" class="headerlink" title="2.使用富文本编辑器"></a>2.使用富文本编辑器</h4><p>在\src\pages\Goods\components\CreateOrEdit.jsx 中引入<code>import Editor from &#39;@/components/Editor&#39;;</code><br>将原来商品详情<code>ProFormTextArea</code>组件的换成<code>ProForm.Item</code>组件并使用 <code>&lt;Editor /&gt;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;ProForm.Item<br>  name=<span class="hljs-string">&quot;details&quot;</span><br>  label=<span class="hljs-string">&quot;商品详情&quot;</span><br>  placeholder=<span class="hljs-string">&quot;请输入商品详情&quot;</span><br>  rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品详情&#x27;</span> &#125;]&#125;&gt;<br>  &lt;Editor /&gt;<br>&lt;/ProForm.Item&gt;<br></code></pre></div></td></tr></table></figure>

<h4 id="3-处理富文本编辑器表单验证"><a href="#3-处理富文本编辑器表单验证" class="headerlink" title="3.处理富文本编辑器表单验证"></a>3.处理富文本编辑器表单验证</h4><p>在\src\pages\Goods\components\CreateOrEdit.jsx 中，给<code>Editor</code>传入一个设置<code>details</code>字段的<code>value</code>的方法<br>将富文本输入的内容设置成<code>details</code>字段的<code>value</code>，并添加这个方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 文件上传成功后，设置details字段的value</span><br><span class="hljs-keyword">const</span> setDetails = <span class="hljs-function"><span class="hljs-params">content</span> =&gt;</span> formObj.setFieldsValue(&#123; <span class="hljs-attr">details</span>: content &#125;)<br></code></pre></div></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">    &lt;ProForm.Item<br>      name=<span class="hljs-string">&quot;details&quot;</span><br>      label=<span class="hljs-string">&quot;商品详情&quot;</span><br>      rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品详情&#x27;</span> &#125;]&#125;<br>    &gt;<br>      &lt;Editor setDetails=&#123;setDetails&#125; /&gt;<br>    &lt;/ProForm.Item&gt;<br>  &lt;/ProForm&gt;<br>)<br></code></pre></div></td></tr></table></figure>

<p>在\src\components\Editor\index.jsx 中，接调用 editorState.toHTML()来获取 HTML 格式的内容，调用父组件的函数，将编辑器输入的内容传递回去</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">handleEditorChange = <span class="hljs-function"><span class="hljs-params">editorState</span> =&gt;</span> &#123;<br>  <span class="hljs-comment">// 更新编辑器的状态</span><br>  <span class="hljs-built_in">this</span>.setState(&#123; editorState &#125;)<br>  <span class="hljs-comment">// 要判断输入的内容，如果有内容设置输入的内容；如果没有内容设置成空字符串</span><br>  <span class="hljs-comment">// 为什么要这样判断，因为即使是空内容editorState.toHTML()也是一对空标签，不能直接给表单使用</span><br>  <span class="hljs-keyword">if</span> (!editorState.isEmpty()) &#123;<br>    <span class="hljs-comment">// 可直接调用editorState.toHTML()来获取HTML格式的内容</span><br>    <span class="hljs-keyword">const</span> content = editorState.toHTML()<br>    <span class="hljs-comment">// 调用父组件的函数，将编辑器输入的内容传递回去</span><br>    <span class="hljs-built_in">this</span>.props.setDetails(content)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">this</span>.props.setDetails(<span class="hljs-string">&#x27;&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>其中当富文本获取到焦点时，并没有写入任何内容，但是<code>editorState.toHTML()</code>也是一对空标签<code>&lt;p&gt;&lt;/p&gt;</code>，不能直接给表单使用<br>调用<code>editorState.isEmpty()</code>会判断是否为空，没有写入任何内容会返回 true，并设置成空字符串<br>​</p>
<h3 id="6-6-3-富文本编辑器集成阿里-OSS-上传"><a href="#6-6-3-富文本编辑器集成阿里-OSS-上传" class="headerlink" title="6.6.3 富文本编辑器集成阿里 OSS 上传"></a>6.6.3 富文本编辑器集成阿里 OSS 上传</h3><h4 id="1-自定义控件–插入图片"><a href="#1-自定义控件–插入图片" class="headerlink" title="1.自定义控件–插入图片"></a>1.自定义控件–插入图片</h4><p>集成<a target="_blank" rel="noopener" href="https://braft.margox.cn/demos/antd-upload">Ant Design</a>上传组件<br>在\src\components\Editor\index.jsx 中，引入自定义控件–插入图片的例子，适当修改。<br>在<code>AliyunOSSUpload</code>组件添加<code>insertImage</code>方法，图片上传完成后执行此方法，将<code>url</code>传给父组件用来在编译器中显示图片。<code>showUploadList</code>用来控制是否展示文件列表 <a target="_blank" rel="noopener" href="https://ant.design/components/upload-cn/#API"><strong>showUploadList</strong></a><strong>文档</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;braft-editor/dist/index.css&#x27;</span><br><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-comment">// 引入编辑器组件</span><br><span class="hljs-keyword">import</span> BraftEditor <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;braft-editor&#x27;</span><br><span class="hljs-comment">// 引入编辑器样式</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;braft-editor/dist/index.css&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./index.less&#x27;</span><br><span class="hljs-keyword">import</span> AliyunOSSUpload <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/AliyunOSSUpload&#x27;</span><br><span class="hljs-keyword">import</span> &#123; ContentUtils &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;braft-utils&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EditorDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>&#123;<br>  state = &#123;<br>    <span class="hljs-comment">// 创建一个空的editorState作为初始值</span><br>    editorState: BraftEditor.createEditorState(<span class="hljs-literal">null</span>),<br>  &#125;<br><br>  <span class="hljs-comment">// async componentDidMount() &#123;</span><br>  <span class="hljs-comment">//   // 假设此处从服务端获取html格式的编辑器内容</span><br>  <span class="hljs-comment">//   const htmlContent = await fetchEditorContent();</span><br>  <span class="hljs-comment">//   // 使用BraftEditor.createEditorState将html字符串转换为编辑器需要的editorStat</span><br>  <span class="hljs-comment">//   this.setState(&#123;</span><br>  <span class="hljs-comment">//     editorState: BraftEditor.createEditorState(htmlContent),</span><br>  <span class="hljs-comment">//   &#125;);</span><br>  <span class="hljs-comment">// &#125;</span><br><br>  <span class="hljs-comment">// 编辑器内容改变的时候执行</span><br>  handleEditorChange = <span class="hljs-function"><span class="hljs-params">editorState</span> =&gt;</span> &#123;<br>    <span class="hljs-comment">// 更新编辑器的状态</span><br>    <span class="hljs-built_in">this</span>.setState(&#123; editorState &#125;)<br>    <span class="hljs-comment">// 要判断输入的内容，如果有内容设置输入的内容；如果没有内容设置成空字符串</span><br>    <span class="hljs-comment">// 为什么要这样判断，因为即使是空内容editorState.toHTML()也是一对空标签，不能直接给表单使用</span><br>    <span class="hljs-keyword">if</span> (!editorState.isEmpty()) &#123;<br>      <span class="hljs-comment">// 可直接调用editorState.toHTML()来获取HTML格式的内容</span><br>      <span class="hljs-keyword">const</span> content = editorState.toHTML()<br>      <span class="hljs-comment">// 调用父组件的函数，将编辑器输入的内容传递回去</span><br>      <span class="hljs-built_in">this</span>.props.setDetails(content)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">this</span>.props.setDetails(<span class="hljs-string">&#x27;&#x27;</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 图片上传完成后执行此方法，用来在编译器中显示图片</span><br>  insertImage = <span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> &#123;<br>    <span class="hljs-built_in">this</span>.setState(&#123;<br>      editorState: ContentUtils.insertMedias(<span class="hljs-built_in">this</span>.state.editorState, [<br>        &#123;<br>          type: <span class="hljs-string">&#x27;IMAGE&#x27;</span>,<br>          url,<br>        &#125;,<br>      ]),<br>    &#125;)<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-comment">// 自定义控件--插入图片</span><br>    <span class="hljs-keyword">const</span> extendControls = [<br>      &#123;<br>        key: <span class="hljs-string">&#x27;antd-uploader&#x27;</span>,<br>        type: <span class="hljs-string">&#x27;component&#x27;</span>,<br>        component: (<br>          &lt;AliyunOSSUpload insertImage=&#123;<span class="hljs-built_in">this</span>.insertImage&#125; accept=<span class="hljs-string">&quot;image/*&quot;</span> showUploadList=&#123;<span class="hljs-literal">false</span>&#125;&gt;<br>            &#123;<span class="hljs-comment">/* 这里的按钮最好加上type=&quot;button&quot;，以避免在表单容器中触发表单提交，用Antd的Button组件则无需如此 */</span>&#125;<br>            &lt;button<br>              type=<span class="hljs-string">&quot;button&quot;</span><br>              className=<span class="hljs-string">&quot;control-item button upload-button&quot;</span><br>              data-title=<span class="hljs-string">&quot;插入图片&quot;</span>&gt;<br>              插入图片<br>            &lt;/button&gt;<br>          &lt;/AliyunOSSUpload&gt;<br>        ),<br>      &#125;,<br>    ]<br><br>    <span class="hljs-keyword">const</span> &#123; editorState &#125; = <span class="hljs-built_in">this</span>.state<br>    <span class="hljs-keyword">return</span> (<br>      &lt;div className=<span class="hljs-string">&quot;my-component&quot;</span>&gt;<br>        &lt;BraftEditor<br>          value=&#123;editorState&#125;<br>          onChange=&#123;<span class="hljs-built_in">this</span>.handleEditorChange&#125;<br>          extendControls=&#123;extendControls&#125;<br>        /&gt;<br>      &lt;/div&gt;<br>    )<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="2-添加富文本图片显示，修复显示默认文字-bug"><a href="#2-添加富文本图片显示，修复显示默认文字-bug" class="headerlink" title="2.添加富文本图片显示，修复显示默认文字 bug"></a>2.添加富文本图片显示，修复显示默认文字 bug</h4><p>在\src\components\AliyunOSSUpload\index.jsx 中，<code>insertImage(file.url)</code>在文件上传完成之后，如果需要 url，那么返回 url 给父组件。<br>添加解构<code>showUploadList</code>，默认展示文件列表，<br>修复直接使用{this.props.children}，会报错的 bug</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Upload, message &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; ossConfig &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/commom&#x27;</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AliyunOSSUpload</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>&#123;<br>  state = &#123;<br>    OSSData: &#123;&#125;,<br>  &#125;<br><br>  <span class="hljs-comment">// 组件挂载完成后，进行初始化获取oss配置</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">componentDidMount</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.init()<br>  &#125;<br><br>  <span class="hljs-comment">// 初始化获取oss上传签名</span><br>  init = <span class="hljs-keyword">async</span> () =&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">const</span> OSSData = <span class="hljs-keyword">await</span> ossConfig()<br><br>      <span class="hljs-built_in">this</span>.setState(&#123;<br>        OSSData,<br>      &#125;)<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>      message.error(error)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 文件上传过程中触发的回调函数，直到上传完成</span><br>  onChange = <span class="hljs-function">(<span class="hljs-params">&#123; file &#125;</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (file.status === <span class="hljs-string">&#x27;done&#x27;</span>) &#123;<br>      <span class="hljs-keyword">const</span> &#123; setCoverKey, insertImage &#125; = <span class="hljs-built_in">this</span>.props<br>      <span class="hljs-keyword">if</span> (setCoverKey) &#123;<br>        <span class="hljs-comment">// 上传成功之后，把文件的key，设置成表单某个字段的值</span><br>        setCoverKey(file.key)<br>      &#125;<br><br>      <span class="hljs-comment">// 上传完成之后，如果需要url，那么返回url给父组件</span><br>      <span class="hljs-keyword">if</span> (insertImage) &#123;<br>        insertImage(file.url)<br>      &#125;<br><br>      message.success(<span class="hljs-string">&#x27;上传成功&#x27;</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 额外的上传参数</span><br>  getExtraData = <span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; OSSData &#125; = <span class="hljs-built_in">this</span>.state<br><br>    <span class="hljs-keyword">return</span> &#123;<br>      key: file.key,<br>      OSSAccessKeyId: OSSData.accessid, <span class="hljs-comment">// 注意查看后端返回的字段是否和官方的OSSData一致</span><br>      policy: OSSData.policy,<br>      Signature: OSSData.signature,<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 选择文件之后，上传文件之前，执行的回调</span><br>  beforeUpload = <span class="hljs-keyword">async</span> file =&gt; &#123;<br>    <span class="hljs-keyword">const</span> &#123; OSSData &#125; = <span class="hljs-built_in">this</span>.state<br>    <span class="hljs-keyword">const</span> expire = OSSData.expire * <span class="hljs-number">1000</span><br><br>    <span class="hljs-comment">// 如果签名过期了就重新获取</span><br>    <span class="hljs-keyword">if</span> (expire &lt; <span class="hljs-built_in">Date</span>.now()) &#123;<br>      <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.init()<br>    &#125;<br><br>    <span class="hljs-keyword">const</span> dir = <span class="hljs-string">&#x27;react/&#x27;</span> <span class="hljs-comment">// 定义上传的目录</span><br><br>    <span class="hljs-keyword">const</span> suffix = file.name.slice(file.name.lastIndexOf(<span class="hljs-string">&#x27;.&#x27;</span>))<br>    <span class="hljs-keyword">const</span> filename = OSSData.dir + dir + <span class="hljs-built_in">Date</span>.now() + suffix<br>    file.key = OSSData.dir + dir + filename <span class="hljs-comment">// 在getExtraData 函数中会用到，在云存储的文件的 key</span><br>    file.url = OSSData.host + OSSData.dir + dir + filename <span class="hljs-comment">// 上传完成后，用于显示内容</span><br><br>    <span class="hljs-keyword">return</span> file<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; value, accept, showUploadList &#125; = <span class="hljs-built_in">this</span>.props<br>    <span class="hljs-keyword">const</span> props = &#123;<br>      accept: accept || <span class="hljs-string">&#x27;&#x27;</span>,<br>      name: <span class="hljs-string">&#x27;file&#x27;</span>,<br>      fileList: value,<br>      action: <span class="hljs-built_in">this</span>.state.OSSData.host,<br>      onChange: <span class="hljs-built_in">this</span>.onChange,<br>      <span class="hljs-comment">// onRemove: this.onRemove,</span><br>      data: <span class="hljs-built_in">this</span>.getExtraData,<br>      beforeUpload: <span class="hljs-built_in">this</span>.beforeUpload,<br>      listType: <span class="hljs-string">&#x27;picture&#x27;</span>,<br>      maxCount: <span class="hljs-number">1</span>,<br>      showUploadList,<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> (<br>      &lt;Upload &#123;...props&#125;&gt;<br>        &#123;<span class="hljs-comment">/* 将Button标签放在在AliyunOSSUpload组件里写，这里直接使用&#123;this.props.children&#125;，会报错 */</span>&#125;<br>        &#123;<span class="hljs-comment">/* 这里的解决方案是，Button标签封装在AliyunOSSUpload组件内部，其他函数使用AliyunOSSUpload组件时，只需要将AliyunOSSUpload写成双标签，里边写显示的文字 */</span>&#125;<br>        &#123;<span class="hljs-comment">/* &lt;Button icon=&#123;&lt;UploadOutlined /&gt;&#125;&gt;&#123;this.props.children&#125;&lt;/Button&gt; */</span>&#125;<br>        &#123;<span class="hljs-comment">/* 修复直接使用&#123;this.props.children&#125;，会报错的bug */</span>&#125;<br>        &#123;<span class="hljs-built_in">this</span>.props.children&#125;<br>      &lt;/Upload&gt;<br>    )<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>在\src\pages\Goods\components\CreateOrEdit.jsx 中，给<code>AliyunOSSUpload</code>组件传值<code>showUploadList=&#123;true&#125;</code>显示文件图片，并将<code>Button</code>在<code>AliyunOSSUpload</code>中写</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useEffect, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> ProForm, &#123; ProFormText, ProFormTextArea, ProFormDigit &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-form&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Modal, message, Skeleton, Cascader, Button &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; UploadOutlined &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/icons&#x27;</span><br><span class="hljs-keyword">import</span> &#123; showUser, updateUser, addUser &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/user&#x27;</span><br><span class="hljs-keyword">import</span> &#123; getCategory &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/category&#x27;</span><br><span class="hljs-keyword">import</span> AliyunOSSUpload <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/AliyunOSSUpload&#x27;</span><br><span class="hljs-keyword">import</span> Editor <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/Editor&#x27;</span><br><br><span class="hljs-keyword">const</span> CreateOrEdit = <span class="hljs-function"><span class="hljs-params">props</span> =&gt;</span> &#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * isModalVisible 模态框是否显示</span><br><span class="hljs-comment">   * isShowModal 操作模态框显示隐藏的方法</span><br><span class="hljs-comment">   * actionRef 父组件传来的表格的引用，可以用来操作表格，比如刷新表单</span><br><span class="hljs-comment">   * editId 要编辑的id，添加的时候是undefined，只有编辑时才有</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">const</span> &#123; isModalVisible, isShowModal, actionRef, editId &#125; = props<br><br>  <span class="hljs-comment">// 将表单初始化的值设置成状态，在编辑的时候使用这个状态</span><br>  <span class="hljs-keyword">const</span> [initialValues, setinitialValues] = useState(<span class="hljs-literal">undefined</span>)<br>  <span class="hljs-keyword">const</span> [options, setOptions] = useState([])<br><br>  <span class="hljs-comment">// 定义Form实例，用来操作表单</span><br>  <span class="hljs-keyword">const</span> [formObj] = ProForm.useForm()<br><br>  <span class="hljs-comment">// 文件上传成功后，设置cover字段的value</span><br>  <span class="hljs-keyword">const</span> setCoverKey = <span class="hljs-function"><span class="hljs-params">fileKey</span> =&gt;</span> formObj.setFieldsValue(&#123; <span class="hljs-attr">cover</span>: fileKey &#125;)<br><br>  <span class="hljs-comment">// 文件上传成功后，设置details字段的value</span><br>  <span class="hljs-keyword">const</span> setDetails = <span class="hljs-function"><span class="hljs-params">content</span> =&gt;</span> formObj.setFieldsValue(&#123; <span class="hljs-attr">details</span>: content &#125;)<br><br>  <span class="hljs-comment">// 添加或者编辑的描述</span><br>  <span class="hljs-keyword">const</span> type = editId === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">&#x27;添加&#x27;</span> : <span class="hljs-string">&#x27;编辑&#x27;</span><br><br>  useEffect(<span class="hljs-keyword">async</span> () =&gt; &#123;<br>    <span class="hljs-comment">// 查询分类数据</span><br>    <span class="hljs-keyword">const</span> resCategory = <span class="hljs-keyword">await</span> getCategory()<br>    <span class="hljs-keyword">if</span> (resCategory.status === <span class="hljs-literal">undefined</span>) setOptions(resCategory)<br><br>    <span class="hljs-comment">// 发送请求，获取用户详情</span><br>    <span class="hljs-keyword">if</span> (editId !== <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> showUser(editId)<br>      <span class="hljs-comment">// 获取数据之后,修改状态；状态改变，组件重新渲染，骨架框消失，编辑表单出现</span><br>      setinitialValues(&#123;<br>        name: response.name,<br>        email: response.email,<br>      &#125;)<br>    &#125;<br>  &#125;, [])<br><br>  <span class="hljs-comment">// 提交表单，执行编辑或者添加</span><br>  <span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-keyword">async</span> values =&gt; &#123;<br>    <span class="hljs-keyword">let</span> response = []<br>    <span class="hljs-keyword">if</span> (editId === <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-comment">// 执行添加</span><br>      <span class="hljs-comment">// 发送请求，添加用户</span><br>      response = <span class="hljs-keyword">await</span> addUser(values)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 执行编辑</span><br>      <span class="hljs-comment">// 发送请求，更新用户</span><br>      response = <span class="hljs-keyword">await</span> updateUser(editId, values)<br>    &#125;<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>成功！`</span>)<br>      <span class="hljs-comment">// 刷新表格数据</span><br>      actionRef.current.reload()<br>      <span class="hljs-comment">// 关闭模态框</span><br>      isShowModal(<span class="hljs-literal">false</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;Modal<br>      title=&#123;<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>商品`</span>&#125;<br>      visible=&#123;isModalVisible&#125;<br>      onCancel=&#123;<span class="hljs-function">() =&gt;</span> isShowModal(<span class="hljs-literal">false</span>)&#125;<br>      footer=&#123;<span class="hljs-literal">null</span>&#125;<br>      destroyOnClose=&#123;<span class="hljs-literal">true</span>&#125;&gt;<br>      &#123;<br>        <span class="hljs-comment">// 只有是编辑的情况下，并且要显示的数据还有返回，才显示骨架框</span><br>        initialValues === <span class="hljs-literal">undefined</span> &amp;&amp; editId !== <span class="hljs-literal">undefined</span> ? (<br>          &lt;Skeleton active=&#123;<span class="hljs-literal">true</span>&#125; paragraph=&#123;&#123; <span class="hljs-attr">rows</span>: <span class="hljs-number">4</span> &#125;&#125; /&gt;<br>        ) : (<br>          &lt;ProForm<br>            form=&#123;formObj&#125;<br>            initialValues=&#123;initialValues&#125;<br>            onFinish=&#123;<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> &#123;<br>              handleSubmit(values)<br>            &#125;&#125;&gt;<br>            &lt;ProForm.Item<br>              name=<span class="hljs-string">&quot;category_id&quot;</span><br>              label=<span class="hljs-string">&quot;分类&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入分类&#x27;</span> &#125;]&#125;&gt;<br>              &lt;Cascader<br>                fieldNames=&#123;&#123; <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;id&#x27;</span> &#125;&#125;<br>                options=&#123;options&#125;<br>                placeholder=<span class="hljs-string">&quot;请输入分类&quot;</span><br>              /&gt;<br>            &lt;/ProForm.Item&gt;<br>            &lt;ProFormText<br>              name=<span class="hljs-string">&quot;title&quot;</span><br>              label=<span class="hljs-string">&quot;商品名&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品名&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品名&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormTextArea<br>              name=<span class="hljs-string">&quot;description&quot;</span><br>              label=<span class="hljs-string">&quot;描述&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品描述&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品描述&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormDigit<br>              name=<span class="hljs-string">&quot;price&quot;</span><br>              label=<span class="hljs-string">&quot;价格&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品价格&quot;</span><br>              min=&#123;<span class="hljs-number">0</span>&#125;<br>              max=&#123;<span class="hljs-number">99999999</span>&#125;<br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商商品价格&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormDigit<br>              name=<span class="hljs-string">&quot;stock&quot;</span><br>              label=<span class="hljs-string">&quot;库存&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品库存&quot;</span><br>              min=&#123;<span class="hljs-number">0</span>&#125;<br>              max=&#123;<span class="hljs-number">99999999</span>&#125;<br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品库存&#x27;</span> &#125;]&#125;<br>            /&gt;<br><br>            &lt;ProForm.Item<br>              name=<span class="hljs-string">&quot;cover&quot;</span><br>              label=<span class="hljs-string">&quot;上传商品主图&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请选择商品主图&#x27;</span> &#125;]&#125;&gt;<br>              &lt;div&gt;<br>                &lt;AliyunOSSUpload setCoverKey=&#123;setCoverKey&#125; accept=<span class="hljs-string">&quot;image/*&quot;</span> showUploadList=&#123;<span class="hljs-literal">true</span>&#125;&gt;<br>                  &lt;Button icon=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UploadOutlined</span> /&gt;</span></span>&#125;&gt;点击上传商品主图&lt;/Button&gt;<br>                &lt;/AliyunOSSUpload&gt;<br>              &lt;/div&gt;<br>            &lt;/ProForm.Item&gt;<br><br>            &lt;ProForm.Item<br>              name=<span class="hljs-string">&quot;details&quot;</span><br>              label=<span class="hljs-string">&quot;商品详情&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品详情&#x27;</span> &#125;]&#125;&gt;<br>              &lt;Editor setDetails=&#123;setDetails&#125; /&gt;<br>            &lt;/ProForm.Item&gt;<br>          &lt;/ProForm&gt;<br>        )<br>      &#125;<br>    &lt;/Modal&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> CreateOrEdit<br></code></pre></div></td></tr></table></figure>

<h2 id="6-7-添加商品"><a href="#6-7-添加商品" class="headerlink" title="6.7 添加商品"></a>6.7 添加商品</h2><h3 id="6-7-1-添加商品接口文档"><a href="#6-7-1-添加商品接口文档" class="headerlink" title="6.7.1 添加商品接口文档"></a>6.7.1 添加商品接口文档</h3><h5 id="接口描述-15"><a href="#接口描述-15" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>添加商品</li>
</ul>
<h5 id="请求-URL-15"><a href="#请求-URL-15" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/goods</li>
</ul>
<h5 id="请求方式-15"><a href="#请求方式-15" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>POST</li>
</ul>
<h5 id="请求头部-12"><a href="#请求头部-12" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="Body-请求参数-4"><a href="#Body-请求参数-4" class="headerlink" title="Body 请求参数"></a>Body 请求参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>category_id</td>
<td>是</td>
<td>int</td>
<td>分类</td>
</tr>
<tr>
<td>title</td>
<td>是</td>
<td>string</td>
<td>标题</td>
</tr>
<tr>
<td>description</td>
<td>是</td>
<td>string</td>
<td>描述</td>
</tr>
<tr>
<td>price</td>
<td>是</td>
<td>int</td>
<td>价格</td>
</tr>
<tr>
<td>stock</td>
<td>是</td>
<td>int</td>
<td>库存</td>
</tr>
<tr>
<td>cover</td>
<td>是</td>
<td>string</td>
<td>封面图</td>
</tr>
<tr>
<td>pics</td>
<td>否</td>
<td>array</td>
<td>小图集</td>
</tr>
<tr>
<td>details</td>
<td>是</td>
<td>string</td>
<td>详情</td>
</tr>
</tbody></table>
<h5 id="返回示例-16"><a href="#返回示例-16" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 201 创建成功</li>
<li>状态码 400 请求错误</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;The given data was invalid.&quot;</span>,<br>    <span class="hljs-string">&quot;errors&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;title&quot;</span>: [<br>            <span class="hljs-string">&quot;标题 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;category_id&quot;</span>: [<br>            <span class="hljs-string">&quot;category id 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;description&quot;</span>: [<br>            <span class="hljs-string">&quot;描述 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;price&quot;</span>: [<br>            <span class="hljs-string">&quot;price 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;stock&quot;</span>: [<br>            <span class="hljs-string">&quot;stock 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;cover&quot;</span>: [<br>            <span class="hljs-string">&quot;cover 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;pics&quot;</span>: [<br>            <span class="hljs-string">&quot;pics 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;details&quot;</span>: [<br>            <span class="hljs-string">&quot;details 不能为空。&quot;</span><br>        ]<br>    &#125;,<br>    <span class="hljs-string">&quot;status_code&quot;</span>: <span class="hljs-number">422</span>,<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="6-7-2-添加添加商品接口"><a href="#6-7-2-添加添加商品接口" class="headerlink" title="6.7.2 添加添加商品接口"></a>6.7.2 添加添加商品接口</h3><p>在\src\services\goods.js 中，添加商品接口和获取商品列表接口是同一个接口，但是获取商品列表是<code>get</code>请求，添加商品是<code>post</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/request&#x27;</span><br><br><span class="hljs-comment">// 获取商品列表</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getGoods</span>(<span class="hljs-params">params</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/admin/goods&#x27;</span>, &#123; params &#125;)<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 上架和下架商品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;商品id&#125;</span> <span class="hljs-variable">goodsid</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isOn</span>(<span class="hljs-params">goodsId</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.patch(<span class="hljs-string">`/admin/goods/<span class="hljs-subst">$&#123;goodsId&#125;</span>/on`</span>)<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 推荐和不推荐商品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;商品id&#125;</span> <span class="hljs-variable">goodsid</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isRecommend</span>(<span class="hljs-params">goodsId</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.patch(<span class="hljs-string">`/admin/goods/<span class="hljs-subst">$&#123;goodsId&#125;</span>/recommend`</span>)<br>&#125;<br><br><span class="hljs-comment">// 添加商品</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addGoods</span>(<span class="hljs-params">params</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.post(<span class="hljs-string">&#x27;/admin/goods&#x27;</span>, &#123; params &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>在\src\pages\Goods\components\CreateOrEdit.jsx 中，引入<code>import &#123; addGoods &#125; from &#39;@/services/goods&#39;;</code>添加商品接口<br>在提交表单时，执行添加</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 提交表单，执行编辑或者添加</span><br><span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-keyword">async</span> values =&gt; &#123;<br>  <span class="hljs-built_in">console</span>.log(values)<br>  <span class="hljs-keyword">let</span> response = []<br>  <span class="hljs-keyword">if</span> (editId === <span class="hljs-literal">undefined</span>) &#123;<br>    <span class="hljs-comment">// 执行添加</span><br>    <span class="hljs-comment">// 发送请求，添加商品</span><br>    response = <span class="hljs-keyword">await</span> addGoods(&#123; ...values, <span class="hljs-attr">category_id</span>: values.category_id[<span class="hljs-number">1</span>] &#125;)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 执行编辑</span><br>    <span class="hljs-comment">// 发送请求，更新商品</span><br>    <span class="hljs-comment">// response = await updateUser(editId, values);</span><br>  &#125;<br>  <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>    message.success(<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>成功！`</span>)<br>    <span class="hljs-comment">// 刷新表格数据</span><br>    actionRef.current.reload()<br>    <span class="hljs-comment">// 关闭模态框</span><br>    isShowModal(<span class="hljs-literal">false</span>)<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2625525/1622267547002-39018e6f-c9c3-43ab-bd26-4f99fa84e9ef.png#clientId=u07f7d054-2036-4&from=paste&height=306&id=u983b8f51&margin=%5Bobject%20Object%5D&name=image.png&originHeight=306&originWidth=672&originalType=binary&size=19356&status=done&style=none&taskId=u1ef4a3f6-2392-467e-b148-1a2ada35a53&width=672" srcset="/img/loading.gif" lazyload alt="image.png"><br>其中我们要添加<code>category_id</code>二级分类的商品在 <code>response = await addGoods(&#123; ...values, category_id: values.category_id[1] &#125;);</code>中，我们先将<code>...values</code>展开，随后再处理二级分类的商品</p>
<h2 id="6-8-修改商品"><a href="#6-8-修改商品" class="headerlink" title="6.8 修改商品"></a>6.8 修改商品</h2><h3 id="6-8-1-商品详情接口文档、修改商品接口文档"><a href="#6-8-1-商品详情接口文档、修改商品接口文档" class="headerlink" title="6.8.1 商品详情接口文档、修改商品接口文档"></a>6.8.1 商品详情接口文档、修改商品接口文档</h3><h5 id="接口描述-16"><a href="#接口描述-16" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>商品详情</li>
</ul>
<h5 id="请求-URL-16"><a href="#请求-URL-16" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/goods/{good}</li>
</ul>
<h5 id="请求方式-16"><a href="#请求方式-16" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>GET</li>
</ul>
<h5 id="请求头部-13"><a href="#请求头部-13" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="REST-参数"><a href="#REST-参数" class="headerlink" title="REST 参数"></a>REST 参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>good</td>
<td>是</td>
<td>int</td>
<td>商品 ID</td>
</tr>
</tbody></table>
<h5 id="Query-请求参数-3"><a href="#Query-请求参数-3" class="headerlink" title="Query 请求参数"></a>Query 请求参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>include</td>
<td>否</td>
<td>string</td>
<td>包含额外的数据： category 分类，user 用户， comments 评论</td>
</tr>
</tbody></table>
<p><em>inlude 可以返回额外的数据， 多个使用 ， 分隔， 比如： include=category,user,comments</em></p>
<h5 id="返回参数-8"><a href="#返回参数-8" class="headerlink" title="返回参数"></a>返回参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必含</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>user_id</td>
<td>是</td>
<td>int</td>
<td>创建者</td>
</tr>
<tr>
<td>category_id</td>
<td>是</td>
<td>int</td>
<td>分类</td>
</tr>
<tr>
<td>title</td>
<td>是</td>
<td>string</td>
<td>标题</td>
</tr>
<tr>
<td>description</td>
<td>是</td>
<td>string</td>
<td>描述</td>
</tr>
<tr>
<td>price</td>
<td>是</td>
<td>int</td>
<td>价格</td>
</tr>
<tr>
<td>stock</td>
<td>是</td>
<td>int</td>
<td>库存</td>
</tr>
<tr>
<td>sales</td>
<td>是</td>
<td>int</td>
<td>销量</td>
</tr>
<tr>
<td>cover</td>
<td>是</td>
<td>string</td>
<td>封面图</td>
</tr>
<tr>
<td>cover_url</td>
<td>是</td>
<td>string</td>
<td>封面图 url</td>
</tr>
<tr>
<td>pics</td>
<td>是</td>
<td>array</td>
<td>小图集</td>
</tr>
<tr>
<td>pics_url</td>
<td>是</td>
<td>array</td>
<td>小图集 url</td>
</tr>
<tr>
<td>is_on</td>
<td>是</td>
<td>int</td>
<td>是否上架 0 不上架 1 上架</td>
</tr>
<tr>
<td>is_recommend</td>
<td>是</td>
<td>int</td>
<td>是否推荐 0 不推荐 1 推荐</td>
</tr>
<tr>
<td>details</td>
<td>是</td>
<td>string</td>
<td>详情</td>
</tr>
<tr>
<td>category</td>
<td>否</td>
<td>object</td>
<td>额外的 分类 数据，使用 include 才会返回</td>
</tr>
<tr>
<td>user</td>
<td>否</td>
<td>object</td>
<td>额外的 用户 数据，使用 include 才会返回</td>
</tr>
<tr>
<td>comments</td>
<td>否</td>
<td>object</td>
<td>额外的 评论 数数，使用 include 才会返回</td>
</tr>
<tr>
<td>created_at</td>
<td>是</td>
<td>timestamp</td>
<td>添加时间</td>
</tr>
<tr>
<td>updated_at</td>
<td>是</td>
<td>timestamp</td>
<td>修改时间</td>
</tr>
</tbody></table>
<h5 id="返回示例-17"><a href="#返回示例-17" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 200 请求成功</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;电脑11111电脑&quot;</span>,<br>    <span class="hljs-string">&quot;category_id&quot;</span>: <span class="hljs-number">7</span>,<br>    <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;这是一个电脑1111&quot;</span>,<br>    <span class="hljs-string">&quot;price&quot;</span>: <span class="hljs-number">5000</span>,<br>    <span class="hljs-string">&quot;stock&quot;</span>: <span class="hljs-number">999</span>,<br>    <span class="hljs-string">&quot;sales&quot;</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-string">&quot;cover&quot;</span>: <span class="hljs-string">&quot;100x100.jpg&quot;</span>,<br>    <span class="hljs-string">&quot;cover_url&quot;</span>: <span class="hljs-string">&quot;https://laravel-shop-api.oss-cn-beijing.aliyuncs.com/100x100.jpg&quot;</span>,<br>    <span class="hljs-string">&quot;pics&quot;</span>: [<br>        <span class="hljs-string">&quot;a.png&quot;</span>,<br>        <span class="hljs-string">&quot;b.png&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;pics_url&quot;</span>: [<br>        <span class="hljs-string">&quot;https://laravel-shop-api.oss-cn-beijing.aliyuncs.com/a.png&quot;</span>,<br>        <span class="hljs-string">&quot;https://laravel-shop-api.oss-cn-beijing.aliyuncs.com/b.png&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;details&quot;</span>: <span class="hljs-string">&quot;这是一个电脑这是一个电脑这是一个电脑这是一个电脑&quot;</span>,<br>    <span class="hljs-string">&quot;is_on&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;is_recommend&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;created_at&quot;</span>: <span class="hljs-string">&quot;2020-12-12T07:38:37.000000Z&quot;</span>,<br>    <span class="hljs-string">&quot;updated_at&quot;</span>: <span class="hljs-string">&quot;2020-12-12T10:13:45.000000Z&quot;</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<h5 id="接口描述-17"><a href="#接口描述-17" class="headerlink" title="接口描述"></a>接口描述</h5><ul>
<li>修改商品</li>
</ul>
<h5 id="请求-URL-17"><a href="#请求-URL-17" class="headerlink" title="请求 URL"></a>请求 URL</h5><ul>
<li>/api/admin/goods/{good}</li>
</ul>
<h5 id="请求方式-17"><a href="#请求方式-17" class="headerlink" title="请求方式"></a>请求方式</h5><ul>
<li>PUT</li>
</ul>
<h5 id="请求头部-14"><a href="#请求头部-14" class="headerlink" title="请求头部"></a>请求头部</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Authorization</td>
<td>是</td>
<td>string</td>
<td>JWT token</td>
</tr>
</tbody></table>
<h5 id="RESET-参数-4"><a href="#RESET-参数-4" class="headerlink" title="RESET 参数"></a>RESET 参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>good</td>
<td>是</td>
<td>int</td>
<td>商品 id</td>
</tr>
</tbody></table>
<h5 id="Body-请求参数-5"><a href="#Body-请求参数-5" class="headerlink" title="Body 请求参数"></a>Body 请求参数</h5><table>
<thead>
<tr>
<th><strong>参数名</strong></th>
<th><strong>必选</strong></th>
<th><strong>类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>category_id</td>
<td>是</td>
<td>int</td>
<td>分类</td>
</tr>
<tr>
<td>title</td>
<td>是</td>
<td>string</td>
<td>标题</td>
</tr>
<tr>
<td>description</td>
<td>是</td>
<td>string</td>
<td>描述</td>
</tr>
<tr>
<td>price</td>
<td>是</td>
<td>int</td>
<td>价格</td>
</tr>
<tr>
<td>stock</td>
<td>是</td>
<td>int</td>
<td>库存</td>
</tr>
<tr>
<td>cover</td>
<td>是</td>
<td>string</td>
<td>封面图</td>
</tr>
<tr>
<td>pics</td>
<td>否</td>
<td>array</td>
<td>小图集</td>
</tr>
<tr>
<td>details</td>
<td>是</td>
<td>string</td>
<td>详情</td>
</tr>
</tbody></table>
<h5 id="返回示例-18"><a href="#返回示例-18" class="headerlink" title="返回示例"></a>返回示例</h5><ul>
<li>状态码 204 成功</li>
<li>状态码 400 请求错误</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;分类不存在&quot;</span>,<br>    <span class="hljs-string">&quot;status_code&quot;</span>: <span class="hljs-number">400</span>,<br>&#125;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;分类被禁用&quot;</span>,<br>    <span class="hljs-string">&quot;status_code&quot;</span>: <span class="hljs-number">400</span>,<br>&#125;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;只能向2级分类添加商品&quot;</span>,<br>    <span class="hljs-string">&quot;status_code&quot;</span>: <span class="hljs-number">400</span>,<br>&#125;<br><br></code></pre></div></td></tr></table></figure>

<ul>
<li>状态码 422 参数错误</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;The given data was invalid.&quot;</span>,<br>    <span class="hljs-string">&quot;errors&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;title&quot;</span>: [<br>            <span class="hljs-string">&quot;标题 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;category_id&quot;</span>: [<br>            <span class="hljs-string">&quot;category id 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;description&quot;</span>: [<br>            <span class="hljs-string">&quot;描述 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;price&quot;</span>: [<br>            <span class="hljs-string">&quot;price 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;stock&quot;</span>: [<br>            <span class="hljs-string">&quot;stock 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;cover&quot;</span>: [<br>            <span class="hljs-string">&quot;cover 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;pics&quot;</span>: [<br>            <span class="hljs-string">&quot;pics 不能为空。&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;details&quot;</span>: [<br>            <span class="hljs-string">&quot;details 不能为空。&quot;</span><br>        ]<br>    &#125;,<br>    <span class="hljs-string">&quot;status_code&quot;</span>: <span class="hljs-number">422</span>,<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="6-8-2-添加商品详情接口、修改商品接口"><a href="#6-8-2-添加商品详情接口、修改商品接口" class="headerlink" title="6.8.2 添加商品详情接口、修改商品接口"></a>6.8.2 添加商品详情接口、修改商品接口</h3><p>在\src\services\goods.js 中</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/request&#x27;</span><br><br><span class="hljs-comment">// 获取商品列表</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getGoods</span>(<span class="hljs-params">params</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/admin/goods&#x27;</span>, &#123; params &#125;)<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 上架和下架商品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;商品id&#125;</span> <span class="hljs-variable">goodsid</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isOn</span>(<span class="hljs-params">goodsId</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.patch(<span class="hljs-string">`/admin/goods/<span class="hljs-subst">$&#123;goodsId&#125;</span>/on`</span>)<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 推荐和不推荐商品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;商品id&#125;</span> <span class="hljs-variable">goodsid</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isRecommend</span>(<span class="hljs-params">goodsId</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.patch(<span class="hljs-string">`/admin/goods/<span class="hljs-subst">$&#123;goodsId&#125;</span>/recommend`</span>)<br>&#125;<br><br><span class="hljs-comment">// 添加商品</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addGoods</span>(<span class="hljs-params">params</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.post(<span class="hljs-string">&#x27;/admin/goods&#x27;</span>, &#123; params &#125;)<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 商品详情</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;*&#125;</span> <span class="hljs-variable">editId</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showGoods</span>(<span class="hljs-params">editId</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">`/admin/goods/<span class="hljs-subst">$&#123;editId&#125;</span>?include=category`</span>)<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 更新商品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;*&#125;</span> <span class="hljs-variable">params</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateGoods</span>(<span class="hljs-params">editId, params</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.put(<span class="hljs-string">`/admin/goods/<span class="hljs-subst">$&#123;editId&#125;</span>`</span>, &#123; params &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>其中商品详情接口，由于有二级列表所以要加上<code>?include=category</code></p>
<h3 id="6-8-3-获取商品详情数据并提交修改"><a href="#6-8-3-获取商品详情数据并提交修改" class="headerlink" title="6.8.3 获取商品详情数据并提交修改"></a>6.8.3 获取商品详情数据并提交修改</h3><p>在\src\pages\Goods\components\CreateOrEdit.jsx 中先引入<code>import &#123; addGoods, showGoods, updateGoods &#125; from &#39;@/services/goods&#39;;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> React, &#123; useEffect, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> ProForm, &#123; ProFormText, ProFormTextArea, ProFormDigit &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/pro-form&#x27;</span><br><span class="hljs-keyword">import</span> &#123; Modal, message, Skeleton, Cascader, Button, Image &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br><span class="hljs-keyword">import</span> &#123; UploadOutlined &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ant-design/icons&#x27;</span><br><span class="hljs-keyword">import</span> &#123; addGoods, showGoods, updateGoods &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/goods&#x27;</span><br><span class="hljs-keyword">import</span> &#123; getCategory &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/services/category&#x27;</span><br><span class="hljs-keyword">import</span> AliyunOSSUpload <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/AliyunOSSUpload&#x27;</span><br><span class="hljs-keyword">import</span> Editor <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/Editor&#x27;</span><br><br><span class="hljs-keyword">const</span> CreateOrEdit = <span class="hljs-function"><span class="hljs-params">props</span> =&gt;</span> &#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * isModalVisible 模态框是否显示</span><br><span class="hljs-comment">   * isShowModal 操作模态框显示隐藏的方法</span><br><span class="hljs-comment">   * actionRef 父组件传来的表格的引用，可以用来操作表格，比如刷新表单</span><br><span class="hljs-comment">   * editId 要编辑的id，添加的时候是undefined，只有编辑时才有</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">const</span> &#123; isModalVisible, isShowModal, actionRef, editId &#125; = props<br><br>  <span class="hljs-comment">// 将表单初始化的值设置成状态，在编辑的时候使用这个状态</span><br>  <span class="hljs-keyword">const</span> [initialValues, setInitialValues] = useState(<span class="hljs-literal">undefined</span>)<br>  <span class="hljs-keyword">const</span> [options, setOptions] = useState([])<br><br>  <span class="hljs-comment">// 定义Form实例，用来操作表单</span><br>  <span class="hljs-keyword">const</span> [formObj] = ProForm.useForm()<br><br>  <span class="hljs-comment">// 文件上传成功后，设置cover字段的value</span><br>  <span class="hljs-keyword">const</span> setCoverKey = <span class="hljs-function"><span class="hljs-params">fileKey</span> =&gt;</span> formObj.setFieldsValue(&#123; <span class="hljs-attr">cover</span>: fileKey &#125;)<br><br>  <span class="hljs-comment">// 文件上传成功后，设置details字段的value</span><br>  <span class="hljs-keyword">const</span> setDetails = <span class="hljs-function"><span class="hljs-params">content</span> =&gt;</span> formObj.setFieldsValue(&#123; <span class="hljs-attr">details</span>: content &#125;)<br><br>  <span class="hljs-comment">// 添加或者编辑的描述</span><br>  <span class="hljs-keyword">const</span> type = editId === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">&#x27;添加&#x27;</span> : <span class="hljs-string">&#x27;编辑&#x27;</span><br><br>  useEffect(<span class="hljs-keyword">async</span> () =&gt; &#123;<br>    <span class="hljs-comment">// 查询分类数据</span><br>    <span class="hljs-keyword">const</span> resCategory = <span class="hljs-keyword">await</span> getCategory()<br>    <span class="hljs-keyword">if</span> (resCategory.status === <span class="hljs-literal">undefined</span>) setOptions(resCategory)<br><br>    <span class="hljs-comment">// 发送请求，获取商品详情</span><br>    <span class="hljs-keyword">if</span> (editId !== <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> showGoods(editId)<br>      <span class="hljs-comment">// 获取数据之后,修改状态；状态改变，组件重新渲染，骨架框消失，编辑表单出现</span><br>      <span class="hljs-keyword">const</span> &#123; pid, id &#125; = response.category<br>      <span class="hljs-keyword">const</span> defaultCategory = pid === <span class="hljs-number">0</span> ? [id] : [pid, id]<br>      setInitialValues(&#123; ...response, <span class="hljs-attr">category_id</span>: defaultCategory &#125;)<br>    &#125;<br>  &#125;, [])<br><br>  <span class="hljs-comment">// 提交表单，执行编辑或者添加</span><br>  <span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-keyword">async</span> values =&gt; &#123;<br>    <span class="hljs-keyword">let</span> response = []<br>    <span class="hljs-keyword">if</span> (editId === <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-comment">// 执行添加</span><br>      <span class="hljs-comment">// 发送请求，添加商品</span><br>      response = <span class="hljs-keyword">await</span> addGoods(&#123; ...values, <span class="hljs-attr">category_id</span>: values.category_id[<span class="hljs-number">1</span>] &#125;)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 执行编辑</span><br>      <span class="hljs-comment">// 发送请求，更新商品</span><br>      response = <span class="hljs-keyword">await</span> updateGoods(editId, &#123; ...values, <span class="hljs-attr">category_id</span>: values.category_id[<span class="hljs-number">1</span>] &#125;)<br>    &#125;<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>成功！`</span>)<br>      <span class="hljs-comment">// 刷新表格数据</span><br>      actionRef.current.reload()<br>      <span class="hljs-comment">// 关闭模态框</span><br>      isShowModal(<span class="hljs-literal">false</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    &lt;Modal<br>      title=&#123;<span class="hljs-string">`<span class="hljs-subst">$&#123;type&#125;</span>商品`</span>&#125;<br>      visible=&#123;isModalVisible&#125;<br>      onCancel=&#123;<span class="hljs-function">() =&gt;</span> isShowModal(<span class="hljs-literal">false</span>)&#125;<br>      footer=&#123;<span class="hljs-literal">null</span>&#125;<br>      destroyOnClose=&#123;<span class="hljs-literal">true</span>&#125;&gt;<br>      &#123;<br>        <span class="hljs-comment">// 只有是编辑的情况下，并且要显示的数据还有返回，才显示骨架框</span><br>        initialValues === <span class="hljs-literal">undefined</span> &amp;&amp; editId !== <span class="hljs-literal">undefined</span> ? (<br>          &lt;Skeleton active=&#123;<span class="hljs-literal">true</span>&#125; paragraph=&#123;&#123; <span class="hljs-attr">rows</span>: <span class="hljs-number">4</span> &#125;&#125; /&gt;<br>        ) : (<br>          &lt;ProForm<br>            form=&#123;formObj&#125;<br>            initialValues=&#123;initialValues&#125;<br>            onFinish=&#123;<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> &#123;<br>              handleSubmit(values)<br>            &#125;&#125;&gt;<br>            &lt;ProForm.Item<br>              name=<span class="hljs-string">&quot;category_id&quot;</span><br>              label=<span class="hljs-string">&quot;分类&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入分类&#x27;</span> &#125;]&#125;&gt;<br>              &lt;Cascader<br>                fieldNames=&#123;&#123; <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;id&#x27;</span> &#125;&#125;<br>                options=&#123;options&#125;<br>                placeholder=<span class="hljs-string">&quot;请输入分类&quot;</span><br>              /&gt;<br>            &lt;/ProForm.Item&gt;<br>            &lt;ProFormText<br>              name=<span class="hljs-string">&quot;title&quot;</span><br>              label=<span class="hljs-string">&quot;商品名&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品名&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品名&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormTextArea<br>              name=<span class="hljs-string">&quot;description&quot;</span><br>              label=<span class="hljs-string">&quot;描述&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品描述&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品描述&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormDigit<br>              name=<span class="hljs-string">&quot;price&quot;</span><br>              label=<span class="hljs-string">&quot;价格&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品价格&quot;</span><br>              min=&#123;<span class="hljs-number">0</span>&#125;<br>              max=&#123;<span class="hljs-number">99999999</span>&#125;<br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商商品价格&#x27;</span> &#125;]&#125;<br>            /&gt;<br>            &lt;ProFormDigit<br>              name=<span class="hljs-string">&quot;stock&quot;</span><br>              label=<span class="hljs-string">&quot;库存&quot;</span><br>              placeholder=<span class="hljs-string">&quot;请输入商品库存&quot;</span><br>              min=&#123;<span class="hljs-number">0</span>&#125;<br>              max=&#123;<span class="hljs-number">99999999</span>&#125;<br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品库存&#x27;</span> &#125;]&#125;<br>            /&gt;<br><br>            &lt;ProFormText name=<span class="hljs-string">&quot;cover&quot;</span> hidden=&#123;<span class="hljs-literal">true</span>&#125; /&gt;<br>            &lt;ProForm.Item<br>              name=<span class="hljs-string">&quot;cover&quot;</span><br>              label=<span class="hljs-string">&quot;上传商品主图&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请选择商品主图&#x27;</span> &#125;]&#125;&gt;<br>              &lt;div&gt;<br>                &lt;AliyunOSSUpload setCoverKey=&#123;setCoverKey&#125; accept=<span class="hljs-string">&quot;image/*&quot;</span> showUploadList=&#123;<span class="hljs-literal">true</span>&#125;&gt;<br>                  &lt;Button icon=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UploadOutlined</span> /&gt;</span></span>&#125;&gt;点击上传商品主图&lt;/Button&gt;<br>                &lt;/AliyunOSSUpload&gt;<br>                &#123;!initialValues.cover_url ? (<br>                  <span class="hljs-string">&#x27;&#x27;</span><br>                ) : (<br>                  &lt;Image width=&#123;<span class="hljs-number">200</span>&#125; src=&#123;initialValues.cover_url&#125; /&gt;<br>                )&#125;<br>              &lt;/div&gt;<br>            &lt;/ProForm.Item&gt;<br><br>            &lt;ProForm.Item<br>              name=<span class="hljs-string">&quot;details&quot;</span><br>              label=<span class="hljs-string">&quot;商品详情&quot;</span><br>              rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品详情&#x27;</span> &#125;]&#125;&gt;<br>              &lt;Editor setDetails=&#123;setDetails&#125; content=&#123;initialValues.details&#125; /&gt;<br>            &lt;/ProForm.Item&gt;<br>          &lt;/ProForm&gt;<br>        )<br>      &#125;<br>    &lt;/Modal&gt;<br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> CreateOrEdit<br></code></pre></div></td></tr></table></figure>

<h4 id="1-获取商品列表，处理商品分类"><a href="#1-获取商品列表，处理商品分类" class="headerlink" title="1.获取商品列表，处理商品分类"></a>1.获取商品列表，处理商品分类</h4><p>在\src\pages\Goods\components\CreateOrEdit.jsx 中<br>后端字段和前端设置的字段一样能够直接赋值，所以先将数据<code>...response</code>展开。后单独设置<code>category_id: defaultCategory</code>，因为有二级菜单，后端用的数组表示，所以解构<code>response.category</code>分别将二级菜单<code>pid</code>，一级菜单<code>id</code>填入数组赋值给<code>category_id</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 发送请求，获取商品详情</span><br><span class="hljs-keyword">if</span> (editId !== <span class="hljs-literal">undefined</span>) &#123;<br>  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> showGoods(editId)<br>  <span class="hljs-comment">// 获取数据之后,修改状态；状态改变，组件重新渲染，骨架框消失，编辑表单出现</span><br>  <span class="hljs-keyword">const</span> &#123; pid, id &#125; = response.category<br>  <span class="hljs-keyword">const</span> defaultCategory = pid === <span class="hljs-number">0</span> ? [id] : [pid, id]<br>  setInitialValues(&#123; ...response, <span class="hljs-attr">category_id</span>: defaultCategory &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="2-处理图片获取"><a href="#2-处理图片获取" class="headerlink" title="2.处理图片获取"></a>2.处理图片获取</h4><p>在\src\pages\Goods\components\CreateOrEdit.jsx 中,<br>先处理图片显示，用三目运算符判断原来是否有图片，没有则为空，有则添加图片<code>&lt;Image width=&#123;200&#125; src=&#123;initialValues.cover_url&#125; /&gt;</code><br>但是我们在点击上传图片时需要上传<code>cover</code>，当我们添加新图片时<code>cover</code>会被重新设置，所以将它隐藏起来<br><code>&lt;ProFormText name=&quot;cover&quot; hidden=&#123;true&#125; /&gt;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;ProFormText name=<span class="hljs-string">&quot;cover&quot;</span> hidden=&#123;<span class="hljs-literal">true</span>&#125; /&gt;<br>&lt;ProForm.Item<br>  name=<span class="hljs-string">&quot;cover&quot;</span><br>  label=<span class="hljs-string">&quot;上传商品主图&quot;</span><br>  rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请选择商品主图&#x27;</span> &#125;]&#125;<br>&gt;<br>  &lt;div&gt;<br>    &lt;AliyunOSSUpload setCoverKey=&#123;setCoverKey&#125; accept=<span class="hljs-string">&quot;image/*&quot;</span> showUploadList=&#123;<span class="hljs-literal">true</span>&#125;&gt;<br>      &lt;Button icon=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UploadOutlined</span> /&gt;</span></span>&#125;&gt;点击上传商品主图&lt;/Button&gt;<br>    &lt;/AliyunOSSUpload&gt;<br>    &#123;!initialValues.cover_url ? (<br>      <span class="hljs-string">&#x27;&#x27;</span><br>    ) : (<br>      &lt;Image width=&#123;<span class="hljs-number">200</span>&#125; src=&#123;initialValues.cover_url&#125; /&gt;<br>    )&#125;<br>  &lt;/div&gt;<br>&lt;/ProForm.Item&gt;<br></code></pre></div></td></tr></table></figure>

<h4 id="3-处理富文本显示"><a href="#3-处理富文本显示" class="headerlink" title="3.处理富文本显示"></a>3.处理富文本显示</h4><p>在 src\pages\Goods\components\CreateOrEdit.jsx 中，在<code>Editor</code>组件设置<code>content</code>接收到原来的值</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;Editor setDetails=&#123;setDetails&#125; content=&#123;initialValues.details&#125; /&gt;<br></code></pre></div></td></tr></table></figure>

<p>在\src\components\Editor\index.jsx 中，，设置显示富文本的内容</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;braft-editor/dist/index.css&#x27;</span><br><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-comment">// 引入编辑器组件</span><br><span class="hljs-keyword">import</span> BraftEditor <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;braft-editor&#x27;</span><br><span class="hljs-comment">// 引入编辑器样式</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;braft-editor/dist/index.css&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./index.less&#x27;</span><br><span class="hljs-keyword">import</span> AliyunOSSUpload <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/AliyunOSSUpload&#x27;</span><br><span class="hljs-keyword">import</span> &#123; ContentUtils &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;braft-utils&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EditorDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>&#123;<br>  state = &#123;<br>    <span class="hljs-comment">// 创建一个空的editorState作为初始值</span><br>    editorState: BraftEditor.createEditorState(<span class="hljs-built_in">this</span>.props.content ?? <span class="hljs-literal">null</span>),<br>  &#125;<br><br>  <span class="hljs-comment">// 编辑器内容改变的时候执行</span><br>  handleEditorChange = <span class="hljs-function"><span class="hljs-params">editorState</span> =&gt;</span> &#123;<br>    <span class="hljs-comment">// 更新编辑器的状态</span><br>    <span class="hljs-built_in">this</span>.setState(&#123; editorState &#125;)<br>    <span class="hljs-comment">// 要判断输入的内容，如果有内容设置输入的内容；如果没有内容设置成空字符串</span><br>    <span class="hljs-comment">// 为什么要这样判断，因为即使是空内容editorState.toHTML()也是一对空标签，不能直接给表单使用</span><br>    <span class="hljs-keyword">if</span> (!editorState.isEmpty()) &#123;<br>      <span class="hljs-comment">// 可直接调用editorState.toHTML()来获取HTML格式的内容</span><br>      <span class="hljs-keyword">const</span> content = editorState.toHTML()<br>      <span class="hljs-comment">// 调用父组件的函数，将编辑器输入的内容传递回去</span><br>      <span class="hljs-built_in">this</span>.props.setDetails(content)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">this</span>.props.setDetails(<span class="hljs-string">&#x27;&#x27;</span>)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 图片上传完成后执行此方法，用来在编译器中显示图片</span><br>  insertImage = <span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> &#123;<br>    <span class="hljs-built_in">this</span>.setState(&#123;<br>      editorState: ContentUtils.insertMedias(<span class="hljs-built_in">this</span>.state.editorState, [<br>        &#123;<br>          type: <span class="hljs-string">&#x27;IMAGE&#x27;</span>,<br>          url,<br>        &#125;,<br>      ]),<br>    &#125;)<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-comment">// 自定义控件--插入图片</span><br>    <span class="hljs-keyword">const</span> extendControls = [<br>      &#123;<br>        key: <span class="hljs-string">&#x27;antd-uploader&#x27;</span>,<br>        type: <span class="hljs-string">&#x27;component&#x27;</span>,<br>        component: (<br>          &lt;AliyunOSSUpload insertImage=&#123;<span class="hljs-built_in">this</span>.insertImage&#125; accept=<span class="hljs-string">&quot;image/*&quot;</span> showUploadList=&#123;<span class="hljs-literal">false</span>&#125;&gt;<br>            &#123;<span class="hljs-comment">/* 这里的按钮最好加上type=&quot;button&quot;，以避免在表单容器中触发表单提交，用Antd的Button组件则无需如此 */</span>&#125;<br>            &lt;button<br>              type=<span class="hljs-string">&quot;button&quot;</span><br>              className=<span class="hljs-string">&quot;control-item button upload-button&quot;</span><br>              data-title=<span class="hljs-string">&quot;插入图片&quot;</span>&gt;<br>              插入图片<br>            &lt;/button&gt;<br>          &lt;/AliyunOSSUpload&gt;<br>        ),<br>      &#125;,<br>    ]<br><br>    <span class="hljs-keyword">const</span> &#123; editorState &#125; = <span class="hljs-built_in">this</span>.state<br>    <span class="hljs-keyword">return</span> (<br>      &lt;div className=<span class="hljs-string">&quot;my-component&quot;</span>&gt;<br>        &lt;BraftEditor<br>          value=&#123;editorState&#125;<br>          onChange=&#123;<span class="hljs-built_in">this</span>.handleEditorChange&#125;<br>          extendControls=&#123;extendControls&#125;<br>        /&gt;<br>      &lt;/div&gt;<br>    )<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>其中<code>editorState: BraftEditor.createEditorState(this.props.content ?? null),</code>是关键代码，</p>
<p><code>this.props.content ?? null</code>是三目运算符简写，如果<code>this.props.content</code>有值就传值显示在富文本上，没有就<code>null</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">state = &#123;<br>  <span class="hljs-comment">// 创建一个空的editorState作为初始值</span><br>  editorState: BraftEditor.createEditorState(<span class="hljs-built_in">this</span>.props.content ?? <span class="hljs-literal">null</span>),<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="4-提交表单更新商品"><a href="#4-提交表单更新商品" class="headerlink" title="4.提交表单更新商品"></a>4.提交表单更新商品</h4><p>在\src\pages\Goods\components\CreateOrEdit.jsx 中，添加<code>updateGoods</code>接口</p>
<figure class="highlight typescript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs typescript"><span class="hljs-comment">// 提交表单，执行编辑或者添加</span><br>  <span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-keyword">async</span> (values) =&gt; &#123;<br>    <span class="hljs-keyword">let</span> response = [];<br>    <span class="hljs-keyword">if</span> (editId === <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-comment">// 执行添加</span><br>      <span class="hljs-comment">// 发送请求，添加商品</span><br>      response = <span class="hljs-keyword">await</span> addGoods(&#123; ...values, <span class="hljs-attr">category_id</span>: values.category_id[<span class="hljs-number">1</span>] &#125;);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 执行编辑</span><br>      <span class="hljs-comment">// 发送请求，更新商品</span><br>      response = <span class="hljs-keyword">await</span> updateGoods(editId, &#123; ...values, <span class="hljs-attr">category_id</span>: values.category_id[<span class="hljs-number">1</span>] &#125;);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (response.status === <span class="hljs-literal">undefined</span>) &#123;<br>      message.success(<span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-keyword">type</span>&#125;</span>成功！`</span>);<br>      <span class="hljs-comment">// 刷新表格数据</span><br>      actionRef.current.reload();<br>      <span class="hljs-comment">// 关闭模态框</span><br>      isShowModal(<span class="hljs-literal">false</span>);<br>    &#125;<br>  &#125;;<br></code></pre></div></td></tr></table></figure>

<h1 id="七、项目总结和优化"><a href="#七、项目总结和优化" class="headerlink" title="七、项目总结和优化"></a>七、项目总结和优化</h1><h2 id="7-1-优化新建时报错"><a href="#7-1-优化新建时报错" class="headerlink" title="7.1 优化新建时报错"></a>7.1 优化新建时报错</h2><p>在\src\pages\Goods\components\CreateOrEdit.jsx 中，由于<code>initialValues</code>没有初始化，刚开始是<code>undefined</code>，所以添加一个判断</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;ProForm.Item<br>  name=<span class="hljs-string">&quot;cover&quot;</span><br>  label=<span class="hljs-string">&quot;上传商品主图&quot;</span><br>  rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请选择商品主图&#x27;</span> &#125;]&#125;<br>&gt;<br>  &lt;div&gt;<br>    &lt;AliyunOSSUpload setCoverKey=&#123;setCoverKey&#125; accept=<span class="hljs-string">&quot;image/*&quot;</span> showUploadList=&#123;<span class="hljs-literal">true</span>&#125;&gt;<br>      &lt;Button icon=&#123;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UploadOutlined</span> /&gt;</span></span>&#125;&gt;点击上传商品主图&lt;/Button&gt;<br>    &lt;/AliyunOSSUpload&gt;<br>    &#123;initialValues === <span class="hljs-literal">undefined</span> || !initialValues.cover_url ? (<br>      <span class="hljs-string">&#x27;&#x27;</span><br>    ) : (<br>      &lt;Image<br>        width=&#123;<span class="hljs-number">200</span>&#125;<br>        src=&#123;initialValues === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">&#x27;&#x27;</span> : initialValues.cover_url&#125;<br>      /&gt;<br>    )&#125;<br>  &lt;/div&gt;<br>&lt;/ProForm.Item&gt;<br><br>&lt;ProForm.Item<br>  name=<span class="hljs-string">&quot;details&quot;</span><br>  label=<span class="hljs-string">&quot;商品详情&quot;</span><br>  rules=&#123;[&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入商品详情&#x27;</span> &#125;]&#125;<br>&gt;<br>  &lt;Editor<br>    setDetails=&#123;setDetails&#125;<br>    content=&#123;initialValues === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">&#x27;&#x27;</span> : initialValues.details&#125;<br>  /&gt;<br>&lt;/ProForm.Item&gt;<br></code></pre></div></td></tr></table></figure>

<h2 id="7-2-优化刷新重定向问题"><a href="#7-2-优化刷新重定向问题" class="headerlink" title="7.2 优化刷新重定向问题"></a>7.2 优化刷新重定向问题</h2><p>在\src\models\user.js 中，先判断是请求的接口否有<code>userInfo.id</code>，有的话才将用户信息存入<code>localStorage</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 获取用户信息</span><br>*<span class="hljs-function"><span class="hljs-title">fetchCurrent</span>(<span class="hljs-params">_, &#123; call, put &#125;</span>)</span> &#123;<br>  <span class="hljs-comment">// 查看localstorage是否有用户信息，没有再去请求</span><br>  <span class="hljs-keyword">let</span> userInfo = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">localStorage</span>.getItem(<span class="hljs-string">&#x27;userInfo&#x27;</span>));<br>  <span class="hljs-keyword">if</span> (!userInfo) &#123;<br>    userInfo = <span class="hljs-keyword">yield</span> call(queryCurrent);<br><br>    <span class="hljs-comment">// 判断是否获取到用户信息，再把用户信息存入localstorage</span><br>    <span class="hljs-keyword">if</span> (userInfo.id !== <span class="hljs-literal">undefined</span>) <span class="hljs-built_in">localStorage</span>.setItem(<span class="hljs-string">&#x27;userInfo&#x27;</span>, <span class="hljs-built_in">JSON</span>.stringify(userInfo));<br><br>    <span class="hljs-comment">// 完善登录，修复BUG：有时候userInfo返回的是useCache=false被误存入localStorage，错误的userInfo导致页面一直刷新</span><br>    <span class="hljs-comment">// if (userInfo.useCache !== false) localStorage.setItem(&#x27;userInfo&#x27;, JSON.stringify(userInfo));</span><br>  &#125;<br>  <span class="hljs-keyword">yield</span> put(&#123;<br>    type: <span class="hljs-string">&#x27;saveCurrentUser&#x27;</span>,<br>    payload: userInfo,<br>  &#125;);<br>&#125;,<br></code></pre></div></td></tr></table></figure>

<h2 id="7-3-优化-401-异常处理重定向到登录页"><a href="#7-3-优化-401-异常处理重定向到登录页" class="headerlink" title="7.3 优化 401 异常处理重定向到登录页"></a>7.3 优化 401 异常处理重定向到登录页</h2><p>在\src\utils\request.js 中</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 处理401的情况</span><br><span class="hljs-keyword">if</span> (status === <span class="hljs-number">401</span>) &#123;<br>  <span class="hljs-comment">// 清空用户本地缓存的token和用户信息</span><br>  <span class="hljs-comment">// 删除本地存储的token和userInfo</span><br>  <span class="hljs-built_in">localStorage</span>.removeItem(<span class="hljs-string">&#x27;access_token&#x27;</span>)<br>  <span class="hljs-built_in">localStorage</span>.removeItem(<span class="hljs-string">&#x27;userInfo&#x27;</span>)<br><br>  <span class="hljs-comment">// 跳转到登录页</span><br>  <span class="hljs-comment">// 重定向到登录页</span><br>  history.replace(<span class="hljs-string">&#x27;/login&#x27;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="7-4-修复传参问题"><a href="#7-4-修复传参问题" class="headerlink" title="7.4 修复传参问题"></a>7.4 修复传参问题</h2><h3 id="关于-request-第二参数，常用两个传参方式"><a href="#关于-request-第二参数，常用两个传参方式" class="headerlink" title="关于 request 第二参数，常用两个传参方式"></a>关于 request 第二参数，常用两个传参方式</h3><p>1.params 传参，也就是 query 传参，多用于 get 请求，查询数据使用，类型是对象或者 URLSearchParams<br>2.data 传参，也就是 body 传参，多用于提交表单数据，类型是 any，推荐使用对象</p>
<p>在\src\services\user.js 中</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 添加用户</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;*&#125;</span> <span class="hljs-variable">params</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addUser</span>(<span class="hljs-params">data</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.post(<span class="hljs-string">&#x27;/admin/users&#x27;</span>, &#123; data &#125;)<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 更新用户</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;*&#125;</span> <span class="hljs-variable">params</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateUser</span>(<span class="hljs-params">editId, data</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.put(<span class="hljs-string">`/admin/users/<span class="hljs-subst">$&#123;editId&#125;</span>`</span>, &#123; data &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>在\src\services\login.js 中</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/request&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fakeAccountLogin</span>(<span class="hljs-params">data</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/auth/login&#x27;</span>, &#123;<br>    method: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>    data,<br>  &#125;)<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logout</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.post(<span class="hljs-string">&#x27;/auth/logout&#x27;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>在\src\services\goods.js 中</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/request&#x27;</span><br><br><span class="hljs-comment">// 获取商品列表</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getGoods</span>(<span class="hljs-params">params</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">&#x27;/admin/goods&#x27;</span>, &#123; params &#125;)<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 上架和下架商品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;商品id&#125;</span> <span class="hljs-variable">goodsid</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isOn</span>(<span class="hljs-params">goodsId</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.patch(<span class="hljs-string">`/admin/goods/<span class="hljs-subst">$&#123;goodsId&#125;</span>/on`</span>)<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 推荐和不推荐商品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;商品id&#125;</span> <span class="hljs-variable">goodsid</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isRecommend</span>(<span class="hljs-params">goodsId</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.patch(<span class="hljs-string">`/admin/goods/<span class="hljs-subst">$&#123;goodsId&#125;</span>/recommend`</span>)<br>&#125;<br><br><span class="hljs-comment">// 添加商品</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addGoods</span>(<span class="hljs-params">data</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.post(<span class="hljs-string">&#x27;/admin/goods&#x27;</span>, &#123; data &#125;)<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 商品详情</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;*&#125;</span> <span class="hljs-variable">editId</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showGoods</span>(<span class="hljs-params">editId</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request(<span class="hljs-string">`/admin/goods/<span class="hljs-subst">$&#123;editId&#125;</span>?include=category`</span>)<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 更新商品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-type">&#123;*&#125;</span> <span class="hljs-variable">params</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateGoods</span>(<span class="hljs-params">editId, data</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> request.put(<span class="hljs-string">`/admin/goods/<span class="hljs-subst">$&#123;editId&#125;</span>`</span>, &#123; data &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Antd-Pro/">Antd Pro</a>
                    
                      <a class="hover-with-bg" href="/tags/React/">React</a>
                    
                      <a class="hover-with-bg" href="/tags/Umi/">Umi</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/05/15/JSON.stringify()%E4%B8%8EJSON.parse()%E7%9A%84%E5%8C%BA%E5%88%AB/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">JSON.stringify()与JSON.parse()的区别</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/05/13/errorBoundary%E9%94%99%E8%AF%AF%E8%BE%B9%E7%95%8C/">
                        <span class="hidden-mobile">errorBoundary错误边界</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function () {
        new Valine({
          el: "#valine",
          app_id: "wvn0ubBMNgOQNv8Swlonq3X9-gzGzoHsz",
          app_key: "BlsdS19vhoVr77n1TiE2diHr",
          placeholder: "老师们，说点什么吧！",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: true,
          recordIP: true,
          serverURLs: "https://wvn0ubbm.lc-cn-n1-shared.com",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> |<i class="iconfont icon-love"></i>| <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        蜀ICP备2021012542号-1
      </a>
    </span>
    
  </div>


  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.2/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>












  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
